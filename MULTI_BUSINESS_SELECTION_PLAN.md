## Проблема: выбор бизнеса при нескольких бизнесах

### Текущая логика

- Для менеджерского/владельческого кабинета используется функция `getBizContextForManagers` (`apps/web/src/lib/authBiz.ts`).
- Алгоритм:
  - **Шаг 1. super_admin**  
    - Проверяем `is_super_admin` через RPC.  
    - Если пользователь super admin:
      - Пытаемся найти бизнес со `slug = 'kezek'`.  
      - Если не найден — берём первый попавшийся бизнес из `businesses` (`limit(1)` без сортировки).
  - **Шаг 2. Обычный пользователь (owner/admin/manager)**  
    - Загружаем `user_roles` и `roles` через service client.  
    - Фильтруем роли по ключам `owner | admin | manager`.  
    - Ищем первую роль, у которой есть `biz_id` → этот `biz_id` становится текущим бизнесом.  
    - Если подходящих ролей нет **или** у них `biz_id = null`, переходим к шагу 3.
  - **Шаг 3. Фоллбек по полю `owner_id`**  
    - Ищем бизнесы, где `businesses.owner_id = user.id`, `limit(1)` без сортировки.  
    - Если найден — его `id` используется как `bizId`.  
    - Если нет — бросаем `BizAccessError('NO_BIZ_ACCESS')`.

### Ключевые проблемы

1. **Недетерминированный выбор бизнеса**
   - В обоих местах используется `limit(1)` без явного `orderBy`.
   - При нескольких бизнесах у владельца/менеджера пользователь может “подключаться” к разным бизнесам при разных запросах/изменениях в БД.

2. **Отсутствие явного выбора бизнеса пользователем**
   - После логина пользователя просто перекидывает в `/dashboard`, без шага выбора активного бизнеса.
   - Все действия в кабинете привязаны к автоматически выбранному `bizId`, который пользователь нигде явно не выбирал и часто не видит.

3. **Риск тихих логических ошибок**
   - Пользователь думает, что управляет бизнесом A, а запросы уходят в бизнес B.
   - В логах всё выглядит корректно (права есть, бизнес существует), но бизнес-логика нарушена.

4. **Опасный дефолт для super admin**
   - Если нет `slug = 'kezek'`, супер-админ получает “первый попавшийся” бизнес.
   - Это особенно чувствительно для супер-пользователя: он может случайно менять данные неверного клиента.

5. **Сложность диагностики и поддержки**
   - Нигде не зафиксировано явно, какой именно бизнес считается “текущим” для пользователя.
   - Порядок выбора бизнеса зависит от деталей работы БД и может меняться при миграциях/индексации.

---

## Цели изменений

1. **Сделать выбор бизнеса детерминированным и прозрачным.**
2. **Дать пользователю явный контроль над тем, с каким бизнесом он сейчас работает.**
3. **Минимизировать риск действий “не в том бизнесе” для владельцев, менеджеров и super admin.**
4. **Сохранить обратно совместимое поведение там, где это возможно, но без скрытой рандомности.**

---

## Предлагаемое решение

### 1. Ввести понятие «текущий бизнес пользователя»

Хранить выбранный пользователем бизнес явно, например:

- В таблице `profiles` (поле `current_biz_id`), **или**
- В отдельной таблице `user_current_business`:
  - `user_id (uuid, PK/FK -> auth.users.id)`
  - `biz_id (uuid, FK -> businesses.id)`
  - `updated_at`

Рекомендация: **отдельная таблица** даёт больше гибкости и не привязана к структуре `profiles`.

Правила:

- Если у пользователя **один бизнес** → `current_biz_id` выставляется автоматически.
- Если у пользователя **несколько бизнесов** → после логина должен быть явный шаг выбора (см. ниже).
- Пользователь может изменить текущий бизнес в любой момент через UI (“переключатель бизнеса”).

### 2. Обновить `getBizContextForManagers`

Новый порядок определения `bizId`:

1. **Попытаться взять `current_biz_id` пользователя**:
   - Если есть запись в `user_current_business` (или поле `profiles.current_biz_id`) → пробуем использовать её.
   - Обязательно проверяем, что у пользователя есть допустимая роль (`owner|admin|manager`) для этого `bizId`.
   - Если проверки проходят → возвращаем этот `bizId`.
   - Если нет прав для этого `bizId` → либо:
     - a) бросаем понятную ошибку (например, `NO_BIZ_ACCESS_FOR_SELECTED_BUSINESS`), либо
     - b) падаем в фоллбек логику (см. следующий пункт).

2. **Фоллбек по ролям `user_roles`**:
   - Загружаем `user_roles` и `roles`, как сейчас.
   - Фильтруем по `owner|admin|manager`.
   - **Важно:** делаем выбор **детерминированным**:
     - либо по `orderBy('created_at', 'asc')` в `user_roles`,
     - либо через дополнительное правило (например, приоритет `owner` > `admin` > `manager`, а внутри — по дате создания бизнеса).

3. **Фоллбек по `owner_id`**:
   - Если по ролям ничего не выбрали, проверяем `businesses.owner_id = user.id`.
   - Обязательно добавляем **явную сортировку** (например, `orderBy('created_at', 'asc')`), чтобы поведение было стабильным.

4. **Если ничего не найдено**:
   - Бросаем `BizAccessError('NO_BIZ_ACCESS', diagnostics)` как сейчас, но с дополнительной диагностикой по `current_biz_id`.

Дополнительно:

- В `BizAccessError` добавить информацию, какой `current_biz_id` пытались использовать и почему он был отвергнут (нет прав / не существует и т.п.).

### 3. Явный выбор бизнеса в UI

#### После логина

- Если у пользователя:
  - **нет бизнесов** → как сейчас, попадаем в клиентский кабинет / staff и т.п.
  - **ровно один бизнес** → автоматически записываем `current_biz_id` и отправляем в `/dashboard`.
  - **несколько бизнесов** → редиректим не сразу в `/dashboard`, а на страницу выбора:
    - Например, `/select-business`:
      - список бизнесов с названием и, при необходимости, дополнительной мета-информацией;
      - выбор бизнеса → запрос к API, который устанавливает `current_biz_id` и редиректит в `/dashboard`.

#### Внутри кабинета

- В хедере кабинета явно показывать **текущий бизнес** (название, возможно, slug/город).
- Рядом — дропдаун/кнопка “сменить бизнес”, которая:
  - делает запрос к API для смены `current_biz_id`,
  - после успеха перезагружает страницу кабинета / relevant layout.

### 4. Поведение для super admin

- **Убрать “рандомный” дефолт** вида “любой первый бизнес”.
- Варианты:
  - (Минимальный) Сохранить приоритет `slug = 'kezek'`, но если его нет — **не выбирать бизнес автоматически**, а:
    - показывать супер-админу выбор списка бизнесов (аналог `/select-business`), либо
    - требовать явного указания `biz_id` в параметрах запроса (для определённых админских страниц).
  - (Продвинутый) Дать супер-админу такой же механизм `current_biz_id`, но дополнительно:
    - возможность временно “имперсонировать” бизнес из списка.

### 5. Логирование и диагностика

- При каждом вызове `getBizContextForManagers` логировать:
  - `userId`, `userEmail`;
  - `current_biz_id` (если есть);
  - финальный `bizId`;
  - метод выбора (`'current_biz' | 'user_roles' | 'owner_id' | 'super_admin_kezek' | 'super_admin_any'`);
  - флаги/счётчики, как уже делается сейчас.
- Это позволит быстро анализировать кейсы “попал не в тот бизнес”.

---

## Список задач

### Backend

1. **Модель данных для текущего бизнеса**
   - [x] Решить место хранения (`profiles.current_biz_id` или новая таблица `user_current_business`).
   - [x] Реализовать миграцию схемы.
   - [x] Добавить индексы по `user_id` (и, при необходимости, `biz_id`).

2. **API / RPC для работы с текущим бизнесом**
   - [x] Эндпоинт получения текущего бизнеса пользователя (например, `/api/me/current-business`).
   - [x] Эндпоинт установки текущего бизнеса:
     - валидирует, что у пользователя есть допустимая роль в этом `bizId`;
     - обновляет `current_biz_id`.

3. **Обновление `getBizContextForManagers`**
   - [x] Использовать `current_biz_id` как первый приоритет при выборе бизнеса.
   - [x] При отсутствии/некорректности `current_biz_id` — падать в детерминированный выбор по ролям:
     - добавить детерминированный выбор по `biz_id` вместо выбора "первого попавшегося".
   - [x] Обновить фоллбек по `owner_id` с явной сортировкой.
   - [x] Расширить `BizAccessError` диагностикой по `current_biz_id`.

4. **Поведение super admin**
   - [x] Убрать выбор “первого попавшегося” бизнеса без сортировки.
   - [x] Определить и реализовать новую стратегию:
     - приоритетно использовать `current_biz_id` супер-админа (таблица `user_current_business`), если он указывает на существующий бизнес;
     - если `current_biz_id` не задан и нет бизнеса со `slug = 'kezek'`, не выбирать бизнес автоматически (возврат `NO_BIZ_ACCESS`).

5. **Документация**
   - [x] Обновить `AUTH_CHECK_GUIDE.md` с учётом новой логики выбора `bizId`.
   - [x] Задокументировать использование `current_biz_id` для всех новых endpoints.

### Frontend (web)

1. **Страница выбора бизнеса после логина**
   - [x] Страница `/select-business`:
     - получает список бизнесов пользователя;
     - позволяет выбрать один бизнес и отправляет выбор в backend;
     - по успешном выборе редиректит в `/dashboard`.
   - [x] Изменить логику редиректа после авторизации:
     - если бизнесов 0 → текущее поведение;
     - если 1 → стараемся сразу выставить `current_biz_id` и перейти в `/dashboard`;
     - если >1 → перейти на `/select-business`.

2. **Переключатель бизнеса в кабинете**
   - [x] Добавить в layout кабинета отображение текущего бизнеса.
   - [x] Добавить дропдаун/меню выбора другого бизнеса:
     - при выборе → вызов API смены `current_biz_id`;
     - перезагрузка/обновление данных кабинета.

3. **Индикация в UI**
   - [x] В критичных местах (например, в заголовках страниц настроек, расписания, отчётов) явно выводить название текущего бизнеса.

### QA / миграции / поддержка

1. **Миграция существующих пользователей**
   - [x] Скрипт, который для каждого пользователя с бизнесами:
     - повторяет упрощённую текущую логику выбора (с детерминированным выбором по `biz_id`) в виде SQL CTE;
     - результат записывает в `current_biz_id` (таблица `user_current_business`) только если записи ещё нет.
   - [ ] Отдельно проверить кейсы super admin.

2. **Тест-кейсы**
   - [ ] Пользователь с 0 бизнесов.
   - [ ] Пользователь с 1 бизнесом (через `owner_id` и через `user_roles`).
   - [ ] Пользователь с несколькими бизнесами:
     - разные комбинации ролей (`owner` только в одном, `admin` в нескольких и т.п.).
   - [ ] Super admin с/без `slug = 'kezek'`.
   - [ ] Смена текущего бизнеса из UI и корректность всех API-выборок.

---

## Итог

Предложенный план убирает рандомность выбора бизнеса, делает поведение предсказуемым и видимым для пользователя, а также добавляет явный слой “текущий бизнес”, с которым пользователь в данный момент работает. Это снижает риск критических логических ошибок и упрощает поддержку и развитие функциональности для владельцев нескольких бизнесов.

