# Витрина бизнес‑аналитики и конверсионных метрик

Документ описывает дорожную карту и детализированные задачи для реализации витрины бизнес‑аналитики в админ‑dashboard Kezek.

Цель: дать владельцам и менеджерам **понятную картину здоровья бизнеса**, от конверсии воронки (home → карточка бизнеса → бронирование) до загрузки по часам/дням, эффективности промо и связи рейтинга с ценой/загрузкой.

---

**Статусы задач:** `[ ]` — todo | `[x]` — done

## 1. Область фичи и роли

**Роли:**

- Владельцы / админы бизнеса (`owner`, `admin`).
- Менеджеры (`manager`) с доступом к филиалам.

**Цели для пользователя:**

- Видеть ответ на вопросы:
  - «Сколько трафика доходит от главной до реальных записей?»
  - «Когда у меня пик/провал загрузки по дням и часам?»
  - «Какие акции реально работают и дают деньги, а какие только “съедают” скидку?»
  - «Как рейтинг и цены связаны с загрузкой?»
- Принимать решения: включать/выключать промо, менять цены, перераспределять расписание и персонал.

---

## 2. Высокоуровневый скоуп (MVP и расширения)

**MVP‑диапазон (первый релиз):**

- Конверсионная воронка:
  - просмотры главной / списка бизнесов,
  - просмотры карточки бизнеса (`/b/[slug]`),
  - старты потока бронирования (`/b/[slug]/booking`),
  - успешные бронирования (записи со статусом `confirmed`/`paid`).
- Загрузка по дням и часам:
  - агрегированное количество записей по бизнесу/филиалу,
  - базовый heatmap (дни недели × часы).
- Базовая аналитика промо:
  - количество бронирований с промо,
  - выручка с промо vs без промо (по бизнесу/филиалу).

**Расширения (после MVP):**

- Глубокие связи `rating_score` ↔ цена ↔ загрузка.
- Разрез по услугам/категориям.
- Подробная эффективность каждого конкретного промо (`branch_promotions`).
- Экспорт отчётов (CSV/Excel).

---

## 3. Эпик А — Формализация метрик и требований к данным

### A1. Метрики воронки (home → бизнес → booking → запись)

**Задача A1.1 — Словарь событий воронки (финальные определения)** — **[x] done**

Этот раздел фиксирует **строгие определения** событий воронки, обязательные поля и бизнес‑значение. Все клиенты трекинга (web, mobile, backend) должны использовать эти имена и семантику при записи в `analytics_events`.

#### A1.1.1 `home_view`

- **Описание:** событие показа главной страницы/списка бизнесов.
- **Когда логируем:**
  - при первом показе `/` за сессию (web);
  - при первом показе стартового экрана со списком бизнесов в мобильном приложении.
- **Обязательные поля:**
  - `source` — `web` или `mobile`;
  - `session_id` — идентификатор сессии (cookie/LocalStorage/аналог на мобиле);
  - `locale` — текущий язык интерфейса (`ru`, `ky`, `en` и т.п.).
- **Опциональные поля (в `metadata`):**
  - `referrer` — источник перехода (если есть);
  - `utm_*` — маркетинговые метки (если будут добавлены позже);
  - `is_authenticated` — флаг авторизованного пользователя.
- **Бизнес‑значение:**
  - базовый “верх” воронки для расчёта, какой процент трафика доходит до карточек бизнеса и до бронирований;
  - точка отсчёта для сравнения каналов (web vs mobile, платный трафик vs органика — в будущем).

#### A1.1.2 `business_page_view`

- **Описание:** событие просмотра страницы конкретного бизнеса.
- **Когда логируем:**
  - при первом заходе на `/b/[slug]` данного бизнеса за сессию (web);
  - при первом открытии экрана бизнеса в мобильном приложении за сессию.
- **Обязательные поля:**
  - `biz_id` — идентификатор бизнеса;
  - `source` — `web` или `mobile`;
  - `session_id`;
  - `locale`.
- **Опциональные поля (в `metadata`):**
  - `from_home` — флаг, пришёл ли пользователь с главной (`true/false`);
  - `branch_id` — если на странице сразу выбран конкретный филиал;
  - `path` — фактический путь (`/b/[slug]` или вложенные варианты).
- **Бизнес‑значение:**
  - промежуточное звено воронки: насколько эффективно главная/поиск приводит к просмотрам конкретных бизнесов;
  - даёт понимание, какие бизнесы/категории получают больше всего внимания.

#### A1.1.3 `booking_flow_start`

- **Описание:** событие начала потока бронирования для конкретного бизнеса.
- **Когда логируем:**
  - при первом попадании пользователя в `/b/[slug]/booking` за сессию (web);
  - при первом переходе на экран бронирования в мобиле для данного бизнеса.
- **Обязательные поля:**
  - `biz_id`;
  - `source`;
  - `session_id`;
  - `locale`.
- **Опциональные поля (в `metadata`):**
  - `branch_id` — если заранее выбран филиал;
  - `entry_point` — откуда начат флоу (`from_business_page`, `deep_link`, `promo_banner` и т.п.).
- **Бизнес‑значение:**
  - нижний уровень “интереса”: сколько пользователей реально пытаются записаться;
  - сравнение с `business_page_view` показывает, где теряется интерес (UX/ценник/рейтинг).

#### A1.1.4 `booking_flow_step`

- **Описание:** событие движения по шагам внутри потока бронирования.
- **Когда логируем:**
  - при каждом завершённом шаге выбора (филиал, дата, мастер, услуга, слот и т.п.).
- **Обязательные поля:**
  - `biz_id`;
  - `source`;
  - `session_id`;
  - `locale`;
  - в `metadata.step` — один из: `"branch"`, `"date"`, `"staff"`, `"service"`, `"slot"` (в будущем список шагов можно расширять).
- **Опциональные поля (в `metadata`):**
  - `branch_id` — когда выбран филиал или шаг относится к конкретному филиалу;
  - `staff_id`, `service_id` — если шаг связан с мастером/услугой;
  - доп. контекст (например, количество доступных слотов на шаге).
- **Бизнес‑значение:**
  - позволяет увидеть, на каком именно шаге бронирования пользователи чаще всего “отваливаются”;
  - даёт сигналы для UX‑улучшений (упростить выбор филиала, мастера, слота и т.д.).

#### A1.1.5 `booking_created`

- **Описание:** событие фактического создания записи в таблице `bookings` (любой статус).
- **Когда логируем:**
  - при успешном создании записи (любой из путей — авторизованный клиент, гость, staff‑панель), сразу после вставки в `bookings`;
  - логирует backend (RPC/HTTP‑API), а не фронт.
- **Обязательные поля:**
  - `biz_id`;
  - `branch_id`;
  - `booking_id`;
  - `source` — `web`, `mobile`, `staff_dashboard` и т.п. (по возможности);
  - при наличии клиента — `client_id`.
- **Опциональные поля (в `metadata`):**
  - `created_by_role` — `client`, `staff`, `manager`;
  - `initial_status` — стартовый статус (`hold`, `confirmed` и т.п.);
  - `is_guest` — флаг гостевого бронирования.
- **Бизнес‑значение:**
  - нижний уровень конверсии, связывающий фронтовый флоу с реальным фактом записи в систему;
  - даёт возможность отличать “почти дошёл до слота” от “реально создал запись”.

#### A1.1.6 `booking_confirmed_or_paid`

- **Описание:** событие успешного перехода бронирования в статус `confirmed` или `paid`.
- **Когда логируем:**
  - при любом backend‑изменении статуса записи, где `new_status` ∈ {`confirmed`, `paid`};
  - может вызываться как при онлайновом подтверждении/оплате, так и при операциях staff/cron’ов.
- **Обязательные поля:**
  - `biz_id`;
  - `branch_id`;
  - `booking_id`;
  - `source` — по возможности, откуда инициировано изменение (`web`, `mobile`, `staff_dashboard`, `cron`);
  - `status` — конечный статус (`confirmed` или `paid`).
- **Опциональные поля (в `metadata`):**
  - `previous_status` — предыдущее значение статуса;
  - `changed_by_role` — `client`, `staff`, `system`;
  - информация о промо/выручке (ссылка на `promotion_applied`, `final_amount` и т.п. — можно связать через `booking_id`).
- **Бизнес‑значение:**
  - фиксирует факт “успешного” бронирования, по которому можно считать финальную конверсию;
  - различение `confirmed` vs `paid` позволяет в будущем строить отдельные воронки “от записи до фактического визита/оплаты”.

#### A1.1.7 Обязательные поля и общие правила

- **Обязательные поля для всех событий воронки (где применимо):**
  - `source` — канал (`web`, `mobile`, `staff_dashboard`, `system` и т.п.);
  - `session_id` — строка, устойчивая в рамках сессии пользователя;
  - `locale`;
  - `biz_id` — везде, где событие привязано к конкретному бизнесу;
  - `branch_id` — везде, где действие имеет привязку к филиалу;
  - `client_id` — если пользователь авторизован и клиент известен.
- **Общие правила:**
  - предпочтительно логировать **одно событие на важное действие** (без дублирования при рендерах/рефокусах);
  - backend‑события (по `bookings`) считаются источником истины для факта записи/подтверждения;
  - клиентские события (`home_view`, `business_page_view`, `booking_flow_*`) используются для анализа конверсии и UX.

---

### A2. Метрики загрузки и расписания

**Задача A2.1 — Финальное определение “загрузки” (MVP)** — **[x] done**

Для первого релиза берём максимально простую и однозначную модель, опираясь на уже существующую доменную семантику статусов бронирований.

#### A2.1.1 Что именно считаем “загрузкой”

- **Базовое определение (MVP):**
  - загрузка = **количество бронирований из таблицы `bookings`**, удовлетворяющих условиям:
    - статус ∈ {`confirmed`, `paid`};
    - есть валидные временные поля (`start_time`/эквивалентные);
    - бронирование относится к конкретному `biz_id` (и при необходимости `branch_id`, `staff_id`).
- **Почему только `confirmed`/`paid`:**
  - `hold` = “ещё не зафиксировано”, может не состояться → не учитываем в загрузке, чтобы не завышать;
  - `cancelled`, `no_show` = не состоявшиеся визиты → не считаются фактической загрузкой.

#### A2.1.2 Как агрегируем по времени и сущностям

- Для каждого бронирования, попадающего под определение выше, определяем:
  - **дату** визита в таймзоне бизнеса (по `start_time`/эквиваленту) → `date`;
  - **час** визита (0–23) в таймзоне бизнеса → `hour`;
  - **филиал** → `branch_id`;
  - **сотрудника** (если применимо) → `staff_id`.
- На уровне агрегатов (например, `business_hourly_load` в B2.2):
  - считаем:
    - `bookings_count` = количество таких записей для комбинации (`biz_id`, `branch_id`, `date`, `hour`);
    - опционально — разрезы по `staff_id` (через отдельные запросы/агрегаты).

#### A2.1.3 Что считаем “слотом” и длительностью

- Для MVP **не учитываем длительность услуги** в расчётах загрузки:
  - **1 бронирование = 1 единица загрузки** в том часу, где начинается визит;
  - если бронирование длится 2+ часа, всё равно считаем его как одну единицу загрузки (без распределения по часам).
- Причины:
  - упрощает реализацию первых дашбордов;
  - даёт понятную картину “количества клиентов в час”, даже без процента заполнения слотов.
- В будущем (A2.2) можно ввести понятие slots/units:
  - переводить длительность услуг в слот‑юниты и считать проценты заполнения по каждому часу/дню.

**Задача A2.2 — Решение по учёту длительности (MVP vs V2)** — **[x] done**

#### A2.2.1 Выбор для MVP

- Для **MVP** фиксируем:  
  - **используем только количество бронирований**, без нормализации по длительности услуг;
  - оставляем определение из A2.1 как единственный источник правды: **1 бронирование = 1 единица загрузки в час начала визита**.

Причины выбора:

- упрощает реализацию первых агрегатов и UI;
- даёт владельцам интуитивно понятную метрику “сколько клиентов у меня в час/день”;
- не мешает в будущем ввести более точный слой поверх уже существующих данных.

#### A2.2.2 Направление развития (после MVP)

- В **V2** планируется ввести понятие **слот‑юнитов**:
  - каждая услуга имеет длительность (например, 30/60/90 минут);
  - расписание мастера/филиала задаёт доступные слоты;
  - бронирование занимает определённое количество юнитов (например, 2 юнита по 30 минут);
  - загрузка по часу/дню выражается как **процент занятых слотов**.
- Для этого потребуется:
  - согласовать “базовый шаг слота” (например, 15 или 30 минут);
  - доопределить, как хранится длительность услуги и шаги расписания на уровне домена;
  - расширить агрегаты (см. B2.2) дополнительными полями (например, `slot_units_total`, `slot_units_used`, `load_percent`).  

Это развитие **не входит в MVP**, но текущая модель (подсчёт бронирований) должна проектироваться так, чтобы поверх неё можно было добавить слой slot‑юнитов без ломающей миграции.

---

### A3. Метрики промо и выручки

**Задача A3.1 — Финальное определение KPI промо (MVP)** — **[x] done**

В этом разделе фиксируем, как именно считаются базовые KPI по промо‑акциям на уровне бронирований и агрегатов.

#### A3.1.1 Базовые определения на уровне одного бронирования

Опираемся на модель из `SYSTEM_FEATURES_DOCUMENTATION.md` (раздел 3.5):

- В таблице `bookings` есть поле `promotion_applied jsonb`, содержащее (как минимум):
  - `promotion_type`,
  - `promotion_title`,
  - `discount_percent?`,
  - `final_amount` — финальная сумма после применения акции,
  - опционально `base_amount` — сумма без учёта промо (если не хранится, её можно восстановить из связанной финансовой логики).

Для одного бронирования определяем:

- `has_promotion`:
  - **true**, если `promotion_applied` не `NULL` и в нём есть `promotion_type`;
  - иначе **false**.
- `booking_base_amount`:
  - если в `promotion_applied` есть `base_amount` → используем его;
  - иначе:
    - берём сумму услуги/услуг из связанной финансовой логики (те же значения, которые попадают в выручку смен/финансовый модуль);
    - конкретный источник будет зафиксирован в реализации агрегатов (важно, чтобы он был единообразен).
- `booking_final_amount`:
  - если `has_promotion = true` и в `promotion_applied` есть `final_amount` → используем его;
  - если промо нет → `booking_final_amount = booking_base_amount`.
- `booking_discount_amount`:
  - если `has_promotion = true` → `max(0, booking_base_amount - booking_final_amount)`;
  - иначе → `0`.

#### A3.1.2 KPI на уровне агрегатов (по бизнесу/филиалу/периоду)

Для заданного диапазона дат и скоупа (бизнес, филиал и т.п.) считаем:

- `promo_bookings_count`:
  - количество бронирований, у которых `has_promotion = true` **и** бронирование считается успешным для аналитики (статус ∈ {`confirmed`, `paid`} — то же правило, что и для загрузки).
- `promo_revenue`:
  - сумма `booking_final_amount` по всем бронированиям с `has_promotion = true` и статусами ∈ {`confirmed`, `paid`};
  - отражает фактическую выручку, полученную по записям с промо, **после** применения скидок.
- `promo_discount_given`:
  - сумма `booking_discount_amount` по всем бронированиям с `has_promotion = true` и статусами ∈ {`confirmed`, `paid`};
  - показывает, сколько денег было “отдано” клиентам в виде скидок.
- `promo_share_of_revenue` (вторичный KPI, опционально для MVP):
  - отношение `promo_revenue` к общей выручке за период (включая записи без промо);
  - помогает оценить, какую долю оборота генерируют акции.

#### A3.1.3 Uplift‑метрики (после MVP)

Для первого релиза **uplift не считаем автоматически**, но закладываем направление:

- `uplift_in_conversion`:
  - относительное изменение конверсии “просмотр бизнеса → успешное бронирование” между периодами/сегментами с активными промо и без них.
- `uplift_in_load`:
  - относительное изменение загрузки (см. A2.1) при включении/выключении промо.

Расчёт uplift требует аккуратного сравнения сопоставимых периодов и/или A/B‑разбиений, поэтому будет запроектирован отдельно после появления первых отчётов по базовым KPI (`promo_bookings_count`, `promo_revenue`, `promo_discount_given`). 

**Задача A3.2 — Связь KPI промо с доменной моделью (`SYSTEM_FEATURES_DOCUMENTATION.md`)** — **[x] done**

#### A3.2.1 Источники данных для промо

Основные сущности из текущей промо‑модели:

- `branch_promotions` — определение акций по филиалам:
  - ключевые поля: `id`, `branch_id`, `promotion_type`, `title_ru`, `params`, `is_active`.
- `bookings.promotion_applied` (jsonb) — результат применения акции к конкретному бронированию:
  - как минимум: `promotion_type`, `promotion_title`, `discount_percent?`, `final_amount`, опционально `base_amount`.
- `client_promotion_usage` — история использования промо клиентами (счётчики).
- `client_referrals` — связи приглашённый ↔ пригласивший (для реферальных промо).

#### A3.2.2 Агрегация по типам промо

Для аналитики в разрезе типов промо и конкретных акций:

- Базовый уровень (MVP):
  - Используем **только данные из `bookings.promotion_applied`**, без отдельного join к `branch_promotions`:
    - берём `promotion_type` и (по возможности) `promotion_title` из `promotion_applied`;
    - считаем KPI из A3.1 (`promo_bookings_count`, `promo_revenue`, `promo_discount_given`) **по каждому `promotion_type`**;
    - при наличии `promotion_title` можно дополнительно группировать по “человекочитаемому” названию.
- Расширенный уровень (после MVP):
  - Добавляем join к `branch_promotions` по связке:
    - `bookings.promotion_applied.promotion_type` + `branch_id` (и, при необходимости, `promotion_id`, если будет добавлено явное поле);
  - Это позволит:
    - видеть эффективность **конкретной записи** в `branch_promotions` (например, “7‑й визит бесплатно” в конкретном филиале);
    - фильтровать по параметрам из `params` (размер скидки, N в “каждая N‑я услуга бесплатно” и т.п.).

Особые типы из `SYSTEM_FEATURES_DOCUMENTATION.md`:

- `free_after_n_visits` — в агрегатах важно:
  - учитывать, что `final_amount` может быть 0 (полностью бесплатный визит);
  - видеть вклад таких визитов в `promo_bookings_count` и `promo_discount_given` (вся сумма уходит в скидку).
- `referral_free` / `referral_discount_50`:
  - KPI считаются по тем же формулам A3.1;
  - при необходимости в будущем можно использовать `client_referrals` для построения отдельной аналитики по рефералам (количество активных рефералов, LTV приглашённых и т.п.).
- `birthday_discount`, `first_visit_discount`:
  - на уровне KPI не требуют отдельной схемы — учитываются как обычные промо с процентной скидкой.

#### A3.2.3 Минимально необходимые поля для аналитики

Чтобы не тянуть лишние зависимости в MVP, считаем минимально достаточными:

- В `bookings.promotion_applied`:
  - **обязательно**: `promotion_type`, `promotion_title?`, `final_amount`;
  - **желательно**: `base_amount` (если его нет — восстановить из финансовой модели при агрегации);
  - **опционально**: `discount_percent` (может упростить отображение, но не обязателен для расчёта сумм).
- В `branch_promotions`:
  - текущих полей достаточно; в агрегатах MVP можно использовать только `promotion_type` и `title_ru` при необходимости.
- В `client_promotion_usage` и `client_referrals`:
  - на уровне MVP **не используем напрямую** для визуализаций, но оставляем как источник для возможных V2‑отчётов (например, “сколько N‑х визитов довели до бесплатной услуги”, “сколько рефералов привёл клиент”).

Таким образом, **все ключевые промо‑KPI из A3.1 могут быть рассчитаны только по `bookings` и `promotion_applied`**, а связи с `branch_promotions`/`client_*` используются как расширение для более продвинутой аналитики после MVP.

---

## 4. Эпик B — Модель данных и хранилище событий

### B1. Схема таблицы «сырых событий» (frontend + backend)

**Задача B1.1 — Спроектировать таблицу `analytics_events`** — **[x] done**

- Поля (предварительно):
  - `id uuid PK`,
  - `created_at timestamptz`,
  - `event_type text` (`home_view`, `business_page_view`, `booking_flow_start`, `booking_flow_step`, `booking_created`, `booking_confirmed_or_paid` и т.п.),
  - `biz_id uuid NULL`,
  - `branch_id uuid NULL`,
  - `booking_id uuid NULL`,
  - `client_id uuid NULL`,
  - `source text` (`web`, `mobile`),
  - `session_id text`,
  - `metadata jsonb` (доп. данные: шаг флоу, язык, источник трафика, A/B‑флаги).
- Задачи:
  - подготовить SQL‑миграцию для создания таблицы,
  - описать индексы (минимум по `biz_id`, `branch_id`, `event_type`, `created_at`).

**Задача B1.2 — Определить минимально достаточный срок хранения сырых событий**

- Согласовать с `DATA_RETENTION.md`:
  - сколько месяцев храним детальные события (например, 6–12 месяцев),
  - когда агрегации будут заменять сырые данные для старых периодов.

---

### B2. Схемы агрегатов для быстрых дашбордов

**Задача B2.1 — Спроектировать таблицу `business_daily_stats`** — **[x] done**

- Поля (пример):
  - `biz_id uuid`,
  - `date date`,
  - `home_views int`,
  - `business_page_views int`,
  - `booking_flow_starts int`,
  - `bookings_created int`,
  - `bookings_confirmed_or_paid int`,
  - `promo_bookings int`,
  - `promo_revenue numeric`,
  - `total_revenue numeric`,
  - `created_at`, `updated_at`.
- Ключ:
  - PK (`biz_id`, `date`).

**Задача B2.2 — Спроектировать таблицу `business_hourly_load`** — **[x] done**

- Поля (пример):
  - `biz_id uuid`,
  - `branch_id uuid`,
  - `date date`,
  - `hour int` (0–23, в TZ бизнеса),
  - `bookings_count int`,
  - `promo_bookings_count int`,
  - опционально `staff_count` / `unique_clients_count`.
- Ключ:
  - PK (`biz_id`, `branch_id`, `date`, `hour`).

**Задача B2.3 — Продумать, нужны ли отдельные таблицы для промо и рейтинга** — **[x] done**

#### B2.3.1 Решение для MVP

- **Отдельные агрегатные таблицы под промо и рейтинги в MVP не вводим.**
- Для промо‑KPI (см. A3) достаточно:
  - `business_daily_stats` (поля `promo_bookings`, `promo_revenue`, `total_revenue`);
  - исходных таблиц `bookings` + `promotion_applied` (для более детального drill‑down при необходимости);
  - при необходимости — join к существующим рейтинг‑агрегатам (`biz_day_metrics`, `branch_day_metrics`, `staff_day_metrics`) без новых структур.

#### B2.3.2 Направление для V2

- Возможное развитие (не входит в MVP):
  - ввести отдельную таблицу `promotion_daily_stats` на основе `branch_promotions` и `promotion_applied`,
  - рассматривать отдельные агрегаты для рейтингов только если потребуется тяжёлая отчётность, не укладывающаяся в существующие `*_day_metrics`.

---

## 5. Эпик C — Трекинг событий во фронте и бэкенде

### C1. Веб‑приложение (`apps/web`)

**Задача C1.1 — Добавить клиентский трекинг на главную и карточку бизнеса** — **[x] done**

- Добавить утиль `trackEvent` (если уже есть — расширить):
  - единая функция отправки событий на API `/api/admin/analytics/track` или обёртка над Supabase RPC.
- На главной (`/`):
  - логировать `home_view` при первом показе страницы.
- На странице бизнеса `/b/[slug]`:
  - логировать `business_page_view` при первом заходе в сессию.
- Гарантировать:
  - не спамим событий при каждом ререндере (использовать `useEffect` + guard по `sessionStorage`/куке).

**Задача C1.2 — Трекинг старта и шагов потока бронирования** — **[x] done**

- На `/b/[slug]/booking`:
  - при первом открытии — `booking_flow_start`.
  - на ключевых действиях:
    - выбор филиала → `booking_flow_step` с `step: "branch"`,
    - выбор даты → `booking_flow_step` с `step: "date"`,
    - выбор мастера → `booking_flow_step` с `step: "staff"`,
    - выбор услуги → `booking_flow_step` с `step: "service"`,
    - выбор слота → `booking_flow_step` с `step: "slot"`.
- Параметры:
  - всегда передавать `biz_id`/`branch_id` (если известны), `source: "web"`, `session_id`.

---

### C2. Мобильное приложение (`apps/mobile`)

**Задача C2.1 — Симметричный трекинг для `HomeScreen` и экранов бронирования** — **[x] done**

- Реализовать утиль для отправки событий на тот же API (`/api/admin/analytics/track`) или через Supabase:
  - `source: "mobile"`.
- События:
  - `home_view` при открытии `HomeScreen`,
  - `business_page_view` при переходе на экран бизнеса,
  - `booking_flow_start` и `booking_flow_step` по аналогии с вебом.

---

### C3. Backend‑события по бронированиям

**Задача C3.1 — Логировать доменные события изменения статуса бронирований** — **[x] done**

- В API/SQL‑функциях, меняющих статусы `bookings` (в т.ч. `update_booking_status_with_promotion`, `hold_slot`, `confirm_booking`):
  - при создании записи → событие `booking_created`,
  - при переходе в `confirmed`/`paid` → событие `booking_confirmed_or_paid`.
- Сохранять в `analytics_events`:
  - `booking_id`, `biz_id`, `branch_id`, `client_id`, `source` (если можно определить), реальное время.

---

## 6. Эпик D — Агрегации и фоновые джобы

### D1. Cron / worker для дневной статистики

**Задача D1.1 — Реализовать cron‑маршрут `POST /api/cron/analytics/daily`** — **[x] done**

- Поведение:
  - за каждый день `D` в заданном диапазоне:
    - собрать события из `analytics_events`,
    - собрать данные по бронированиям и промо (`bookings`, `promotion_applied`),
    - записать/обновить строки в `business_daily_stats`.
- Оптимизации:
  - инкрементальный режим:
    - по умолчанию → пересчитывать вчера/сегодня,
    - по запросу админа → пересчитать произвольный диапазон дат.

**Задача D1.2 — Добавить cron‑задание в Vercel/cron‑инфраструктуру** — **[x] done**

- Запуск `analytics/daily`:
  - раз в час или раз в день (на MVP хватает 1 раза в день).
- Обновить `CRON_SETUP.md`/`CRON`‑доки с описанием нового джоба.

---

### D2. Cron / worker для часовой загрузки

**Задача D2.1 — Реализовать cron‑маршрут `POST /api/cron/analytics/hourly-load`** — **[x] done**

- Поведение:
  - для выбранного дня/периода:
    - пройтись по `bookings` (или отдельным slot‑таблицам, если появятся),
    - агрегировать количество записей по `biz_id`, `branch_id`, `date`, `hour`,
    - сохранять в `business_hourly_load`.
- Продумать:
  - учёт таймзоны бизнеса (выполнить преобразование в бизнес‑TZ, а не в UTC),
  - обновление часового распределения при изменении/отмене брони (можно пересчитывать окно последних N часов/дней).

---

## 7. Эпик E — API для админ‑dashboard

### E1. Контракты API

**Задача E1.1 — Специфицировать и задокументировать API для аналитики** — **[x] done**

- Эндпоинты (черновой вариант):
  - `GET /api/admin/analytics/overview`
    - вход: диапазон дат, `biz_id`, список `branch_id?`,
    - ответ: основные KPI по бизнесу (конверсия воронки, суммарная выручка, вклад промо).
  - `GET /api/admin/analytics/conversion-funnel`
    - вход: диапазон дат, `biz_id`,
    - ответ: массив шагов воронки с абсолютными значениями и конверсией.
  - `GET /api/admin/analytics/load`
    - вход: диапазон дат, `biz_id`, `branch_id?`,
    - ответ: данные для heatmap (день недели × час).
  - `GET /api/admin/analytics/promotions`
    - вход: диапазон дат, `biz_id`, `branch_id?`,
    - ответ: агрегаты по промо (кол‑во бронирований, выручка, скидка).
- Для каждого эндпоинта описать:
  - пример запроса,
  - пример ответа,
  - используемые агрегатные таблицы и индексы.

---

### E2. Реализация Next API routes

**Задача E2.1 — Реализовать `apps/web/src/app/admin/api/analytics/*` маршруты** — **[x] done**

- Общие требования:
  - авторизация и права:
    - использовать существующие хелперы (`getBizContextForManagers` и аналоги),
    - гарантировать, что запрос видит только свои бизнесы/филиалы.
  - обработка параметров:
    - валидация периода (ограничить макс. размер окна, например 92 дня),
    - дефолтные значения (последние 30 дней).
- Для каждого маршрута:
  - использовать заранее подготовленные агрегатные таблицы,
  - избегать N+1 и тяжёлых join’ов поверх сырых событий.

---

### E3. Перформанс и кэширование

**Задача E3.1 — Добавить индексы и базовые кэши** — **[x] done**

- Индексация:
  - `business_daily_stats` по (`biz_id`, `date`),
  - `business_hourly_load` по (`biz_id`, `branch_id`, `date`),
  - при необходимости — частичные индексы/covering indexes по часто используемым колонкам.
- Кэш:
  - подумать о простом слое кэша (например, в Supabase через materialized view или в памяти процесса для самых популярных запросов).

---

## 8. Эпик F — UI витрины в админ‑dashboard

### F1. Структура раздела и навигация

**Задача F1.1 — Добавить раздел “Аналитика” в админ‑dashboard** — **[x] done**

- Обновлена верхняя навигация админки (`AdminNav`):
  - добавлен пункт `Аналитика` (`/admin/analytics/overview`) с i18n‑ключом `admin.nav.analytics`.
- Структура раздела и страницы:
  - создан layout `apps/web/src/app/admin/analytics/layout.tsx` с заголовком и табами;
  - заведены маршруты‑заглушки:
    - `/admin/analytics/overview`,
    - `/admin/analytics/funnel`,
    - `/admin/analytics/load`,
    - `/admin/analytics/promotions`
    (реальный UI будет реализован в задачах F2.x).

---

### F2. Компоненты и UX

**Задача F2.1 — Страница “Обзор”** — **[x] done**

- Показать:
  - ключевые KPI: общее количество бронирований, конверсия home→бронирование, доля промо‑бронирований, выручка.
  - короткие графики трендов по дням (за выбранный период).
- Фильтры:
  - выбор периода (7 / 30 / 90 дней, кастомный),
  - выбор филиала (выпадающий список),
  - выбор канала (web / mobile / all).

**Задача F2.2 — Страница “Фанел” (воронка)** — **[x] done**

- Визуализация:
  - воронка из 3–5 шагов (home_view → business_page_view → booking_flow_start → booking_created → booking_confirmed_or_paid).
  - для каждого шага:
    - количество пользователей/сессий,
    - конверсия до шага и между шагами.
- UX:
  - при наведении/клике — подсказки с численными значениями.

**Задача F2.3 — Страница “Загрузка” (heatmap)** — **[x] done**

- Heatmap:
  - ось X — часы (0–23),
  - ось Y — дни недели или конкретные даты,
  - цвет — количество записей или относительная загрузка.
- Возможности:
  - переключение режимов: «по часам недели» (усреднение по неделям) / «по конкретным датам» (скользящее окно).

**Задача F2.4 — Страница “Промо”** — **[x] done**

- Таблица/чарты:
  - общее количество промо‑бронирований,
  - выручка с промо vs без промо,
  - вклад отдельных типов промо (first_visit, birthday, referral…).
- UX:
  - сортировка по выручке,
  - фильтры по филиалу, типу промо.

---

### F3. Фильтры и сохранение настроек

**Задача F3.1 — Единый компонент фильтров для аналитики** — **[x] done**

- Фильтры:
  - период,
  - филиал(ы),
  - канал (web/mobile),
  - опционально — категория/услуга (на будущее).
- Сохранение:
  - хранить последние выбранные фильтры в query‑строке/LocalStorage,
  - чтобы при возврате в раздел аналитики пользователь видел знакомый контекст.

---

## 9. Эпик G — Безопасность, валидация и rollout

### G1. Права доступа и изоляция данных

**Задача G1.1 — Проверить и документировать права для всех аналитических API** — **[x] done**

- Убедиться, что:
  - все маршруты `/api/admin/analytics/*` используют корректный контекст бизнеса,
  - нет возможности увидеть агрегаты по чужим бизнесам.
- Добавить раздел про безопасность в этот документ или в `MONITORING_AND_ANALYTICS.md` с перекрёстной ссылкой.

---

### G2. Валидация корректности метрик

**Задача G2.1 — Тех. чек‑лист сверки метрик** — **[x] done**

- Подготовить список SQL‑запросов и сценариев:
  - сверка количества бронирований в `business_daily_stats` с `bookings` за конкретный день,
  - сверка heatmap с сырыми данными по слотам/бронированиям,
  - проверка промо‑метрик на нескольких реальных бизнесах.

---

### G3. A/B‑тестирование и поэтапный запуск

**Задача G3.1 — План постепенного rollout’а** — **[x] done**

- Шаги:
  - stage 1: включить раздел аналитики только для нескольких тестовых бизнесов,
  - stage 2: собирать фидбек, поправить UX/метрики,
  - stage 3: включить по умолчанию всем владельцам.

- Практический чек‑лист для пилота (что делать сейчас):
  - ручной прогон всех страниц аналитики (`Обзор`, `Воронка`, `Загрузка`, `Промо`) на 2–3 тестовых бизнесах: проверить фильтры, отсутствие ошибок и «здравость» цифр;
  - для тех же бизнесов и дат прогнать SQL‑запросы из раздела «Тех. чек‑лист сверки метрик (G2.1)» в `MONITORING_AND_ANALYTICS.md` и сверить с UI;
  - выбрать 2–5 пилотных бизнесов, показать им раздел аналитики и собрать от них структурированный фидбек (что понятно/непонятно, какие метрики полезны, чего не хватает).

---

## 10. Приоритизация (предложенный MVP‑срез)

**MVP‑обязательный набор:**

1. A1, A2, A3 — описать метрики и события.
2. B1.1, B2.1, B2.2 — схемы `analytics_events`, `business_daily_stats`, `business_hourly_load` (+ миграции).
3. C1.1, C1.2, C3.1 — трекинг событий на вебе + backend‑события бронирований.
4. D1.1, D1.2 — cron для дневной статистики.
5. E1.1, E2.1 — базовые API `overview`, `load`, `promotions`.
6. F1.1, F2.1, F2.3 — раздел “Аналитика” + страницы “Обзор” и “Загрузка”.
7. G1.1, G2.1 — права доступа и базовая сверка метрик.

Остальные задачи можно планировать как последующие инкременты, расширяющие глубину аналитики и UX.

---

## 11. Дальнейшее развитие: витрина для владельца бизнеса

**Контекст:** текущая реализация раздела аналитики (эпики E–F) доступна в админ‑панели суперадмина по маршрутам `/admin/analytics/*`. Основные потребители метрик — владельцы и менеджеры конкретных бизнесов в кабинете `/dashboard`.

**Задача H1 — Вынести ключевые метрики в кабинет бизнеса** — **[x] done**

- Создать страницу `/dashboard/analytics` (или подменю в существующем разделе отчётов/финансов).
- Подключить существующие агрегаты `business_daily_stats` и `business_hourly_load` через новые API‑маршруты `/api/dashboard/analytics/*` с использованием `getBizContextForManagers`.
- Упростить UI относительно админки: фокус на текущем бизнесе, базовые фильтры периода и филиала, без системных срезов по всей платформе.

**Задача H2 — Развести права доступа и роли для аналитики** — **[x] done**

- Явно задокументировать разграничение:
  - `/admin/analytics/*` — только для суперадминов (обзор по системе);
  - `/dashboard/analytics/*` — для владельцев и менеджеров конкретного бизнеса.
- Убедиться, что оба набора API используют одни и те же агрегирующие таблицы без дублирования бизнес‑логики.