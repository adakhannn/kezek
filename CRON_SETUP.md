# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron Jobs –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤

## üìã –û–±–∑–æ—Ä

Cron job –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è **–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC** (8:00 –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ë–∏—à–∫–µ–∫–∞, UTC+5).

## üîß –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ vercel.json

–§–∞–π–ª `vercel.json` —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É:

```json
{
  "crons": [
    {
      "path": "/api/cron/close-shifts",
      "schedule": "0 18 * * *"
    },
    {
      "path": "/api/cron/recalculate-ratings",
      "schedule": "0 3 * * *"
    }
  ]
}
```

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:**
- `0 3 * * *` = –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC (08:00 Asia/Bishkek)
- –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  - `0 2 * * *` = 02:00 UTC (07:00 Asia/Bishkek)
  - `0 4 * * *` = 04:00 UTC (09:00 Asia/Bishkek)

## üîê –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –í Vercel (Production):

1. –ü–µ—Ä–µ–π–¥–∏ –≤ **Settings** ‚Üí **Environment Variables** —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è:
   ```
   CRON_SECRET=—Ç–≤–æ–π_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å
   ```
   –∏–ª–∏
   ```
   VERCEL_CRON_SECRET=—Ç–≤–æ–π_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å
   ```

3. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á, –Ω–∞–ø—Ä–∏–º–µ—Ä:
   ```bash
   # –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á (–≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ):
   openssl rand -hex 32
   ```

4. **–í–∞–∂–Ω–æ:** –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π (Production, Preview, Development)

### –õ–æ–∫–∞–ª—å–Ω–æ (.env.local):

–î–æ–±–∞–≤—å –≤ —Ñ–∞–π–ª `.env.local`:

```env
CRON_SECRET=—Ç–≤–æ–π_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å
```

## üöÄ –®–∞–≥ 3: –î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. –ó–∞–∫–æ–º–º–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
   ```bash
   git add vercel.json
   git commit -m "feat: add cron job for rating recalculation"
   git push
   ```

2. –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π cron job

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Vercel Dashboard:
   - –ü–µ—Ä–µ–π–¥–∏ –≤ **Settings** ‚Üí **Cron Jobs**
   - –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–¥–∞—á–∞ `/api/cron/recalculate-ratings`

## ‚úÖ –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–π —Ç–µ—Å—Ç (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ curl):

```bash
# –ó–∞–º–µ–Ω–∏ SECRET_KEY –Ω–∞ —Ç–≤–æ–π CRON_SECRET
curl -X GET "http://localhost:3000/api/cron/recalculate-ratings" \
  -H "Authorization: Bearer SECRET_KEY"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "message": "Ratings recalculated successfully"
}
```

### –¢–µ—Å—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

```bash
# –ó–∞–º–µ–Ω–∏ SECRET_KEY –∏ DOMAIN
curl -X GET "https://kezek.kg/api/cron/recalculate-ratings" \
  -H "Authorization: Bearer SECRET_KEY"
```

### –ß–µ—Ä–µ–∑ Vercel Dashboard:

1. –ü–µ—Ä–µ–π–¥–∏ –≤ **Deployments**
2. –í—ã–±–µ—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–ø–ª–æ–π
3. –û—Ç–∫—Ä–æ–π **Functions** ‚Üí –Ω–∞–π–¥–∏ `/api/cron/recalculate-ratings`
4. –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ **Invoke**

## üìä –®–∞–≥ 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

1. –í Vercel Dashboard ‚Üí **Logs**
2. –§–∏–ª—å—Ç—Ä: `[Recalculate Ratings Cron]`
3. –ò—â–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
   - `Successfully recalculated ratings` ‚úÖ
   - `Error:` ‚ùå

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä—å –≤ Supabase:

```sql
-- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –¥–Ω–µ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å
SELECT COUNT(*) FROM staff_day_metrics WHERE metric_date = CURRENT_DATE - 1;

-- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ä–µ–π—Ç–∏–Ω–≥–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
SELECT id, full_name, rating_score, rating_updated_at 
FROM staff 
WHERE rating_score IS NOT NULL 
ORDER BY rating_updated_at DESC 
LIMIT 10;
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π `schedule` –≤ `vercel.json`:

**–§–æ—Ä–º–∞—Ç cron:** `–º–∏–Ω—É—Ç–∞ —á–∞—Å –¥–µ–Ω—å –º–µ—Å—è—Ü –¥–µ–Ω—å_–Ω–µ–¥–µ–ª–∏`

**–ü—Ä–∏–º–µ—Ä—ã:**
- `0 3 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC
- `0 2 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC  
- `30 3 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:30 UTC
- `0 3 * * 1` - –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 03:00 UTC
- `0 */6 * * *` - –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

**–í–∞–∂–Ω–æ:** Vercel –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UTC –≤—Ä–µ–º—è!

## üîç –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Cron –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `vercel.json` –∑–∞–¥–µ–ø–ª–æ–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å –≤ Vercel Dashboard ‚Üí Settings ‚Üí Cron Jobs
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `CRON_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞: 401 Unauthorized

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `CRON_SECRET` —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ Vercel –∏ –≤ –∫–æ–¥–µ
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer ...` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –¥–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –≤ SQL —Ñ—É–Ω–∫—Ü–∏—è—Ö

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ Vercel ‚Üí Logs
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ Supabase
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `recalculate_ratings_for_date` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
   ```sql
   SELECT proname FROM pg_proc WHERE proname = 'recalculate_ratings_for_date';
   ```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** Cron job –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ
- **–ß–∞—Å—Ç–æ—Ç–∞:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å (–Ω–æ—á—å—é)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å `CRON_SECRET` –≤ git!
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ù–∞—Å—Ç—Ä–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Vercel –¥–ª—è –æ—à–∏–±–æ–∫ cron jobs

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron job:

1. ‚úÖ –î–æ–∂–¥–∏—Å—å –ø–µ—Ä–≤–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. ‚úÖ –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ä–µ–π—Ç–∏–Ω–≥–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

