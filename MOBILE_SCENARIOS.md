# Карта мобильных сценариев (MOB-1)

Высокоуровневая карта ключевых сценариев мобильного приложения, с указанием зависимостей от сети/API и базовых фолбэков.

---

## 1. Авторизация в мобильном приложении

### 1.1. Вход по WhatsApp (OTP)

- **Шаги (happy path)**:
  1. Пользователь открывает экран входа (`SignInScreen` / `WhatsAppScreen`).
  2. Вводит номер телефона.
  3. Приложение вызывает `POST /api/auth/whatsapp/send-otp`.
  4. Пользователь получает код в WhatsApp и вводит его.
  5. Приложение вызывает `POST /api/auth/whatsapp/verify-otp`.
  6. Получает access/refresh токен Supabase, сохраняет сессию и перенаправляет в основную навигацию.

- **Зависимости**:
  - Доступен backend (`/api/auth/whatsapp/*`).
  - Доступен WhatsApp Business API (отправка/доставка OTP).
  - Доступ к Supabase для проверки кода и выдачи токена.

- **Фолбэки**:
  - Ошибка сети → показать понятное сообщение, предложить повторить позже.
  - Неверный/просроченный код → сообщение об ошибке, ограничение количества попыток.
  - Падение WhatsApp API → fallback через сообщение “не можем отправить код, попробуйте позже или другой способ входа” (при наличии альтернатив).

### 1.2. Обновление токена (mobile-exchange)

- **Шаги**:
  1. При запуске приложения проверяем локальную сессию (refresh токен).
  2. При необходимости выполняем `POST /api/auth/mobile-exchange` для получения нового access токена.

- **Зависимости**:
  - Доступ к `POST /api/auth/mobile-exchange`.
  - Живой Supabase Auth (валидация refresh токена).

- **Фолбэки**:
  - Ошибка сети/серверная ошибка → оставаться в offline‑режиме (ограниченный функционал) или запросить повторный вход пользователя.

---

## 2. Публичная запись с мобильного

### 2.1. Browsing бизнеса и слотов

- **Шаги (happy path)**:
  1. Пользователь выбирает бизнес и филиал (экраны каталога/фильтрации).
  2. Приложение запрашивает список услуг/мастеров через REST/`/api/...` или Supabase.
  3. Загружает слоты через RPC `get_free_slots_service_day_v2` (через web API) или прямой Supabase запрос.

- **Зависимости**:
  - Доступ к Supabase (REST + RPC) / соответствующим API роутам.
  - Рабочие RLS политики для публичного потока.

- **Фолбэки**:
  - Ошибка сети → показ локального сообщения, возможность “потянуть для обновления”.
  - Падение RPC → fallback на отображение сообщения “слоты временно недоступны”.

### 2.2. Создание брони (quick-hold)

- **Шаги (happy path)**:
  1. После выбора филиала/услуги/мастера/даты/времени отправляется `POST /api/quick-hold` с Bearer токеном.
  2. Backend выполняет hold → confirm via RPC и отправляет уведомления.
  3. Мобильное приложение получает `{ ok: true, booking_id, confirmed: true }` и показывает экран успеха.

- **Зависимости**:
  - Доступ к `POST /api/quick-hold`.
  - Живой Supabase (RPC `hold_slot`, `confirm_booking`).

- **Фолбэки**:
  - Ошибка валидации (400) → выводим текст ошибки (например, слот уже занят).
  - Ошибка сети → показываем ошибку и даём повторить; повторные запросы должны быть аккуратны (чтобы не создать дубликаты).

---

## 3. Кабинет клиента (мобильный)

### 3.1. Просмотр своих броней

- **Шаги**:
  1. Приложение запрашивает список бронирований пользователя через web API или Supabase (фильтр по `client_id = auth.uid()`).
  2. Отображает предстоящие и прошедшие записи.

- **Зависимости**:
  - Доступ к соответствующим API (например, `/api/cabinet/bookings` или Supabase `bookings`).

- **Фолбэки**:
  - При отсутствии сети → показываем последний закешированный список (если реализовано кеширование) или сообщение “нет подключения”.

### 3.2. Отмена бронирования

- **Шаги**:
  1. Пользователь выбирает предстоящую бронь и нажимает “Отменить”.
  2. Приложение вызывает `POST /api/bookings/[id]/cancel`.

- **Фолбэки**:
  - Ошибка сети → оставить бронь в предыдущем состоянии и показать ошибку.
  - Отсутствие прав/несоответствие бизнесу → показать сообщение, не изменяя локальный статус.

---

## 4. Кабинет сотрудника (mobile staff)

### 4.1. Работа со сменой (онлайн + оффлайн)

- **Шаги (happy path онлайн)**:
  1. Сотрудник открывает текущую смену (`/api/staff/shift/open` или эквивалентный mobile‑endpoint).
  2. В течение дня добавляет клиентов/операции (`/api/staff/shift/items`).
  3. В конце дня закрывает смену (`/api/staff/shift/close`).
  4. При необходимости владелец корректирует часы (`/api/dashboard/staff-shifts/[id]/update-hours`).

- **Оффлайн‑поведение (уже реализовано для staff‑смен)**:
  - Локальный кеш текущей смены и списка клиентов (SecureStore/AsyncStorage).
  - Очередь оффлайн‑операций (открытие/закрытие смены, добавление клиентов), которая:
    - накапливает операции в отсутствие сети;
    - при восстановлении соединения поочерёдно отправляет их на сервер;
    - защищает от дублирования (идемпотентность/проверки на бекенде).

- **Зависимости**:
  - `/api/staff/shift/open`, `/api/staff/shift/items`, `/api/staff/shift/close`;
  - локальное хранилище и очередь синхронизации.

- **Фолбэки**:
  - При частичном успехе синхронизации → повторная попытка по расписанию; пользователь видит индикатор статуса.
  - При необратимой ошибке операции → метка ошибки в очереди, понятное сообщение и предложение повторить вручную.

### 4.2. Просмотр финансовой статистики

- **Шаги**:
  1. Сотрудник открывает экран статистики (например, “Мои смены”).
  2. Приложение запрашивает агрегаты по API (`/api/dashboard/staff/[id]/finance/stats` и/или `/api/staff/finance`).

- **Фолбэки**:
  - При отсутствии сети → отображать последние успешные данные из кеша или показывать “нет подключения”.

---

## 5. Взаимодействие с WhatsApp в мобилке

### 5.1. Авторизация через WhatsApp (см. 1.1)

### 5.2. Управление бронированием через WhatsApp (webhook)

Мобильное приложение напрямую не дергает webhook, но должно корректно реагировать на изменения статуса брони, произошедшие по WhatsApp‑командам.

- **Шаги**:
  1. Клиент пишет в WhatsApp (отмена/подтверждение/помощь).
  2. Веб‑backend обрабатывает `POST /api/webhooks/whatsapp`, меняет статус брони в Supabase.
  3. Мобильное приложение при следующей синхронизации:
     - видит обновлённый статус брони;
     - обновляет UI (отмена/подтверждение).

- **Фолбэки**:
  - Если мобилка была оффлайн во время изменений → при восстановлении соединения нужно корректно подтянуть актуальные статусы через API/ Supabase.

---

## 6. Сводка по зависимостям и фолбэкам

- **Основные внешние зависимости**:
  - Supabase (Auth + Postgres + RPC).
  - Web‑API (`/api/**`) как фасад к Supabase.
  - WhatsApp Business API (OTP + webhook).
  - Email‑провайдер (Resend) — косвенно (через уведомления).

- **Типовые фолбэки**:
  - Отсутствие сети:
    - для staff‑смен — оффлайн‑очередь и локальный кеш;
    - для остальных сценариев — сообщения об ошибке + повтор запроса.
  - Падение конкретного внешнего сервиса:
    - для WhatsApp/email — пользователю показывается ошибка отправки/получения OTP/уведомлений, при этом основная бизнес‑логика (создание/отмена брони, закрытие смен) должна работать.

