## План проблемных зон Kezek

Этот список — только **актуальные проблемы и долги**, без уже решённых задач.

### 1. Стабильность денег и смен

1. **Потенциальные race conditions при открытии/закрытии смен**
   - При одновременном открытии/закрытии смены несколькими запросами могут возникнуть конфликты.
   - Нужно добавить транзакции или блокировки для критичных операций (открытие/закрытие смены, обновление финансов).
   - Проверить логику переоткрытия закрытых смен — может ли это привести к потере данных.

2. **Оптимизация запросов к БД в финансовых отчётах**
   - В `/api/dashboard/finance/all` и `/api/dashboard/staff/[id]/finance/stats` выполняются множественные запросы.
   - Рассмотреть использование агрегатных функций SQL или материализованных представлений для ускорения.
   - Добавить кэширование для часто запрашиваемых данных (например, статистика за сегодня).

---

### 2. Бронирование и UX

3. **Дальнейший рефакторинг `BookingForm`**
   - Компонент всё ещё содержит 46+ хуков (`useEffect`, `useState`, `useMemo`, `useCallback`).
   - Логика временных переводов, фильтрации услуг и загрузки слотов переплетена.
   - Задача: выделить отдельные хуки для:
     - управления временными переводами (`useTemporaryTransfers`);
     - фильтрации услуг (`useServicesFilter`);
     - загрузки слотов (`useSlotsLoader`);
     - управления шагами (уже частично сделано, но можно улучшить).

4. **Производительность загрузки слотов**
   - При каждом изменении `serviceId`, `staffId`, `dayStr` выполняется RPC-запрос.
   - Добавить debounce для частых изменений.
   - Рассмотреть кэширование слотов на клиенте (например, для одного дня/мастера/услуги).

---

### 3. Качество кода и технический долг

5. **Унификация логирования и уведомлений**
   - В коде найдено множество использований `console.log/error/warn` (особенно в `apps/web/src/app/b/[slug]/view.tsx`).
   - Заменить все на `logDebug`, `logWarn`, `logError` из `@/lib/log`.
   - Заменить оставшиеся `alert()` в booking flow на toast-уведомления (в `view.tsx` найдено 8+ использований).
   - Заменить `confirm()` на модальные диалоги с использованием toast или кастомных компонентов.
   - Это улучшит диагностику в продакшене и обеспечит единообразный UX.

6. **Обработка ошибок в API routes**
   - Некоторые API routes не имеют полной обработки ошибок (например, `whatsapp/*`, `auth/telegram/*`).
   - Стандартизировать формат ответов об ошибках.
   - Добавить централизованный error handler middleware.

7. **Валидация данных на клиенте**
   - Не все формы имеют клиентскую валидацию перед отправкой на сервер.
   - Добавить валидацию для:
     - форм создания/редактирования услуг;
     - форм создания/редактирования сотрудников;
     - форм бронирования (особенно для гостевых броней).

---

### 4. Безопасность и производительность

8. **Проверка и усиление RLS политик**
   - Провести аудит всех RLS политик на предмет утечек данных.
   - Убедиться, что владельцы бизнесов не могут видеть данные других бизнесов.
   - Проверить, что сотрудники не могут изменять данные других сотрудников.

---

### 5. Тестирование

11. **Расширение покрытия тестами**
    - Добавить интеграционные тесты с test database для критичных операций.
    - Добавить `data-testid` атрибуты в UI компоненты для стабильности E2E тестов.
    - Добавить тесты для edge cases в booking flow (конфликты слотов, временные переводы).
    - Добавить тесты для промоакций (различные типы, граничные случаи).

---

### 6. Качество кода и унификация

---

18. **Улучшение типизации и безопасности типов**
    - Заменить использование `any` и `unknown` на конкретные типы там, где это возможно.
    - Добавить строгую типизацию для RPC результатов (сейчас используется `as unknown`).
    - Улучшить типизацию в API routes, особенно для ответов Supabase RPC.
    - Добавить валидацию типов на runtime для критичных данных (например, результаты финансовых расчетов).

19. **Оптимизация производительности клиентской части**
    - Проверить использование `useEffect` на предмет потенциальных утечек памяти.
    - Оптимизировать ре-рендеры в больших компонентах (например, `BookingForm`).
    - Добавить мемоизацию для тяжелых вычислений.
    - Рассмотреть использование React.memo для компонентов, которые часто ре-рендерятся.

20. **Улучшение обработки ошибок в booking flow**
    - Стандартизировать обработку ошибок в `createBooking` и `createGuestBooking`.
    - Добавить retry логику для сетевых ошибок.
    - Улучшить сообщения об ошибках для пользователя (более понятные и actionable).
    - Добавить логирование ошибок на сервер для анализа.

21. **Оптимизация загрузки данных**
    - Добавить кэширование для часто запрашиваемых данных (списки услуг, мастеров, филиалов).
    - Рассмотреть использование React Query или SWR для управления состоянием серверных данных.
    - Оптимизировать количество запросов при загрузке страницы бронирования.
    - Добавить prefetching для данных, которые вероятно понадобятся пользователю.

22. **Улучшение доступности (a11y)**
    - Добавить ARIA-атрибуты для интерактивных элементов.
    - Убедиться, что все формы имеют правильные labels и error messages.
    - Добавить поддержку навигации с клавиатуры для всех интерактивных элементов.
    - Проверить контрастность цветов для соответствия WCAG стандартам.

---

## Приоритеты

**Высокий приоритет:**
- Пункты 1, 3, 5, 8, 18 (стабильность, безопасность, качество кода, типизация)

**Средний приоритет:**
- Пункты 2, 4, 6, 7, 11, 19, 20, 21 (производительность, тестирование, UX, оптимизация)

**Низкий приоритет:**
- Пункты 22 (доступность, улучшения UX)
