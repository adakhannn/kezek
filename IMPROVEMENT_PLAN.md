## План улучшений Kezek (технический и продуктовый)

### 1. Деньги и смены

1. **Сценарии смен “от и до” (проверки и стабилизация)**
   - Описать и прогнать ключевые сценарии:
     - Открытие смены → добавление клиентов → ручное закрытие.
     - Открытие смены → добавление клиентов → незакрытая смена → авто‑закрытие cron’ом.
     - Смена без клиентов, но с гарантированной оплатой (почасовая ставка).
     - Смена с клиентами и гарантией (когда гарантия больше/меньше доли от выручки).
     - Ручная правка `hours_worked` владельцем после закрытия.
   - Проверить согласованность данных между:
     - `staff_shifts` (итоги смены),
     - `staff_shift_items` (клиенты в смене),
     - `bookings` (записи клиентов и их статусы),
     - промоакциями (`promotion_applied`).
   - При необходимости доработать API/SQL, чтобы не было расхождений (например, статусы `paid`/`no_show` всегда согласованы с содержимым смены).

2. **Простой “отчёт по смене” для владельца**
   - На странице владельца показать компактный, но понятный блок для каждой смены:
     - `total_amount` — общий оборот по услугам.
     - `consumables_amount` — расходники.
     - `master_share` — итоговая доля сотрудника.
     - `salon_share` — итоговая доля бизнеса.
     - `hours_worked` — отработанные часы.
     - `hourly_rate`, `guaranteed_amount`, `topup_amount` — параметры гарантии.
   - Добавить короткие пояснения/подсказки по формуле, основанные на `SYSTEM_FEATURES_DOCUMENTATION.md`, чтобы владельцу было понятно, “почему такая сумма”.

---

### 2. Бронирование (страница `/b/[slug]/booking`, BookingForm)

3. **Рефакторинг и упрощение `BookingForm`**
   - Внутри файла `view.tsx` (компонент `BookingForm`) выделить отдельные логические блоки:
     - Выбор филиала/даты/мастера/услуги (state‑машина шагов).
     - Расчёт `servicesFiltered` (мастер + филиал + временные переводы).
     - Загрузка и фильтрация слотов (`get_free_slots_service_day_v2` + пост‑фильтрация).
   - Вынести эти части в небольшие вспомогательные функции/хуки внутри файла, без изменения поведения:
     - сделать код более читаемым и предсказуемым,
     - уменьшить связность между разными `useEffect`.

4. **Улучшение UX вокруг слотов и ошибок**
   - Гарантировать, что при отсутствии слотов пользователь всегда видит понятную причину, а не “просто пусто”:
     - мастер не выполняет услугу,
     - нет расписания на выбранный день (включая временные переводы),
     - техническая ошибка RPC.
   - Уже сделано: дружественное сообщение при ошибке `get_free_slots_service_day_v2`. Дальше:
     - пройтись по всем местам, где выставляется `slotsError`, и привести тексты к понятным формулировкам на 3 языках,
     - убедиться, что состояние “нет слотов, но это ожидаемо” и “ошибка” различаются по UI.

---

### 3. Акции (Promotions)

5. **Формализация приоритетов акций**
   - В SQL‑функциях (`can_use_promotion`, `apply_promotion_to_booking`) и в документации явно зафиксировать порядок приоритета, если подходит несколько акций:
     - первый визит (`first_visit_discount`),
     - день рождения (`birthday_discount`),
     - реферальные (`referral_free`, `referral_discount_50`),
     - каждая N‑я услуга бесплатно (`free_after_n_visits`),
     - другие типы (по мере добавления).
   - Добавить несколько тестовых сценариев/SQL‑скриптов, которые демонстрируют работу приоритетов на реальных примерах.

6. **Проверка и защита ограничений использования акций**
   - Убедиться и зафиксировать тестами, что:
     - `first_visit_discount` срабатывает только один раз для первого оплаченного визита клиента в бизнесе/филиале.
     - `free_after_n_visits` действительно даёт бесплатную услугу ровно каждый N‑й раз, без двойных срабатываний.
     - реферальные акции не “перезапускаются” при повторных изменениях статусов (`hold → confirmed → paid → ...`).
   - При необходимости добавить защиту в SQL (проверка истории `client_promotion_usage`) от повторного использования одной и той же акции вне заданных правил.

---

### 4. Рейтинги

7. **Карточка объяснения рейтинга для владельца**
   - Для сотрудников, филиалов и бизнеса на дашборде владельца добавить компактный блок:
     - текущий `rating_score`,
     - вклад основных факторов (проценты / веса):
       - отзывы,
       - количество клиентов,
       - возвращаемость,
       - дисциплина (опоздания).
   - Использовать уже существующие настройки в `rating_global_config` и функции расчёта из миграций, не меняя саму формулу, а только делая её прозрачной.

8. **Мониторинг и “здоровье” рейтингов**
   - Использовать API `/api/admin/ratings/status` как основу для “панели состояния рейтингов” в админке:
     - показать последние даты метрик по staff/branches/businesses,
     - числа записей без рейтинга,
     - подсветить, если что‑то давно не обновлялось (например, нет метрик за последние N дней).
   - При необходимости добавить простой cron‑алерт (лог/уведомление), если пересчёт рейтингов несколько дней подряд падает с ошибкой.

---

### 5. Тесты и поддерживаемость

9. **Минимальный набор автотестов для критичных сценариев**
   - Для бэкенда (SQL/TS) подготовить набор проверок/скриптов (юнит‑тесты или хотя бы ручные SQL‑сценарии), покрывающих:
     - закрытие смен (ручное и cron), включая гарантию и отсутствие клиентов,
     - применение промо при переводе брони в `paid` (через `mark-attendance`, через закрытие смены),
     - инициализацию и ежедневный пересчёт рейтингов.
   - Цель: любая правка в логике денег/промо/рейтингов должна быстро проверяться без ручного “прокликивания” интерфейса.

10. **Единый подход к логам и диагностике**
    - Продолжить начатый подход с `debugLog`/`debugWarn`:
      - подробный дебаг оставлять только в dev‑режиме,
      - в проде — только важные ошибки (`console.error`) и аккуратные предупреждения.
    - Важно, чтобы по логам можно было:
      - понять, почему не применилось промо,
      - почему не пересчитался рейтинг,
      - почему не закрылась смена.


