## План проблемных зон Kezek

Этот список — только **актуальные проблемы и долги**, без уже решённых задач.

### 1. Стабильность денег и смен

1. **Потенциальные race conditions при открытии/закрытии смен**
   - При одновременном открытии/закрытии смены несколькими запросами могут возникнуть конфликты.
   - Нужно добавить транзакции или блокировки для критичных операций (открытие/закрытие смены, обновление финансов).
   - Проверить логику переоткрытия закрытых смен — может ли это привести к потере данных.

2. **Оптимизация запросов к БД в финансовых отчётах**
   - В `/api/dashboard/finance/all` и `/api/dashboard/staff/[id]/finance/stats` выполняются множественные запросы.
   - Рассмотреть использование агрегатных функций SQL или материализованных представлений для ускорения.
   - Добавить кэширование для часто запрашиваемых данных (например, статистика за сегодня).

---

### 2. Бронирование и UX

3. **Дальнейший рефакторинг `BookingForm`**
   - Компонент всё ещё содержит 46+ хуков (`useEffect`, `useState`, `useMemo`, `useCallback`).
   - Логика временных переводов, фильтрации услуг и загрузки слотов переплетена.
   - Задача: выделить отдельные хуки для:
     - управления временными переводами (`useTemporaryTransfers`);
     - фильтрации услуг (`useServicesFilter`);
     - загрузки слотов (`useSlotsLoader`);
     - управления шагами (уже частично сделано, но можно улучшить).

4. **Производительность загрузки слотов**
   - При каждом изменении `serviceId`, `staffId`, `dayStr` выполняется RPC-запрос.
   - Добавить debounce для частых изменений.
   - Рассмотреть кэширование слотов на клиенте (например, для одного дня/мастера/услуги).

---

### 3. Качество кода и технический долг

5. **Унификация логирования**
   - В коде найдено 481+ использований `console.log/error/warn` (включая 20+ файлов в `apps/web/src/app/api`).
   - Заменить все на `logDebug`, `logWarn`, `logError` из `@/lib/log`.
   - Это улучшит диагностику в продакшене и позволит контролировать уровень логирования.

6. **Обработка ошибок в API routes**
   - Некоторые API routes не имеют полной обработки ошибок (например, `whatsapp/*`, `auth/telegram/*`).
   - Стандартизировать формат ответов об ошибках.
   - Добавить централизованный error handler middleware.

7. **Валидация данных на клиенте**
   - Не все формы имеют клиентскую валидацию перед отправкой на сервер.
   - Добавить валидацию для:
     - форм создания/редактирования услуг;
     - форм создания/редактирования сотрудников;
     - форм бронирования (особенно для гостевых броней).

---

### 4. Безопасность и производительность

8. **Проверка и усиление RLS политик**
   - Провести аудит всех RLS политик на предмет утечек данных.
   - Убедиться, что владельцы бизнесов не могут видеть данные других бизнесов.
   - Проверить, что сотрудники не могут изменять данные других сотрудников.

9. **Rate limiting для API endpoints**
   - Критичные endpoints (бронирование, открытие/закрытие смен) должны иметь rate limiting.
   - Защита от DDoS и злоупотреблений.
   - Особенно важно для публичных endpoints (`/api/quick-book-guest`, `/api/quick-hold`).

10. **Мониторинг производительности**
    - Добавить метрики времени выполнения для критичных операций:
      - загрузка слотов (`get_free_slots_service_day_v2`);
      - закрытие смены;
      - применение промо;
      - пересчёт рейтингов.
    - Настроить алерты при деградации производительности.

---

### 5. Тестирование

11. **Тесты для критичных API endpoints**
    - Нет unit/integration тестов для:
      - `/api/staff/shift/close` (закрытие смены с гарантией);
      - `/api/bookings/[id]/mark-attendance` (применение промо);
      - `/api/dashboard/finance/all` (агрегация финансов);
      - `/api/cron/close-shifts` (автоматическое закрытие смен).
    - Добавить тесты для edge cases (нулевые суммы, отрицательные значения, некорректные даты).

12. **E2E тесты для критичных пользовательских сценариев**
    - Полный цикл бронирования (выбор филиала → мастера → услуги → времени → подтверждение).
    - Открытие смены → добавление клиентов → закрытие смены.
    - Применение промо при бронировании.

---

### 6. Мобильное приложение

13. **Синхронизация веб и мобильной версий**
    - Мобильное приложение может иметь устаревшую логику бронирования.
    - Убедиться, что промо применяются одинаково в веб и мобильной версиях.
    - Проверить, что рейтинги отображаются корректно в мобильном приложении.

---

### 7. Технический долг

14. **Очистка неиспользуемого кода**
    - WhatsApp функциональность временно скрыта, но код остался в кодовой базе.
    - Решить: либо полностью удалить, либо доработать и включить обратно.
    - Аналогично проверить другие временно отключённые функции.

15. **Документация API**
    - Нет централизованной документации для API endpoints.
    - Рассмотреть использование OpenAPI/Swagger или создание простого markdown-файла с описанием всех endpoints, их параметров и ответов.

---

### 8. UX улучшения

16. **Улучшение обратной связи при длительных операциях**
    - При закрытии смены с большим количеством клиентов операция может занимать время.
    - Добавить индикаторы загрузки и прогресс-бары для длительных операций.
    - Показывать понятные сообщения при ошибках (не просто "Internal Server Error").

17. **Оптимизация мобильного UX**
    - Проверить, что все формы удобны для использования на мобильных устройствах.
    - Убедиться, что календари и селекторы работают корректно на touch-устройствах.
    - Оптимизировать размеры кнопок и полей ввода для мобильных.

---

## Приоритеты

**Высокий приоритет:**
- Пункты 1, 3, 5, 8, 9 (стабильность, безопасность, качество кода)

**Средний приоритет:**
- Пункты 2, 4, 6, 7, 10, 11 (производительность, тестирование, UX)

**Низкий приоритет:**
- Пункты 12, 13, 14, 15, 16, 17 (технический долг, документация, улучшения UX)
