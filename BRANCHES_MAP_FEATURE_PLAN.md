# Карта филиалов для клиентов — план реализации

## 1. Контекст и цель

**Идея:** дать клиенту интерактивную карту, где:
- видно все активные филиалы на карте;
- можно отфильтровать по категории бизнеса;
- можно быстро найти **самый ближайший филиал** к пользователю.

**Для кого:** конечные клиенты (публичный сайт), в перспективе — виджет из результатов поиска.

---

## 2. Эпик M — "Branches Map"

### M1. Данные и индексирование

**Задача M1.1 — Проверить/нормализовать координаты филиалов** — **[x] done**

- Проверить, какие поля сейчас используются для координат:
  - **Итог:** в коде при создании/обновлении заполняется только `branches.coords` (строка EWKT `SRID=4326;POINT(lon lat)`). В схеме БД есть также `branches.lat` и `branches.lon` (см. `types/supabase.ts`).
- Убедиться, что:
  - у всех актуальных филиалов в проде координаты заполнены — **проверять вручную в проде**; после миграции можно выполнить `SELECT id, name FROM branches WHERE is_active = true AND (coords IS NULL OR coords = '')`;
  - формат координат единообразен (WGS84, lat/lon) — **единый формат:** EWKT WGS84, приложение использует `validateLatLon` и `coordsToEWKT` из `@/lib/validation`.
- Сделано:
  - добавлена миграция `20260228000000_branches_coords_lat_lon_sync.sql`: при отсутствии добавлены колонки `lat`/`lon`, бэкфилл lat/lon из `coords` (парсинг EWKT), триггер синхронизации при INSERT/UPDATE `coords`;
  - в админке при **создании** филиала координаты обязательны (проверка в `admin/api/businesses/[id]/branches/create`); при редактировании координаты по желанию (можно очистить).

**Задача M1.2 — Индексы под геопоиск и фильтры** — **[x] done**

- Существующие индексы по филиалам:
  - `branches_biz_active_name_idx` (`biz_id, is_active, name where is_active = true`) — уже покрывает типичный паттерн `WHERE biz_id = ? AND is_active = true ORDER BY name` (dashboard/branches, booking form);
  - `branches_rating_score_idx` (`rating_score desc nulls last where is_active = true`) — используется аналитикой рейтингов, к карте прямого отношения не имеет.
- Стратегия индексации под карту **без PostGIS**:
  - для фильтрации перед георасчётом API будут использовать предикаты `is_active = true` и `coords IS NOT NULL` (а фильтры по категории/городу пойдут по `businesses.categories` и, при появлении, `businesses.city_id`);
  - на уровне БД достаточно использовать существующий `branches_biz_active_name_idx` + отбор только филиалов с непустыми координатами;
  - отдельный гео‑индекс по координатам **не создаём**, пока `coords` — строка EWKT и нет PostGIS.
- План по гео‑индексации **с PostGIS (дальнейший этап, не в этом MR)**:
  - при переводе `branches.coords` на тип `geography(Point,4326)` добавить индекс `create index ... using gist(coords)` для ускорения поиска ближайших;
  - при этом API `/api/branches/nearby` смогут использовать `order by coords <-> user_point limit N`.
- Ограничения для API (учесть в реализации M2):
  - минимальный радиус поиска: **1–2 км** (если в радиусе пусто — можно автоматически расширять до 5–10 км);
  - максимальное количество филиалов в ответе: **50–100** записей (чтобы не перегружать карту и не делать тяжелые выборки).

---

### M2. Backend‑API

**Задача M2.1 — API для карты филиалов** — **[x] done**

- `GET /api/branches/map`
  - Назначение: отдавать список филиалов для отрисовки на публичной карте (клиентский сайт/мобильное приложение).
  - Реализация: `apps/web/src/app/api/branches/map/route.ts` поверх Supabase **anon**‑клиента с учётом RLS (`Public can view active branches`).
  - Query‑параметры:
    - `cityId` (опционально) — зарезервировано; будет фильтровать по `businesses.city_id`, когда поле появится в схеме;
    - `categoryId` (опционально) — ограничить категорией бизнеса (`businesses.categories @> ARRAY[categoryId]`);
    - `onlyActive` (по умолчанию `true`) — фильтрация по `branches.is_active`; если `onlyActive=false`, отдаём все филиалы с координатами у одобренных бизнесов.
  - Базовые предикаты (дополнительно к RLS):
    - `lat IS NOT NULL AND lon IS NOT NULL` (используем синхронизированные координаты из миграции M1.1);
    - бизнесы только с `is_approved = true` (дублируется RLS, но фиксируется в коде для явности).
  - Ответ:

    ```jsonc
    {
      "ok": true,
      "data": [
        {
          "id": "BRANCH_ID",
          "businessId": "BIZ_ID",
          "businessName": "Название бизнеса",
          "businessSlug": "biz-slug",
          "branchName": "Филиал №1",
          "address": "ул. Такая‑то, 1",
          "lat": 40.514,
          "lon": 72.806,
          "categoryId": "CATEGORY_ID",   // если известна (из query или первой категории бизнеса), иначе null
          "categoryName": null           // название категории подтягиваем отдельно в UI при необходимости
        }
      ]
    }
    ```

**Задача M2.2 — API для поиска ближайших филиалов** — **[x] done**

- `GET /api/branches/nearby`
  - Назначение: вернуть **отсортированный список ближайших филиалов** к заданной точке (для кнопки «Найти ближайший ко мне» и списка по удалённости).
  - Реализация: `apps/web/src/app/api/branches/nearby/route.ts`; расчёт расстояния — Haversine в JS (`@/lib/geo.ts`), без PostGIS.
  - Query‑параметры:
    - `lat`, `lon` — координаты пользователя (обязательные, WGS84); при невалидных — 400.
    - `categoryId` (опционально) — только филиалы бизнесов с этой категорией;
    - `cityId` (опционально) — зарезервировано (фильтр по городу при появлении поля);
    - `limit` (по умолчанию 20, макс. 100) — сколько филиалов вернуть;
    - `radiusKm` (по умолчанию 20, мин. 1, макс. 200) — искать только в этом радиусе (км).
  - Логика:
    - только активные филиалы с заполненными `lat`/`lon` у одобренных бизнесов (и по категории, если задана);
    - расстояние до пользователя — Haversine; отбор по `radiusKm`, сортировка по расстоянию, обрезка по `limit`.
  - Ответ: массив того же формата, что и у `/api/branches/map`, с доп. полем **`distanceKm`** (число, км, два знака после запятой), порядок — по возрастанию расстояния.

---

### M3. UI/UX — публичная карта

**Задача M3.1 — Страница `/map` с картой филиалов** — **[x] done**

- Реализация: `app/map/page.tsx` (серверный layout + metadata), `app/map/MapPageClient.tsx` (клиент: карта, фильтры, список).
- Верхняя панель:
  - селект категории (список категорий из ответа `/api/branches/map`);
  - кнопка «Ближайший ко мне» (см. M3.2);
  - селект города — зарезервировано (когда появится в API).
- Карта: Yandex Maps (`loadYandexMaps`), маркеры по каждому филиалу; при клике по маркеру — баллун с названием, адресом и ссылкой «Записаться» (`/b/{slug}/booking`). Кластеризация не реализована (при необходимости добавить ObjectManager с кластеризацией).
- Боковая панель: список филиалов, синхронизированный с картой; при выборе «Ближайший ко мне» — список от nearby, сортировка по расстоянию, отображение `distanceKm`; клик по карточке центрирует карту и выделяет маркер.

**Задача M3.2 — Кнопка "ближайший ко мне"** — **[x] done**

- На фронтенде (в `MapPageClient`):
  - по клику запрашивается геолокация через `navigator.geolocation` (подпись кнопки и сообщения об ошибке через i18n: `common.map.geoExplain`, `common.map.geoDenied`, `common.map.geoError`);
  - при успехе — вызов `/api/branches/nearby` с `lat`, `lon` и текущим `categoryId`; результат подставляется в список, карта центрируется на первом (ближайшем) филиале, список прокручивается к началу, карточка ближайшего выделяется.
- При отказе в геолокации выводится сообщение `common.map.geoDenied`; выбор города вручную и результаты по городу без дистанции оставлены на будущее.

---

### M4. Безопасность, производительность и rollout

**Задача M4.1 — Ограничения и защита API** — **[x] done**

- Ограничения по количеству:
  - `/api/branches/map` — `limit(500)` на выборку филиалов по бизнесам (передаём только активные с координатами);
  - `/api/branches/nearby` — `DEFAULT_LIMIT = 20`, `MAX_LIMIT = 50` (жёсткий верхний предел).
- Для `/nearby`:
  - валидируем диапазоны `lat/lon` через `validateLatLon` (lat \[-90; 90], lon \[-180; 180]);
  - валидируем `radiusKm` (дефолт 20 км, допустимо от 1 до 200 км; вне диапазона → 400);
  - оба эндпоинта обёрнуты в `withRateLimit(..., RateLimitConfigs.public, ...)`, что защищает от чрезмерного количества запросов; при необходимости можно усилить конфиг для публичных geo‑эндпоинтов отдельно.

**Задача M4.2 — Rollout** — **[x] done**

- Rollout сразу в прод: карта доступна по адресу `/map`, тестирование — в production.
- Видимые ссылки на карту:
  - на главной странице — кнопка «Карта филиалов» под поиском (иконка карты + `common.map.title`);
  - в футере — ссылка «Карта филиалов» (`footer.map`) рядом с Политикой конфиденциальности и Условиями.
- Этап 3 (опционально, позже): виджет ближайшего филиала в карточках бизнеса и на странице успешной брони.

