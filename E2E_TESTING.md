# E2E Тестирование критичных пользовательских сценариев

## Обзор

Реализованы E2E тесты для критичных пользовательских сценариев системы Kezek с использованием Playwright. Тесты проверяют полные пользовательские потоки от начала до конца.

## Установка

```bash
cd apps/web
pnpm install
pnpm exec playwright install
```

## Настройка

Создайте файл `apps/web/.env.local` с тестовыми данными:

```env
PLAYWRIGHT_TEST_BASE_URL=http://localhost:3000
E2E_TEST_BUSINESS_SLUG=test-business-slug
E2E_TEST_STAFF_EMAIL=staff@test.com
E2E_TEST_STAFF_PASSWORD=test-password
```

## Запуск тестов

```bash
# Запустить все E2E тесты
pnpm test:e2e

# Запустить с UI (интерактивный режим)
pnpm test:e2e:ui

# Запустить в видимом браузере
pnpm test:e2e:headed

# Запустить в режиме отладки
pnpm test:e2e:debug

# Запустить конкретный тест
pnpm test:e2e e2e/booking-flow.spec.ts
```

## Тестовые сценарии

### 1. Полный цикл бронирования (`e2e/booking-flow.spec.ts`)

**Сценарий:** выбор филиала → мастера → услуги → времени → подтверждение

**Шаги:**
1. Выбор филиала
2. Выбор мастера
3. Выбор услуги
4. Выбор даты
5. Выбор времени (слот)
6. Заполнение данных клиента (имя, телефон, email)
7. Подтверждение бронирования

**Проверки:**
- Успешное создание бронирования
- Редирект на страницу подтверждения или кабинет
- Отображение сообщения об успехе

### 2. Управление сменой (`e2e/shift-management.spec.ts`)

**Сценарий:** открытие смены → добавление клиентов → закрытие смены

**Шаги:**
1. Авторизация как сотрудник
2. Открытие смены
3. Добавление первого клиента (имя, услуга, сумма)
4. Добавление второго клиента
5. Закрытие смены
6. Проверка итоговой информации

**Проверки:**
- Успешное открытие смены
- Клиенты добавлены в список
- Успешное закрытие смены
- Отображение итоговой суммы

### 3. Применение промо (`e2e/promotion-application.spec.ts`)

**Сценарий:** применение промоакции при бронировании

**Шаги:**
1. Выбор филиала с активной промоакцией
2. Проверка отображения промоакции
3. Выбор услуги и мастера
4. Выбор даты и времени
5. Проверка применения промо (скидка в итоговой сумме)
6. Подтверждение бронирования

**Проверки:**
- Промоакция отображается на странице
- Скидка применена к итоговой сумме
- Бронирование создано с примененной промо

## Селекторы элементов

Тесты используют `data-testid` атрибуты для поиска элементов. Убедитесь, что в UI компонентах добавлены соответствующие атрибуты:

```tsx
// Примеры
<button data-testid="branch-select">Выбрать филиал</button>
<div data-testid="master-card">...</div>
<input data-testid="date-picker" />
<button data-testid="time-slot">10:00</button>
```

## Настройка тестовой базы данных

Для корректной работы E2E тестов рекомендуется:

1. **Создать отдельную тестовую базу данных** (или использовать test database)
2. **Настроить seed данные:**
   - Тестовый бизнес с известным slug
   - Филиалы с активными промоакциями
   - Услуги и мастера
   - Тестовые учетные данные для сотрудников
3. **Очищать данные** перед/после каждого теста (опционально)

## Отладка

### Использование Playwright Inspector

```bash
pnpm test:e2e:ui
```

### Остановка выполнения

Добавьте в тест:
```typescript
await page.pause();
```

### Просмотр результатов

После выполнения тестов:
- Скриншоты: `test-results/`
- Видео: `test-results/`
- HTML отчет: `playwright-report/`

### Запуск в headed режиме

```bash
pnpm test:e2e:headed
```

## CI/CD интеграция

E2E тесты автоматически запускаются в CI pipeline (`.github/workflows/ci.yml`).

**Требования:**
- Переменные окружения в GitHub Secrets:
  - `E2E_TEST_BASE_URL` (опционально, по умолчанию `http://localhost:3000`)
  - `E2E_TEST_BUSINESS_SLUG`
  - `E2E_TEST_STAFF_EMAIL`
  - `E2E_TEST_STAFF_PASSWORD`

**Артефакты:**
- HTML отчет загружается как артефакт
- Скриншоты и видео сохраняются при ошибках

## Рекомендации

1. **Идемпотентность:** Тесты должны быть независимыми и не зависеть от порядка выполнения
2. **Изоляция:** Каждый тест должен работать с изолированными данными
3. **Стабильность:** Используйте `waitFor` вместо фиксированных задержек
4. **Селекторы:** Предпочитайте `data-testid` селекторы для стабильности
5. **Очистка:** Очищайте тестовые данные после выполнения тестов

## Расширение

Для добавления новых E2E тестов:

1. Создайте файл `e2e/your-scenario.spec.ts`
2. Используйте структуру существующих тестов
3. Добавьте `data-testid` атрибуты в UI компоненты при необходимости
4. Обновите документацию

## Проблемы и решения

### Тесты падают из-за таймаутов

- Увеличьте `timeout` в `playwright.config.ts`
- Проверьте, что сервер запущен и доступен
- Убедитесь, что тестовые данные подготовлены

### Селекторы не находятся

- Проверьте, что `data-testid` атрибуты добавлены в UI
- Используйте Playwright Inspector для отладки селекторов
- Проверьте, что элементы видимы (не скрыты CSS)

### Проблемы с авторизацией

- Убедитесь, что тестовые учетные данные корректны
- Проверьте, что сессия сохраняется между шагами
- Используйте `page.context().storageState()` для сохранения состояния

