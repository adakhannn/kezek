# Список проблем на странице `/dashboard/staff/[id]/finance`

## Критические проблемы

### 1. **Ошибка "Бизнес не найден" (NO_BIZ_ACCESS)** ✅ ИСПРАВЛЕНО
- **Описание**: Страница показывает сообщение "Бизнес не найден" вместо контента
- **Причина**: Функция `getBizContextForManagers()` в `apps/web/src/lib/authBiz.ts` не может определить бизнес для пользователя
- **Возможные причины**:
  - У пользователя нет ролей `owner`, `admin` или `manager` в таблице `user_roles`
  - Пользователь не является владельцем бизнеса (нет записи в `businesses.owner_id`)
  - Проблемы с авторизацией (сессия истекла или невалидна)
- **Местоположение**: 
  - `apps/web/src/app/dashboard/layout.tsx:14` - вызов `getBizContextForManagers()`
  - `apps/web/src/app/dashboard/staff/[id]/finance/page.tsx:16` - повторный вызов
- **Исправления**:
  - ✅ Добавлено детальное логирование на каждом этапе проверки доступа
  - ✅ Добавлена диагностическая информация (количество ролей, бизнесов и т.д.)
  - ✅ Улучшена обработка ошибок запросов к базе данных
  - ✅ Улучшен UI компонента ошибки с более понятными сообщениями и инструкциями
  - ✅ Добавлена кнопка "Обновить страницу" для быстрого перезапуска

### 2. **Отсутствие обработки ошибок API в клиентском компоненте**
- **Описание**: Если API `/api/dashboard/staff/[id]/finance` возвращает ошибку, она не всегда корректно отображается пользователю
- **Местоположение**: 
  - `apps/web/src/app/staff/finance/hooks/useShiftData.ts:218-228` - обработка ошибок есть, но может быть улучшена
- **Проблема**: Ошибки сети или 404/500 от API могут не показывать понятное сообщение

### 3. **Потенциальная проблема с проверкой принадлежности сотрудника к бизнесу**
- **Описание**: В API роуте проверка `String(staff.biz_id) !== String(bizId)` может не сработать из-за разных типов данных
- **Местоположение**: `apps/web/src/app/api/dashboard/staff/[id]/finance/route.ts:40`
- **Проблема**: Если `biz_id` и `bizId` имеют разные типы (number vs string), сравнение может быть некорректным

## Проблемы UX/UI

### 4. **Неконсистентное сообщение об ошибке**
- **Описание**: На странице показывается "Бизнес не найден", но в `DashboardLayoutClient` используется другое сообщение ("Нет доступа к кабинету")
- **Местоположение**: 
  - `apps/web/src/app/dashboard/components/DashboardLayoutClient.tsx:18` - показывает "Нет доступа к кабинету"
  - Текст "Бизнес не найден" может приходить из другого источника (возможно, из публичных страниц `/b/[slug]`)
- **Проблема**: Неясно, откуда берется текст "Бизнес не найден" - возможно, это из другого компонента или статический текст. Нужно проверить, не происходит ли редирект на публичную страницу

### 5. **Отсутствие индикации загрузки при ошибке**
- **Описание**: При ошибке загрузки данных смены пользователь может не понять, что происходит
- **Местоположение**: `apps/web/src/app/staff/StaffFinanceView.tsx:219-225`
- **Проблема**: `LoadingOverlay` показывается только при `isInitialLoad`, но ошибки могут происходить и при последующих загрузках

### 6. **Нет обработки случая, когда сотрудник не найден**
- **Описание**: Если сотрудник с указанным ID не существует или не принадлежит бизнесу, страница возвращает `notFound()`, но это может быть неочевидно для пользователя
- **Местоположение**: `apps/web/src/app/dashboard/staff/[id]/finance/page.tsx:25-26`
- **Проблема**: Пользователь видит 404 страницу Next.js вместо понятного сообщения

## Проблемы производительности

### 7. **Потенциальные race conditions в useShiftData**
- **Описание**: Хук `useShiftData` использует `isLoadingRef` для предотвращения повторных вызовов, но это может привести к пропуску обновлений
- **Местоположение**: `apps/web/src/app/staff/finance/hooks/useShiftData.ts:90-96`
- **Проблема**: Если пользователь быстро меняет дату, некоторые запросы могут быть проигнорированы

### 8. **Множественные запросы к API при изменении даты**
- **Описание**: При изменении `shiftDate` происходит перезагрузка данных, но может быть несколько одновременных запросов
- **Местоположение**: `apps/web/src/app/staff/finance/hooks/useShiftData.ts:252-256`
- **Проблема**: `useEffect` с зависимостями может вызвать несколько запросов подряд

## Проблемы типизации и безопасности

### 9. **Небезопасное использование `dangerouslySetInnerHTML`**
- **Описание**: В `DashboardLayoutClient` используется `dangerouslySetInnerHTML` без санитизации
- **Местоположение**: `apps/web/src/app/dashboard/components/DashboardLayoutClient.tsx:19`
- **Проблема**: Потенциальная XSS уязвимость, если переводы содержат вредоносный код

### 10. **Отсутствие проверки на null/undefined в некоторых местах**
- **Описание**: В нескольких местах кода отсутствуют проверки на null перед использованием данных
- **Примеры**:
  - `apps/web/src/app/staff/StaffFinanceView.tsx:63-65` - проверка `shiftData.today` может быть улучшена
  - `apps/web/src/app/api/dashboard/staff/[id]/finance/route.ts:154-158` - работа с `ss.services` без полной проверки типов

## Проблемы логики

### 11. **Некорректная логика определения режима только для чтения**
- **Описание**: `isReadOnlyForOwner` устанавливается в `true` если `staffId` существует и смена не открыта, но это может быть неверно для некоторых сценариев
- **Местоположение**: `apps/web/src/app/staff/StaffFinanceView.tsx:72`
- **Проблема**: Владелец не может редактировать закрытые смены, но логика может быть слишком строгой

### 12. **Отсутствие валидации даты в API**
- **Описание**: API принимает параметр `date` из query string без валидации формата
- **Местоположение**: `apps/web/src/app/api/dashboard/staff/[id]/finance/route.ts:23-31`
- **Проблема**: Некорректный формат даты может привести к ошибкам или неожиданному поведению

## Рекомендации по исправлению

1. **Добавить детальное логирование** в `getBizContextForManagers()` для диагностики проблем с доступом
2. **Улучшить обработку ошибок** в клиентских компонентах с понятными сообщениями
3. **Добавить валидацию** входных данных в API роутах
4. **Улучшить типизацию** и добавить проверки на null/undefined
5. **Добавить error boundaries** для лучшей обработки ошибок React
6. **Оптимизировать загрузку данных** для предотвращения race conditions
7. **Добавить санитизацию** для `dangerouslySetInnerHTML` или использовать безопасную альтернативу

