# Финальная настройка WhatsApp API

## Полученные данные

✅ **Phone Number ID:** `862538650287008`  
✅ **Business Account ID:** `829309533409879`  
✅ **Номер телефона:** `+996 224 701 717`  
⚠️ **Статус верификации:** `NOT_VERIFIED`

## Шаг 1: Установка переменных окружения

### В продакшене (Vercel):

1. Перейди в настройки проекта Vercel
2. Environment Variables
3. Добавь/обнови следующие переменные:

```env
WHATSAPP_ACCESS_TOKEN=твой_long_lived_token_здесь
WHATSAPP_PHONE_NUMBER_ID=862538650287008
WHATSAPP_VERIFY_TOKEN=kezek_whatsapp_verify
```

4. Сохрани и перезапусти деплой

### Локально (`.env.local`):

```env
WHATSAPP_ACCESS_TOKEN=твой_long_lived_token_здесь
WHATSAPP_PHONE_NUMBER_ID=862538650287008
WHATSAPP_VERIFY_TOKEN=kezek_whatsapp_verify
```

## Шаг 2: Проверка конфигурации

После установки переменных, проверь через:

```
GET https://kezek.kg/api/whatsapp/diagnose
```

Или:

```
GET https://kezek.kg/api/whatsapp/test
```

## Шаг 3: Верификация номера (если нужно)

Статус `NOT_VERIFIED` означает, что номер еще не прошел полную верификацию WhatsApp.

### Что это значит:
- Номер может отправлять сообщения только в рамках 24-часового окна
- Для отправки сообщений вне окна нужны шаблоны сообщений
- Полная верификация может занять несколько дней

### Как верифицировать:
1. Перейди в [WhatsApp Manager](https://business.facebook.com/latest/settings/whatsapp_account)
2. Выбери аккаунт "Kezek"
3. Перейди на вкладку **"Phone Numbers"**
4. Найди номер `+996 224 701 717`
5. Если есть кнопка **"Запросить верификацию"** или **"Request Verification"**, нажми её
6. Следуй инструкциям WhatsApp

### Альтернатива:
- Используй тестовый номер (если доступен) для разработки
- Для продакшена дождись верификации или используй шаблоны сообщений

## Шаг 4: Настройка Webhook (если еще не настроен)

1. В Meta Developers → WhatsApp → Настройка → Подписаться на Webhooks
2. URL обратного вызова: `https://kezek.kg/api/webhooks/whatsapp`
3. Подтверждение маркера: `kezek_whatsapp_verify`
4. Выбери события:
   - ✅ `messages` - входящие сообщения
   - ✅ `message_status` - статусы доставки

## Шаг 5: Тестирование

### Тест 1: Отправка OTP через WhatsApp

1. Зайди в профиль пользователя
2. Добавь номер телефона
3. Нажми **"Отправить код"** для верификации WhatsApp
4. Код должен прийти на WhatsApp

### Тест 2: Уведомления о бронированиях

1. Создай тестовое бронирование
2. Проверь, что уведомление пришло на WhatsApp (если включено в настройках профиля)

## Если что-то не работает

### Ошибка "Account not registered":
- Номер еще не полностью подключен
- Дождись завершения процесса подключения
- Или используй тестовый номер

### Ошибка "Re-engagement message":
- Сообщение отправлено вне 24-часового окна
- Добавь получателя в список тестовых номеров в Meta Developers
- Или используй шаблоны сообщений

### Ошибка "Invalid phone number ID":
- Проверь, что `WHATSAPP_PHONE_NUMBER_ID=862538650287008` установлен правильно
- Убедись, что токен имеет доступ к этому номеру

## Итоговые значения

```env
# WhatsApp Cloud API
WHATSAPP_ACCESS_TOKEN=<твой_токен>
WHATSAPP_PHONE_NUMBER_ID=862538650287008
WHATSAPP_VERIFY_TOKEN=kezek_whatsapp_verify
```

---

**Готово!** После установки этих переменных WhatsApp API должен работать.

