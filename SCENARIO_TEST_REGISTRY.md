# Реестр ключевых бизнес-сценариев (тестовая матрица)

Цель: опорный список сценариев, по которым должны быть **минимум** API‑тесты и, по возможности, E2E (web/mobile).

Для каждого сценария указаны задействованные эндпоинты и критичные ветки (happy path + ключевые edge‑cases).

---

## 1. Публичная запись авторизованного пользователя (web/mobile)

- **Кратко**: пользователь, будучи авторизованным, делает запись через публичный поток (web или мобильное приложение).
- **Эндпоинты**:
  - `POST /api/quick-hold`
  - `POST /api/notify` (тип `confirm`)
- **Ветки**:
  - **Happy path**:
    - валидные `biz_id`, `branch_id` (или авто‑подбор первого активного), `service_id`, `staff_id`, `start_at` в будущем;
    - успешный `hold_slot` + `confirm_booking`, уведомления отправлены.
  - **Edge cases**:
    - `branch_id` не передан → берётся первый активный филиал;
    - `branch_id` указан, но филиал неактивен или не принадлежит бизнесу → ошибка валидации;
    - `start_at` в прошлом или невалидный ISO → ошибка валидации;
    - `hold_slot`/`confirm_booking` возвращают ошибку → корректный HTTP‑ответ с типом ошибки (`validation`/`internal`). 

---

## 2. Гостевая запись без аккаунта (web)

- **Кратко**: создание брони для гостя без регистрации.
- **Эндпоинты**:
  - `POST /api/quick-book-guest`
  - `POST /api/notify` (тип `confirm`)
- **Ветки**:
  - **Happy path**:
    - валидные `biz_id`, `branch_id`, `service_id`, `staff_id`, `start_at`, `client_name`, `client_phone`;
    - успешное создание гостевой брони и триггер уведомлений.
  - **Edge cases**:
    - невалидный телефон/почта;
    - отсутствие `branch_id` (сейчас обязателен для guest‑флоу) → ошибка;
    - превышение rate limit (`public`).

---

## 3. Отмена бронирования клиентом (web/mobile)

- **Кратко**: клиент отменяет свою бронь из личного кабинета или мобильного приложения.
- **Эндпоинты**:
  - `POST /api/bookings/[id]/cancel`
  - `POST /api/notify` (тип `cancel`)
- **Ветки**:
  - **Happy path**:
    - бронь принадлежит пользователю (`client_id === auth.uid()`), статус не `cancelled`;
    - успешный вызов `cancel_booking` или прямое обновление статуса на `cancelled` (fallback);
    - уведомления отправлены.
  - **Edge cases**:
    - попытка отменить чужую бронь (ни клиент, ни менеджер бизнеса) → `403 forbidden`;
    - бронь уже отменена → идемпотентный `ok`;
    - ошибка RPC `cancel_booking` не связанная с назначением сотрудника → корректная ошибка `validation`.

---

## 4. Отмена/подтверждение через WhatsApp

- **Кратко**: клиент управляет бронированием через команды в WhatsApp.
- **Эндпоинты**:
  - `POST /api/webhooks/whatsapp`
  - RPC `cancel_booking`, `confirm_booking` (через доменный слой/репозитории)
- **Ветки**:
  - **Happy path**:
    - текстовые команды “отмена”, “подтвердить” по активной брони → успешное изменение статуса;
    - команда “помощь” → корректный список команд.
  - **Edge cases**:
    - несколько активных броней → корректная работа с индексами (“отмена 1”, “отмена 2”);
    - нераспознанная команда → отправка справочного сообщения;
    - медиа‑сообщения → корректная обработка/игнорирование без падений.

---

## 5. Отметка посещения и применение промо (оператор/менеджер)

- **Кратко**: оператор отмечает, пришёл ли клиент, и система применяет промо/скидки.
- **Эндпоинты**:
  - `POST /api/bookings/[id]/mark-attendance`
- **Ветки**:
  - **Happy path**:
    - менеджер бизнеса, которому принадлежит бронь, отмечает `attended: true` → статус → `paid`, промо применено (если доступно);
    - `attended: false` → статус `no_show` или эквивалент.
  - **Edge cases**:
    - попытка отметить чужую бронь → `403`;
    - промо просрочено или превышен лимит использований → корректное отсутствие применения промо;
    - повторная отметка посещения → идемпотентное поведение/ошибка бизнес‑логики, но без нарушения инвариантов.

---

## 6. Открытие/закрытие смены сотрудником (mobile/web)

- **Кратко**: сотрудник открывает свою смену с телефона и закрывает её с расчётом финансов.
- **Эндпоинты**:
  - `POST /api/staff/shift/open`
  - `POST /api/staff/shift/close`
  - `POST /api/staff/shift/items`
  - `GET /api/staff/shift/today`
- **Ветки**:
  - **Happy path**:
    - открытие смены в рабочий день при отсутствии открытой смены;
    - добавление клиентов через `items`, закрытие смены с корректным расчётом `master_share`, `salon_share`, `guaranteed_amount`, `topup_amount`;
    - последующий запрос `shift/today` показывает корректный статус/агрегаты.
  - **Edge cases**:
    - попытка открыть смену в выходной → ошибка;
    - попытка открыть вторую смену в тот же день → ошибка;
    - закрытие смены без клиентов (только суммы) → корректные расчёты;
    - корректировка `hours_worked` (см. отдельный сценарий ниже). 

---

## 7. Корректировка часов и гарантии владельцем (finance)

- **Кратко**: владелец вручную корректирует отработанные часы, что пересчитывает гарантию и доплату.
- **Эндпоинты**:
  - `POST /api/dashboard/staff-shifts/[id]/update-hours`
- **Ветки**:
  - **Happy path**:
    - владелец бизнеса меняет `hours_worked` в допустимом диапазоне → пересчёт `guaranteed_amount`, `topup_amount` и итоговых долей.
  - **Edge cases**:
    - смена не закрыта → ошибка;
    - `hours_worked` < 0 или > 24 → ошибка валидации;
    - пользователь не владелец → `403`.

---

## 8. Финансовая статистика по сотруднику и по всем сотрудникам (dashboard)

- **Кратко**: менеджер/владелец смотрит агрегированную статистику по доходам.
- **Эндпоинты**:
  - `GET /api/dashboard/finance/all`
  - `GET /api/dashboard/staff/[id]/finance`
  - `GET /api/dashboard/staff/finance/all`
- **Ветки**:
  - **Happy path**:
    - валидные фильтры периода (`day/week/month/year`, даты, `branch_id`) → корректные агрегаты;
    - доступ только в рамках своего бизнеса.
  - **Edge cases**:
    - невалидные даты/период → ошибка валидации;
    - попытка доступа к чужому бизнесу → `403`;
    - отсутствие смен/данных в периоде → корректные нули/пустые списки.

---

## 9. CRUD по филиалам и услугам (админ/менеджер)

- **Кратко**: создание/редактирование филиалов и услуг с валидацией координат/цен/продолжительности.
- **Эндпоинты**:
  - `POST /api/branches/create`
  - `POST /api/branches/[id]/update` / `delete` / `schedule` / `schedule` (GET)
  - `POST /api/services/create`
  - `POST /api/services/[id]/update`
  - `POST /api/services/[id]/delete`
- **Ветки**:
  - **Happy path**:
    - создание филиала с координатами (`lat/lon`) → корректный EWKT и generated `lat/lon` в БД;
    - создание услуги с валидными `duration_min`, `price_from <= price_to`, `branch_ids`;
    - обновление/удаление только в рамках своего бизнеса.
  - **Edge cases**:
    - неверные координаты → ошибка валидации;
    - `price_to < price_from` или отрицательные суммы → ошибка;
    - попытка управлять сущностями чужого бизнеса → `403`;
    - удаление филиала/услуги с зависимостями → ожидаемые ошибки/запреты (в зависимости от реализованной политики).

---

## 10. Промоакции: создание, получение, обновление и применение

- **Кратко**: менеджер создаёт промо, оно применяется при оплате/посещении.
- **Эндпоинты**:
  - `POST /api/dashboard/branches/[branchId]/promotions`
  - `GET /api/dashboard/branches/[branchId]/promotions`
  - `PATCH /api/dashboard/branches/[branchId]/promotions/[promotionId]`
  - `DELETE /api/dashboard/branches/[branchId]/promotions/[promotionId]`
  - косвенно: `POST /api/bookings/[id]/mark-attendance` (применение промо)
- **Ветки**:
  - **Happy path**:
    - создание промо типа `free_after_n_visits` / `discount_percent` с валидными параметрами;
    - получение списка промо с корректным `usage_count`;
    - обновление активности/дат действия.
  - **Edge cases**:
    - невалидные параметры промо (отрицательный `visit_count`, проценты вне `[0,100]`) → ошибка валидации;
    - промо с истёкшими датами или превышенным `usage_count` → корректное неприменение при `mark-attendance`;
    - попытка управлять промо чужого филиала → `403`.

---

## 11. Авторизация (Telegram / WhatsApp / mobile-exchange)

- **Кратко**: основные флоу аутентификации пользователей.
- **Эндпоинты**:
  - `POST /api/auth/telegram/login`
  - `POST /api/auth/telegram/link`
  - `POST /api/auth/whatsapp/send-otp`
  - `POST /api/auth/whatsapp/verify-otp`
  - `POST /api/auth/mobile-exchange`
  - `POST /api/auth/sign-out`
- **Ветки**:
  - **Happy path**:
    - успешный логин через Telegram (валидный `initData`);
    - успешная отправка/проверка OTP через WhatsApp;
    - корректный обмен refresh‑токена мобильным приложением.
  - **Edge cases**:
    - невалидный `initData`/OTP → корректная ошибка авторизации;
    - попытка повторной привязки Telegram → ожидаемая ошибка/поведение;
    - просроченные/отозванные токены при `mobile-exchange`.

---

## 12. Уведомления (email / WhatsApp / Telegram)

- **Кратко**: отправка уведомлений о бронях и проверка прав на вызов `/api/notify`.
- **Эндпоинты**:
  - `POST /api/notify`
  - `GET /api/notify/ping`
- **Ветки**:
  - **Happy path**:
    - авторизованный пользователь (клиент или менеджер бизнеса) вызывает `/api/notify` для своей брони;
    - корректное ветвление по `type: 'hold' | 'confirm' | 'cancel'` и отправка писем/WhatsApp/Telegram.
  - **Edge cases**:
    - пользователь не клиент и не менеджер соответствующего бизнеса → `403`;
    - отсутствует или некорректен `RESEND_API_KEY` → `500 internal` с понятным сообщением;
    - бронирование не найдено → `404`.

---

## 13. Отзывы (создание и обновление)

- **Кратко**: клиент оставляет/обновляет отзыв по прошедшей брони.
- **Эндпоинты**:
  - `POST /api/reviews/create`
  - `POST /api/reviews/update`
- **Ветки**:
  - **Happy path**:
    - создание отзыва по своей брони со статусом `paid`/`confirmed` в прошлом;
    - обновление рейтинга/комментария.
  - **Edge cases**:
    - попытка создать второй отзыв для той же брони → ошибка;
    - отзыв/бронь не принадлежит пользователю → `403`;
    - невалидный рейтинг (не 1–5) → ошибка валидации.

---

## 14. Health/monitoring сценарии

- **Кратко**: проверка здоровья системы и агрегационных панелей.
- **Эндпоинты**:
  - `GET /api/admin/health-check`
  - `GET /api/admin/system-health`
  - `GET /api/admin/performance/stats`
- **Ветки**:
  - **Happy path**:
    - корректный JSON статуса БД/интеграций/cron‑задач;
    - доступ только для super‑admin/админов.
  - **Edge cases**:
    - отсутствие прав → `403`;
    - временная недоступность одной из интеграций → корректное отражение статуса `degraded`/`fail`.

---

## 15. Мобильные сценарии смен (offline/online)

- **Кратко**: работа мастера с телефонa с оффлайн‑кешем.
- **Эндпоинты**:
  - на API уровне те же, что в сценариях 6–7 (`/api/staff/shift/*`, `/api/dashboard/staff/[id]/finance/stats`), но с учётом оффлайн‑очереди на клиенте.
- **Ветки** (с точки зрения сервера):
  - **Happy path**: последовательность запросов от мобильного клиента при восстановлении сети приводит к целостным данным смен/клиентов.
  - **Edge cases**:
    - повторная отправка одних и тех же оффлайн‑операций → отсутствие дублей (идемпотентность или защита на сервере);
    - рассинхронизация данных смены закрывается при следующем успешном запросе.

