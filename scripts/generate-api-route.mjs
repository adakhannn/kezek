#!/usr/bin/env node

/**
 * Простенький генератор API-роутов.
 *
 * Использование (из корня репо):
 *
 *   pnpm generate:api-route bookings/cancel
 *
 * Это создаст:
 * - apps/web/src/app/api/bookings/cancel/route.ts
 * - apps/web/src/__tests__/api/bookings/cancel.test.ts
 *
 * Файлы создаются только если ещё не существуют.
 */

import fs from 'node:fs';
import path from 'node:path';
import url from 'node:url';

const __dirname = path.dirname(url.fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '..');

function usage() {
  console.log('Usage: pnpm generate:api-route <route-path>');
  console.log('Example: pnpm generate:api-route bookings/cancel');
}

const routeArg = process.argv[2];

if (!routeArg) {
  usage();
  process.exit(1);
}

const cleanRoute = routeArg.replace(/^\/+|\/+$/g, '');
if (!cleanRoute) {
  usage();
  process.exit(1);
}

// Пути для route и теста
const apiRouteDir = path.join(
  repoRoot,
  'apps',
  'web',
  'src',
  'app',
  'api',
  ...cleanRoute.split('/'),
);
const apiRouteFile = path.join(apiRouteDir, 'route.ts');

const testDir = path.join(
  repoRoot,
  'apps',
  'web',
  'src',
  '__tests__',
  'api',
  ...cleanRoute.split('/'),
);
const testFile = path.join(testDir, 'route.test.ts');

fs.mkdirSync(apiRouteDir, { recursive: true });
fs.mkdirSync(testDir, { recursive: true });

if (!fs.existsSync(apiRouteFile)) {
  const tsTemplate = `// Generated by scripts/generate-api-route.mjs
export const runtime = 'nodejs';
export const dynamic = 'force-dynamic';

import { withErrorHandler, createSuccessResponse } from '@/lib/apiErrorHandler';
import { RateLimitConfigs, withRateLimit } from '@/lib/rateLimit';

/**
 * @swagger
 * /api/${cleanRoute}:
 *   get:
 *     summary: TODO: описание эндпоинта
 *     tags: [TODO]
 *     responses:
 *       '200':
 *         description: Успешный ответ
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/SuccessResponse'
 */
export async function GET(req: Request) {
  return withRateLimit(
    req,
    RateLimitConfigs.normal,
    () =>
      withErrorHandler('${cleanRoute}', async () => {
        return createSuccessResponse({ ok: true });
      }),
  );
}
`;

  fs.writeFileSync(apiRouteFile, tsTemplate, { encoding: 'utf8' });
  console.log(`Created API route: ${path.relative(repoRoot, apiRouteFile)}`);
} else {
  console.log(`API route already exists: ${path.relative(repoRoot, apiRouteFile)}`);
}

if (!fs.existsSync(testFile)) {
  const testTemplate = `import { GET } from '@/app/api/${cleanRoute}/route';
import { setupApiTestMocks, createMockRequest, expectSuccessResponse } from '../testHelpers';

setupApiTestMocks();

describe('/api/${cleanRoute}', () => {
  test('должен вернуть успешный ответ (скелет теста)', async () => {
    const req = createMockRequest('http://localhost/api/${cleanRoute}');
    const res = await GET(req);
    await expectSuccessResponse(res);
  });
});
`;

  fs.writeFileSync(testFile, testTemplate, { encoding: 'utf8' });
  console.log(`Created test: ${path.relative(repoRoot, testFile)}`);
} else {
  console.log(`Test already exists: ${path.relative(repoRoot, testFile)}`);
}

