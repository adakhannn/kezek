# Тестирование критичных API endpoints

## Обзор

Реализованы unit-тесты для критичных API endpoints системы Kezek. Тесты используют Jest и мокируют зависимости для изоляции тестируемого кода.

## Установка зависимостей

```bash
cd apps/web
pnpm install
```

## Запуск тестов

```bash
# Запустить все тесты
pnpm test

# Запустить тесты в watch режиме
pnpm test:watch

# Запустить тесты с покрытием
pnpm test:coverage
```

## Структура тестов

Тесты находятся в `apps/web/src/__tests__/api/`:

- `staff/shift/close.test.ts` - тесты для закрытия смены
- `bookings/mark-attendance.test.ts` - тесты для отметки посещения и применения промо
- `cron/close-shifts.test.ts` - тесты для автоматического закрытия смен
- `dashboard/finance/all.test.ts` - тесты для агрегации финансов

## Покрытие тестами

### `/api/staff/shift/close`

**Edge cases:**
- ✅ Закрытие смены с нулевой суммой
- ✅ Закрытие смены с гарантированной оплатой (0 клиентов)
- ✅ Отклонение отрицательных сумм
- ✅ Отклонение некорректных данных в items
- ✅ Обработка ошибки при отсутствии открытой смены

### `/api/bookings/[id]/mark-attendance`

**Edge cases:**
- ✅ Применение промо при отметке посещения (attended = true)
- ✅ Обработка отметки "не пришел" (attended = false)
- ✅ Отклонение отметки для будущей брони
- ✅ Возврат успеха для уже обработанной брони (paid/no_show)
- ✅ Отклонение запроса для брони другого бизнеса

### `/api/cron/close-shifts`

**Edge cases:**
- ✅ Авторизация (проверка секретного ключа)
- ✅ Отклонение запроса без/с неверным секретным ключом
- ✅ Обработка отсутствия открытых смен
- ✅ Обработка ошибки базы данных

### `/api/dashboard/finance/all`

**Edge cases:**
- ✅ Возврат пустого списка при отсутствии сотрудников
- ✅ Фильтрация по филиалу
- ✅ Обработка ошибки RPC
- ✅ Обработка некорректных параметров периода

## Мокирование

Тесты используют моки для изоляции:
- `@/lib/authBiz` - авторизация и контекст
- `@/lib/supabaseService` - Supabase клиент
- `@/lib/rateLimit` - rate limiting (пропускается в тестах)
- `@/lib/performance` - мониторинг производительности (пропускается в тестах)

## Добавление новых тестов

1. Создайте файл `apps/web/src/__tests__/api/[path]/[route].test.ts`
2. Импортируйте функцию route handler
3. Замокируйте зависимости
4. Напишите тесты для основных сценариев и edge cases

Пример:

```typescript
import { POST } from '@/app/api/your/route';

jest.mock('@/lib/authBiz', () => ({
    getStaffContext: jest.fn(),
}));

describe('/api/your/route', () => {
    test('должен обработать успешный сценарий', async () => {
        // Настройка моков
        // Вызов API
        // Проверки
    });
});
```

## Интеграция в CI

Тесты автоматически запускаются в CI pipeline (`.github/workflows/ci.yml`). Для добавления:

```yaml
- name: Run API tests
  run: |
    cd apps/web
    pnpm test
```

## Рекомендации

1. **Покрытие:** Стремитесь к покрытию >80% для критичных endpoints
2. **Edge cases:** Всегда тестируйте граничные случаи (нули, отрицательные значения, некорректные данные)
3. **Изоляция:** Используйте моки для изоляции тестируемого кода
4. **Читаемость:** Называйте тесты описательно, используйте `describe` и `test` для группировки

## Расширение

Для более полного тестирования рекомендуется:
1. Добавить интеграционные тесты с реальной БД (test database)
2. Добавить E2E тесты для критичных пользовательских сценариев
3. Настроить автоматический запуск тестов перед коммитом (pre-commit hook)

