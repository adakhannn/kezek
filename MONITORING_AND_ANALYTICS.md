# Мониторинг и аналитика финансового модуля

## Обзор

Система мониторинга и аналитики финансового модуля Kezek предоставляет инструменты для отслеживания производительности API, анализа ошибок и аудита финансовых операций.

## Доступ к мониторингу

Мониторинг доступен по адресу: `/admin/monitoring`

**Требования:**
- Доступ только для менеджеров, администраторов и владельцев бизнеса
- Автоматическая проверка прав доступа через `getBizContextForManagers`

## Компоненты системы мониторинга

### 1. Метрики API запросов

Система автоматически отслеживает все запросы к финансовым API endpoints:

- `/api/staff/finance` - получение данных смены
- `/api/staff/shift/open` - открытие смены
- `/api/staff/shift/close` - закрытие смены
- `/api/staff/shift/items` - сохранение списка клиентов

**Отслеживаемые метрики:**
- Время выполнения запроса (duration_ms)
- HTTP статус код
- Тип ошибки (validation, database, auth, server, network)
- Контекст запроса (userId, staffId, bizId)
- IP адрес и User-Agent

**Таблица:** `api_request_metrics`

### 2. Логи финансовых операций

Система автоматически логирует все критические финансовые операции:

- Открытие смены
- Закрытие смены
- Создание клиента в смене
- Обновление клиента в смене
- Удаление клиента из смены

**Отслеживаемые данные:**
- Тип операции (shift_open, shift_close, item_create, item_update, item_delete)
- Уровень логирования (info, warning, error)
- Контекст операции (staffId, bizId, shiftId)
- Детали операции (JSON)
- Временная метка

**Таблица:** `staff_finance_operation_logs`

## Использование интерфейса мониторинга

### Вкладка "Статистика"

Показывает агрегированную статистику по API запросам:

- **Общее количество запросов** за выбранный период
- **Количество ошибок** (4xx, 5xx)
- **Процент ошибок** от общего числа запросов
- **Среднее время выполнения** запросов
- **Медианное время выполнения** (p50)
- **95-й процентиль** времени выполнения (p95)
- **99-й процентиль** времени выполнения (p99)

**Фильтры:**
- Endpoint (например, `/api/staff/finance`)
- Метод (GET, POST)
- Временное окно (последние 60 минут, 24 часа, 7 дней)

### Вкладка "Метрики API"

Показывает детальный список всех API запросов с возможностью фильтрации:

**Фильтры:**
- Endpoint
- HTTP метод
- Статус код (200, 400, 500, etc.)
- Тип ошибки (validation, database, auth, server, network)
- Дата начала и окончания
- Минимальное время выполнения

**Отображаемые данные:**
- Время запроса
- Endpoint и метод
- Статус код
- Время выполнения (мс)
- Тип ошибки (если есть)
- Сообщение об ошибке
- Контекст (userId, staffId, bizId)

**Пагинация:**
- По умолчанию: 100 записей на странице
- Максимум: 1000 записей на странице

### Вкладка "Логи операций"

Показывает логи всех финансовых операций:

**Фильтры:**
- ID сотрудника (staffId)
- ID бизнеса (bizId)
- ID смены (shiftId)
- Тип операции (shift_open, shift_close, item_create, item_update, item_delete)
- Уровень логирования (info, warning, error)
- Дата начала и окончания

**Отображаемые данные:**
- Время операции
- Тип операции
- Уровень логирования
- Сотрудник (имя)
- Бизнес (название)
- Смена (ID и дата)
- Детали операции (JSON)
- Сообщение

**Пагинация:**
- По умолчанию: 100 записей на странице
- Максимум: 1000 записей на странице

## API для мониторинга

### GET `/api/admin/metrics`

Получение метрик API запросов с фильтрацией.

**Query параметры:**
- `endpoint` - фильтр по endpoint
- `method` - фильтр по HTTP методу
- `statusCode` - фильтр по статус коду
- `errorType` - фильтр по типу ошибки
- `startDate` - дата начала (ISO 8601)
- `endDate` - дата окончания (ISO 8601)
- `minDuration` - минимальное время выполнения (мс)
- `limit` - количество записей (по умолчанию 100, максимум 1000)
- `offset` - смещение для пагинации

**Ответ:**
```json
{
  "ok": true,
  "data": [
    {
      "id": "uuid",
      "endpoint": "/api/staff/finance",
      "method": "GET",
      "status_code": 200,
      "duration_ms": 150,
      "error_type": null,
      "error_message": null,
      "user_id": "uuid",
      "staff_id": "uuid",
      "biz_id": "uuid",
      "ip_address": "127.0.0.1",
      "user_agent": "Mozilla/5.0...",
      "created_at": "2024-01-26T10:00:00Z"
    }
  ],
  "pagination": {
    "total": 1000,
    "limit": 100,
    "offset": 0,
    "hasMore": true
  }
}
```

### GET `/api/admin/metrics/stats`

Получение агрегированной статистики по метрикам.

**Query параметры:**
- `endpoint` - фильтр по endpoint (по умолчанию `/api/staff/finance`)
- `method` - фильтр по HTTP методу
- `windowMinutes` - временное окно в минутах (по умолчанию 60)

**Ответ:**
```json
{
  "ok": true,
  "data": {
    "total_requests": 1000,
    "successful_requests": 950,
    "error_requests": 50,
    "error_rate": 0.05,
    "avg_duration_ms": 150,
    "median_duration_ms": 120,
    "p95_duration_ms": 300,
    "p99_duration_ms": 500,
    "min_duration_ms": 50,
    "max_duration_ms": 2000
  }
}
```

### GET `/api/admin/finance-logs`

Получение логов финансовых операций с фильтрацией.

**Query параметры:**
- `staffId` - фильтр по ID сотрудника
- `bizId` - фильтр по ID бизнеса
- `shiftId` - фильтр по ID смены
- `operationType` - фильтр по типу операции
- `logLevel` - фильтр по уровню логирования
- `startDate` - дата начала (ISO 8601)
- `endDate` - дата окончания (ISO 8601)
- `limit` - количество записей (по умолчанию 100, максимум 1000)
- `offset` - смещение для пагинации

**Ответ:**
```json
{
  "ok": true,
  "data": [
    {
      "id": "uuid",
      "operation_type": "shift_close",
      "log_level": "info",
      "staff_id": "uuid",
      "biz_id": "uuid",
      "shift_id": "uuid",
      "operation_details": {
        "total_amount": 10000,
        "master_share": 6000,
        "salon_share": 4500
      },
      "message": "Смена закрыта успешно",
      "staff": {
        "id": "uuid",
        "full_name": "Иван Иванов"
      },
      "business": {
        "id": "uuid",
        "name": "Салон красоты",
        "slug": "salon-krasoty"
      },
      "created_at": "2024-01-26T18:00:00Z"
    }
  ],
  "pagination": {
    "total": 500,
    "limit": 100,
    "offset": 0,
    "hasMore": true
  }
}
```

## Анализ метрик

### Регулярный анализ

Рекомендуется регулярно анализировать метрики для выявления проблем:

1. **Еженедельный анализ:**
   - Проверка общего количества запросов
   - Анализ процента ошибок
   - Выявление медленных запросов (p95, p99)

2. **Ежемесячный анализ:**
   - Тренды производительности
   - Анализ типов ошибок
   - Выявление проблемных endpoints

### Ключевые показатели

**Производительность:**
- Среднее время выполнения < 200ms - отлично
- Среднее время выполнения 200-500ms - нормально
- Среднее время выполнения > 500ms - требует оптимизации

**Надежность:**
- Процент ошибок < 1% - отлично
- Процент ошибок 1-5% - нормально
- Процент ошибок > 5% - требует внимания

**Критические endpoints:**
- `/api/staff/shift/close` - должен быть быстрым (< 500ms)
- `/api/staff/finance` - часто используемый, должен быть быстрым (< 200ms)
- `/api/staff/shift/items` - часто используемый, должен быть быстрым (< 300ms)

## Разрешение споров

Логи финансовых операций используются для разрешения споров между сотрудниками и владельцами бизнеса:

### Типичные сценарии

1. **Спор о сумме смены:**
   - Проверьте логи операции `shift_close`
   - Найдите детали расчета в `operation_details`
   - Проверьте список клиентов в логах `item_create`/`item_update`

2. **Спор о времени закрытия:**
   - Проверьте временную метку в логе `shift_close`
   - Сравните с метриками API запросов

3. **Проблемы с клиентами:**
   - Проверьте логи операций `item_create`, `item_update`, `item_delete`
   - Найдите детали изменений в `operation_details`

### Поиск в логах

```sql
-- Найти все операции закрытия смены для конкретного сотрудника
SELECT * FROM staff_finance_operation_logs
WHERE staff_id = 'staff-id'
  AND operation_type = 'shift_close'
  AND created_at >= '2024-01-01'
ORDER BY created_at DESC;

-- Найти все ошибки за период
SELECT * FROM staff_finance_operation_logs
WHERE log_level = 'error'
  AND created_at >= '2024-01-01'
ORDER BY created_at DESC;
```

## Настройка алертов

### Рекомендуемые алерты

1. **Высокий процент ошибок:**
   - Условие: процент ошибок > 10% за последний час
   - Действие: уведомление администратора

2. **Медленные запросы:**
   - Условие: p95 время выполнения > 1000ms за последний час
   - Действие: уведомление разработчиков

3. **Критические ошибки:**
   - Условие: ошибки типа `database` или `server`
   - Действие: немедленное уведомление

### Интеграция с системами мониторинга

Метрики можно экспортировать в внешние системы мониторинга через API:

```bash
# Получить метрики за последний час
curl -X GET "https://kezek.kg/api/admin/metrics?startDate=2024-01-26T10:00:00Z&endDate=2024-01-26T11:00:00Z" \
  -H "Cookie: <session_cookie>"

# Получить статистику
curl -X GET "https://kezek.kg/api/admin/metrics/stats?windowMinutes=60" \
  -H "Cookie: <session_cookie>"
```

## Очистка старых данных

Рекомендуется периодически очищать старые метрики и логи:

- **Метрики API:** хранить последние 90 дней
- **Логи операций:** хранить последние 365 дней

Полная политика хранения (включая воронку, брони, профили) и расписание cron описаны в [DATA_RETENTION.md](./DATA_RETENTION.md). Очистка может быть настроена через cron job (`/api/cron/data-retention`) или вручную через SQL:

```sql
-- Удалить метрики старше 90 дней
DELETE FROM api_request_metrics
WHERE created_at < NOW() - INTERVAL '90 days';

-- Удалить логи старше 365 дней
DELETE FROM staff_finance_operation_logs
WHERE created_at < NOW() - INTERVAL '365 days';
```

## Безопасность

- Доступ к мониторингу только для авторизованных менеджеров/администраторов
- Все запросы логируются
- Чувствительные данные (например, суммы) не логируются в открытом виде
- IP адреса и User-Agent сохраняются для безопасности

## Дополнительные ресурсы

- [API документация](./API_DOCUMENTATION.md) - описание всех API endpoints
- [Finance Domain README](./apps/web/src/lib/financeDomain/README.md) - руководство по финансовым расчетам
- [Admin Dashboard](../apps/web/src/app/admin/monitoring/) - исходный код интерфейса мониторинга

