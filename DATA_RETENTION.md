# Политика хранения и анонимизации данных (DATA_RETENTION)

Документ фиксирует сроки хранения данных в системе Kezek и правила удаления/анонимизации старых записей. Рекомендации по метрикам и логам согласованы с [MONITORING_AND_ANALYTICS.md](./MONITORING_AND_ANALYTICS.md).

## 1. Сводная таблица сроков хранения

| Категория данных | Срок хранения | Действие по истечении | Обоснование |
|------------------|---------------|------------------------|-------------|
| **API-метрики** (`api_request_metrics`) | 90 дней | Удаление (успешные запросы); ошибки 4xx/5xx сохраняются | Баланс между анализом трендов и объёмом данных; ошибки нужны для расследования |
| **Логи финансовых операций** (`staff_finance_operation_logs`) | 365 дней | Удаление (уровни debug/info/warn); записи с уровнем error сохраняются | Разрешение споров и аудит; рекомендация из MONITORING_AND_ANALYTICS |
| **События воронки** (`funnel_events`) | 400 дней (~13 мес.) | Удаление | Аналитика конверсии; данных без PII, достаточно года с запасом |
| **Брони** (`bookings`) | 7 лет | Анонимизация PII (имя, телефон, email клиента) | Требования учёта и возможные налоговые проверки; после срока — минимизация персональных данных |
| **Смены** (`staff_shifts`, `staff_shift_items`) | 7 лет | Только хранение; удаление не выполняется | Финансовый и трудовой учёт |
| **Клиенты (профили)** (`profiles`) | 3 года с момента последней активности | Анонимизация (имя, телефон) для профилей, не являющихся сотрудниками и не имевших броней/активности за 3 года | Снижение рисков и соответствие практике минимизации персональных данных |

## 2. Детали по категориям

### 2.1. API-метрики (`api_request_metrics`)

- **Срок:** 90 дней (рекомендация из MONITORING_AND_ANALYTICS.md).
- **Действие:** Удаляются записи успешных запросов (HTTP 2xx/3xx) старше 90 дней. Записи с кодом 4xx/5xx не удаляются для последующего разбора инцидентов.
- **Реализация:** Функция БД `cleanup_old_api_metrics(p_keep_days)`, вызов из cron с `p_keep_days = 90`.

### 2.2. Логи финансовых операций (`staff_finance_operation_logs`)

- **Срок:** 365 дней.
- **Действие:** Удаляются записи с уровнями debug, info, warn старше 365 дней. Записи с уровнем error не удаляются.
- **Реализация:** Функция БД `cleanup_old_finance_logs(p_keep_days)`, вызов из cron с `p_keep_days = 365`.

### 2.3. События воронки (`funnel_events`)

- **Срок:** 400 дней.
- **Действие:** Полное удаление записей старше 400 дней. Таблица не содержит PII, только анонимные идентификаторы сессий и ссылки на сущности (biz_id, branch_id и т.д.).
- **Реализация:** Функция БД `cleanup_old_funnel_events(p_keep_days)`, вызов из cron с `p_keep_days = 400`.

### 2.4. Брони (`bookings`)

- **Срок:** 7 лет с даты визита (`start_at`).
- **Действие:** По истечении срока анонимизируются персональные поля: `client_name`, `client_phone`, `client_email` (подстановка нейтрального значения или NULL в зависимости от политики). Остальные данные брони (даты, услуги, суммы, статусы) сохраняются для отчётности.
- **Реализация:** Функция БД `anonymize_old_bookings_pii(p_older_than_days)`, вызов из cron с `p_older_than_days = 2555` (7 лет).

### 2.5. Смены (`staff_shifts`, `staff_shift_items`)

- **Срок:** 7 лет. Удаление записей не выполняется; при необходимости срок может быть зафиксирован нормами учёта юрисдикции.
- **Анонимизация:** В позициях смены (`staff_shift_items`) может храниться `client_name`; при желании его можно анонимизировать по тому же принципу, что и в бронях (отдельная задача или расширение `anonymize_old_bookings_pii`).

### 2.6. Профили клиентов (`profiles`)

- **Срок:** 3 года с момента последней активности (например, последняя бронь с участием данного пользователя).
- **Действие:** Для профилей, которые не являются сотрудниками (`staff.user_id`) и не имели связанных броней за последние 3 года, анонимизируются поля `full_name` и `phone`.
- **Реализация:** Функция БД `anonymize_inactive_profiles_pii(p_inactive_days)`, вызов из cron с `p_inactive_days = 1095` (3 года).

## 3. Cron-задачи

Единая задача **Data Retention** выполняется по расписанию (рекомендуется раз в сутки, в малозагруженное время) и вызывает:

1. `cleanup_old_api_metrics(90)` — очистка старых API-метрик.
2. `cleanup_old_finance_logs(365)` — очистка старых логов финансовых операций.
3. `cleanup_old_funnel_events(400)` — удаление старых событий воронки.
4. `anonymize_old_bookings_pii(2555)` — анонимизация PII в бронях старше 7 лет.
5. `anonymize_inactive_profiles_pii(1095)` — анонимизация PII в неактивных профилях (3 года без активности).

Эндпоинт: `GET /api/cron/data-retention`. Защита: заголовок `Authorization: Bearer <CRON_SECRET>` (тот же секрет, что и для остальных cron-задач).

## 4. Изменение сроков

При необходимости изменить сроки достаточно:

- Обновить данный документ.
- Передавать в вызовы функций БД новые значения `p_keep_days` / `p_older_than_days` / `p_inactive_days` из кода cron (или конфигурации), без обязательного изменения сигнатур функций.

## 5. Связанные документы

- [MONITORING_AND_ANALYTICS.md](./MONITORING_AND_ANALYTICS.md) — рекомендации по хранению метрик и логов.
- [EVOLUTION_TECH_PLAN.md](./EVOLUTION_TECH_PLAN.md) — задача 6.1.1 (DATA_RETENTION).
