# üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram

## üéØ –¶–µ–ª—å
–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram Login Widget (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Google OAuth, –Ω–æ –¥–ª—è Telegram).

---

## üìù –ü–û–î–ì–û–¢–û–í–ö–ê

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Telegram Bot

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ **@BotFather**
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º:
   - –í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Kezek Auth Bot")
   - –í–≤–µ–¥–∏—Ç–µ username –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `kezek_auth_bot`)
4. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ Bot Token** ‚Äî –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–∑–∂–µ (—Ñ–æ—Ä–º–∞—Ç: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–º–µ–Ω –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞:
   ```
   /setdomain
   ```
   - –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
   - –í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω: `kezek.kg` (–∏–ª–∏ –≤–∞—à –¥–æ–º–µ–Ω)

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ Bot Token

Bot Token –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:
```
1234567890:ABCdefGHIjklMNOpqrsTUVwxyz1234567890
```

**–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

---

## üîß –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env.local` (–∏–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞):

```env
# Telegram Bot –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
TELEGRAM_BOT_TOKEN=–≤–∞—à_bot_token_–æ—Ç_BotFather
```

**–ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å:**
- –õ–æ–∫–∞–ª—å–Ω–æ: `apps/web/.env.local`
- –ù–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Vercel, Railway, etc.)

---

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ Telegram

**–§–∞–π–ª:** `apps/web/src/lib/telegram/verify.ts`

```typescript
import crypto from 'crypto';

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram Login Widget
 * –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://core.telegram.org/widgets/login#checking-authorization
 */
export function verifyTelegramAuth(data: {
    id: number;
    first_name?: string;
    last_name?: string;
    username?: string;
    photo_url?: string;
    auth_date: number;
    hash: string;
}): boolean {
    if (!TELEGRAM_BOT_TOKEN) {
        console.error('[Telegram] TELEGRAM_BOT_TOKEN not configured');
        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
    const authDate = data.auth_date;
    const now = Math.floor(Date.now() / 1000);
    if (now - authDate > 86400) {
        console.warn('[Telegram] Auth data expired');
        return false;
    }

    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const checkString = Object.keys(data)
        .filter(key => key !== 'hash')
        .sort()
        .map(key => `${key}=${data[key as keyof typeof data]}`)
        .join('\n');

    // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ Bot Token
    const secretKey = crypto
        .createHash('sha256')
        .update(TELEGRAM_BOT_TOKEN)
        .digest();

    // –í—ã—á–∏—Å–ª—è–µ–º HMAC
    const hmac = crypto
        .createHmac('sha256', secretKey)
        .update(checkString)
        .digest('hex');

    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º hash
    return hmac === data.hash;
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
 */
export function normalizeTelegramData(data: {
    id: number;
    first_name?: string;
    last_name?: string;
    username?: string;
    photo_url?: string;
}): {
    telegram_id: number;
    full_name: string | null;
    telegram_username: string | null;
    telegram_photo_url: string | null;
} {
    const fullName = [data.first_name, data.last_name]
        .filter(Boolean)
        .join(' ')
        .trim() || null;

    return {
        telegram_id: data.id,
        full_name: fullName,
        telegram_username: data.username || null,
        telegram_photo_url: data.photo_url || null,
    };
}
```

---

### –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ API endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `apps/web/src/app/api/auth/telegram/login/route.ts`

```typescript
import crypto from 'crypto';

import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

import { verifyTelegramAuth, normalizeTelegramData } from '@/lib/telegram/verify';

export const dynamic = 'force-dynamic';

type TelegramAuthData = {
    id: number;
    first_name?: string;
    last_name?: string;
    username?: string;
    photo_url?: string;
    auth_date: number;
    hash: string;
};

/**
 * POST /api/auth/telegram/login
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram Login Widget
 */
export async function POST(req: Request) {
    try {
        const URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
        const SERVICE = process.env.SUPABASE_SERVICE_ROLE_KEY!;

        const body = await req.json();
        const telegramData = body as TelegramAuthData;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if (!telegramData.id || !telegramData.hash || !telegramData.auth_date) {
            return NextResponse.json(
                { ok: false, error: 'missing_data', message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram' },
                { status: 400 }
            );
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
        if (!verifyTelegramAuth(telegramData)) {
            return NextResponse.json(
                { ok: false, error: 'invalid_signature', message: '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö' },
                { status: 400 }
            );
        }

        const admin = createClient(URL, SERVICE);
        const normalized = normalizeTelegramData(telegramData);

        // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
        const { data: profiles } = await admin
            .from('profiles')
            .select('id, telegram_id')
            .eq('telegram_id', normalized.telegram_id)
            .limit(1);

        let userId: string;

        if (profiles && profiles.length > 0) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            userId = profiles[0].id;
            await admin
                .from('profiles')
                .update({
                    full_name: normalized.full_name,
                    telegram_username: normalized.telegram_username,
                    telegram_photo_url: normalized.telegram_photo_url,
                    telegram_verified: true,
                    updated_at: new Date().toISOString(),
                })
                .eq('id', userId);
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º telegram_id –∫–∞–∫ –æ—Å–Ω–æ–≤—É –¥–ª—è email (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
            const tempEmail = `telegram_${normalized.telegram_id}@telegram.local`;
            const tempPassword = crypto.randomBytes(32).toString('hex');

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase Auth
            const { data: authUser, error: authError } = await admin.auth.admin.createUser({
                email: tempEmail,
                password: tempPassword,
                email_confirm: true,
                user_metadata: {
                    telegram_id: normalized.telegram_id,
                    telegram_username: normalized.telegram_username,
                    auth_provider: 'telegram',
                },
            });

            if (authError || !authUser.user) {
                console.error('[telegram/login] Auth error:', authError);
                return NextResponse.json(
                    { ok: false, error: 'auth_error', message: authError?.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' },
                    { status: 500 }
                );
            }

            userId = authUser.user.id;

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            const { error: profileError } = await admin
                .from('profiles')
                .insert({
                    id: userId,
                    full_name: normalized.full_name,
                    telegram_id: normalized.telegram_id,
                    telegram_username: normalized.telegram_username,
                    telegram_photo_url: normalized.telegram_photo_url,
                    telegram_verified: true,
                });

            if (profileError) {
                console.error('[telegram/login] Profile error:', profileError);
                // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Ñ–∏–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –ø–æ–∑–∂–µ
            }
        }

        // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ WhatsApp)
        const tempPassword = crypto.randomBytes(16).toString('hex');
        const tempEmail = `telegram_${normalized.telegram_id}@telegram.local`;

        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å email
        const { data: currentUser } = await admin.auth.admin.getUserById(userId);
        if (!currentUser?.user?.email) {
            await admin.auth.admin.updateUserById(userId, {
                email: tempEmail,
                email_confirm: true,
            });
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
        const { error: passwordError } = await admin.auth.admin.updateUserById(userId, {
            password: tempPassword,
        });

        if (passwordError) {
            console.error('[telegram/login] Password error:', passwordError);
            return NextResponse.json(
                { ok: false, error: 'session_error', message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é' },
                { status: 500 }
            );
        }

        return NextResponse.json({
            ok: true,
            userId,
            email: currentUser?.user?.email || tempEmail,
            password: tempPassword,
            needsSignIn: true,
            redirect: '/',
        });
    } catch (e) {
        const msg = e instanceof Error ? e.message : String(e);
        console.error('[telegram/login] error:', e);
        return NextResponse.json(
            { ok: false, error: 'internal', message: msg },
            { status: 500 }
        );
    }
}
```

**–í–∞–∂–Ω–æ:** –î–æ–±–∞–≤—å—Ç–µ –∏–º–ø–æ—Ä—Ç `crypto` –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:
```typescript
import crypto from 'crypto';
```

---

### –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π Telegram –≤ —Ç–∞–±–ª–∏—Ü—É profiles

**–§–∞–π–ª:** `supabase/migrations/XXXXXX_add_telegram_fields.sql`

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS telegram_id BIGINT UNIQUE,
ADD COLUMN IF NOT EXISTS telegram_username TEXT,
ADD COLUMN IF NOT EXISTS telegram_photo_url TEXT,
ADD COLUMN IF NOT EXISTS telegram_verified BOOLEAN DEFAULT FALSE;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ telegram_id
CREATE INDEX IF NOT EXISTS idx_profiles_telegram_id ON profiles(telegram_id);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN profiles.telegram_id IS 'Telegram User ID';
COMMENT ON COLUMN profiles.telegram_username IS 'Telegram username (–±–µ–∑ @)';
COMMENT ON COLUMN profiles.telegram_photo_url IS 'URL –∞–≤–∞—Ç–∞—Ä–∞ –∏–∑ Telegram';
COMMENT ON COLUMN profiles.telegram_verified IS '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç';
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
# –ß–µ—Ä–µ–∑ Supabase CLI
supabase db push

# –ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard
# SQL Editor ‚Üí –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å
```

---

### –®–∞–≥ 7: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Telegram Login Widget

**–§–∞–π–ª:** `apps/web/src/components/auth/TelegramLoginWidget.tsx`

```typescript
'use client';

import { useEffect, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';

// ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ username –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–±–µ–∑ @)
// –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±–æ—Ç @kezek_auth_bot, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'kezek_auth_bot'
const TELEGRAM_BOT_USERNAME = 'kezek_auth_bot';

interface TelegramLoginWidgetProps {
    redirectTo?: string;
    onSuccess?: () => void;
    onError?: (error: string) => void;
    size?: 'large' | 'medium' | 'small';
    cornerRadius?: number;
    requestAccess?: 'write' | 'read';
}

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Telegram Login Widget
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç –æ—Ç Telegram
 * –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://core.telegram.org/widgets/login
 */
export function TelegramLoginWidget({ 
    redirectTo = '/', 
    onSuccess,
    onError,
    size = 'large',
    cornerRadius,
    requestAccess = 'write',
}: TelegramLoginWidgetProps) {
    const router = useRouter();
    const containerRef = useRef<HTMLDivElement>(null);
    const [loading, setLoading] = useState(false);
    const callbackName = `onTelegramAuth_${Math.random().toString(36).substring(7)}`;

    useEffect(() => {
        if (!containerRef.current) return;

        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤–∏–¥–∂–µ—Ç–∞
        containerRef.current.innerHTML = '';

        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é callback —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≤–∏–¥–∂–µ—Ç–∞
        (window as any)[callbackName] = async (user: {
            id: number;
            first_name?: string;
            last_name?: string;
            username?: string;
            photo_url?: string;
            auth_date: number;
            hash: string;
        }) => {
            setLoading(true);
            try {
                console.log('[TelegramLoginWidget] Received auth data:', { 
                    id: user.id, 
                    username: user.username,
                    hasHash: !!user.hash 
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/api/auth/telegram/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user),
                });

                const data = await response.json();

                if (!data.ok) {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }

                console.log('[TelegramLoginWidget] Server response:', { 
                    ok: data.ok, 
                    userId: data.userId,
                    needsSignIn: data.needsSignIn 
                });

                // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ —Å email –∏ –ø–∞—Ä–æ–ª–µ–º
                if (data.needsSignIn && data.email && data.password) {
                    const { supabase } = await import('@/lib/supabaseClient');
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: data.email,
                        password: data.password,
                    });

                    if (signInError) {
                        throw new Error(signInError.message);
                    }

                    console.log('[TelegramLoginWidget] Signed in successfully');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookies
                    router.refresh();
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                onSuccess?.();
                router.push(redirectTo);
            } catch (error) {
                const errorMsg = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error('[TelegramLoginWidget] Error:', errorMsg);
                onError?.(errorMsg);
            } finally {
                setLoading(false);
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º Telegram Widget —Å–∫—Ä–∏–ø—Ç
        const script = document.createElement('script');
        script.src = 'https://telegram.org/js/telegram-widget.js?22';
        script.setAttribute('data-telegram-login', TELEGRAM_BOT_USERNAME);
        script.setAttribute('data-size', size);
        script.setAttribute('data-onauth', `${callbackName}(user)`);
        script.setAttribute('data-request-access', requestAccess);
        
        if (cornerRadius !== undefined) {
            script.setAttribute('data-radius', cornerRadius.toString());
        }
        
        script.async = true;

        containerRef.current.appendChild(script);

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        return () => {
            if (containerRef.current) {
                containerRef.current.innerHTML = '';
            }
            // –£–¥–∞–ª—è–µ–º callback –∏–∑ window
            delete (window as any)[callbackName];
        };
    }, [redirectTo, onSuccess, onError, size, cornerRadius, requestAccess, callbackName, router]);

    return (
        <div className="relative">
            {loading && (
                <div className="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-gray-900/80 rounded-lg z-10">
                    <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                        <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...
                    </div>
                </div>
            )}
            <div ref={containerRef} className="flex justify-center" />
        </div>
    );
}
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –í–∏–¥–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫—É Telegram (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å)
- –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
- –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è callback —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è

---

### –®–∞–≥ 8: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Telegram –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞

**–§–∞–π–ª:** `apps/web/src/app/auth/sign-in/SignInPage.tsx`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google" –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ –Ω–µ—ë:

```typescript
import { TelegramLoginWidget } from '@/components/auth/TelegramLoginWidget';

// –í —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ Google:
<TelegramLoginWidget
    redirectTo={redirectParam || '/'}
    onSuccess={() => {
        console.log('Telegram auth successful');
    }}
    onError={(error) => {
        setError(error);
    }}
    size="large"
/>
```

**–ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –±–ª–æ–∫–∞ –∫–Ω–æ–ø–æ–∫:**

```typescript
<div className="space-y-3">
    {/* Email –≤—Ö–æ–¥ */}
    <form onSubmit={sendOtp} className="space-y-4">
        {/* ... —Ñ–æ—Ä–º–∞ email ... */}
    </form>

    <div className="relative">
        <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300 dark:border-gray-700"></div>
        </div>
        <div className="relative flex justify-center text-sm">
            <span className="px-2 bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400">
                –∏–ª–∏
            </span>
        </div>
    </div>

    {/* OAuth –∫–Ω–æ–ø–∫–∏ */}
    <div className="space-y-3">
        <button
            type="button"
            onClick={signInWithGoogle}
            disabled={sending}
            className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-50"
        >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
                {/* SVG –∏–∫–æ–Ω–∫–∞ Google */}
            </svg>
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google
        </button>

        <TelegramLoginWidget
            redirectTo={redirectParam || '/'}
            onError={(error) => setError(error)}
            size="large"
        />

        <Link
            href="/auth/whatsapp"
            className="w-full inline-flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
        >
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                {/* SVG –∏–∫–æ–Ω–∫–∞ WhatsApp */}
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ WhatsApp
        </Link>
    </div>
</div>
```

---

### –®–∞–≥ 9: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Telegram –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `apps/web/src/app/auth/sign-up/page.tsx`

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É Telegram –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ Google.

---

### –®–∞–≥ 10: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ TypeScript (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `apps/web/src/types/profile.ts` (–µ—Å–ª–∏ –µ—Å—Ç—å)

–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—è Telegram:

```typescript
export interface Profile {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    telegram_id?: number | null;
    telegram_username?: string | null;
    telegram_photo_url?: string | null;
    telegram_verified?: boolean | null;
}
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –®–∞–≥ 11: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   cd apps/web
   npm run dev
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞:**
   ```
   http://localhost:3000/auth/sign-in
   ```

3. **–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"**

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–∏–¥–∂–µ—Ç Telegram
   - –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
   - –°–µ—Å—Å–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –®–∞–≥ 12: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

1. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:**
   - `TELEGRAM_BOT_TOKEN` –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –î–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ BotFather (`/setdomain`)
   - –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –ë–î

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `https://kezek.kg/auth/sign-in`
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram

---

## üîç –û–¢–õ–ê–î–ö–ê

### –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**1. "Invalid signature"**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `TELEGRAM_BOT_TOKEN` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–æ—Ç—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–æ–º–µ–Ω

**2. "Auth data expired"**
- –î–∞–Ω–Ω—ã–µ –æ—Ç Telegram –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 24 —á–∞—Å–∞
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ

**3. –í–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ BotFather
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π username –±–æ—Ç–∞

**4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ `profiles`

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–°–£–†–°–´

- [Telegram Login Widget –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://core.telegram.org/widgets/login)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏](https://core.telegram.org/widgets/login#checking-authorization)

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢

- [ ] –°–æ–∑–¥–∞–Ω Telegram Bot —á–µ—Ä–µ–∑ @BotFather
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –¥–æ–º–µ–Ω –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
- [ ] –î–æ–±–∞–≤–ª–µ–Ω `TELEGRAM_BOT_TOKEN` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `lib/telegram/verify.ts`
- [ ] –°–æ–∑–¥–∞–Ω API endpoint `/api/auth/telegram/login`
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–µ–π Telegram
- [ ] –°–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `TelegramLoginWidget`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Telegram. üéâ

