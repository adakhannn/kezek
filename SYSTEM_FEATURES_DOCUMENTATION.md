# Kezek — Документация функциональностей системы

## Общая информация

**Kezek** — это CRM-система для управления бизнесом в сфере услуг (салоны красоты, барбершопы, студии и т.д.). Система позволяет бизнесам управлять записями клиентов, сотрудниками, филиалами, финансами и аналитикой.

---

## 1. Управление бизнесом (Dashboard для владельцев/админов/менеджеров)

### 1.1 Управление филиалами
- **Создание филиалов**: добавление новых филиалов с адресом, координатами (через Яндекс.Карты), телефонами
- **Редактирование филиалов**: изменение всех параметров филиала
- **Активация/деактивация**: возможность скрыть филиал без удаления
- **Рабочие часы филиала**: настройка расписания работы для каждого дня недели и специальных дат
- **Рейтинг филиала**: автоматический расчет рейтинга на основе метрик сотрудников

### 1.2 Управление сотрудниками
- **Добавление сотрудников**: создание профилей с именем, email, телефоном, фото
- **Назначение на филиалы**: привязка сотрудника к одному или нескольким филиалам
- **Настройка услуг**: привязка услуг, которые может выполнять сотрудник
- **Финансовые настройки**:
  - Процент от выручки (мастер/салон)
  - Почасовая ставка (для гарантированной оплаты)
- **Активация/деактивация**: увольнение/восстановление сотрудников
- **Рейтинг сотрудника**: автоматический расчет на основе отзывов, продуктивности, возвращаемости клиентов, дисциплины

### 1.3 Управление услугами
- **Создание услуг**: добавление услуг с названием (RU/KY/EN), длительностью, ценой (от/до)
- **Привязка к филиалам**: услуга может быть доступна в определенных филиалах
- **Привязка к сотрудникам**: услуга может выполняться определенными сотрудниками
- **Активация/деактивация**: скрытие услуг без удаления

### 1.4 Управление записями (Bookings)
- **Календарь записей**: просмотр всех записей по дням, сотрудникам, филиалам
- **Статусы записей**:
  - `hold` — ожидает подтверждения
  - `confirmed` — подтверждена
  - `paid` — выполнена (клиент пришел)
  - `cancelled` — отменена
  - `no_show` — клиент не пришел
- **Подтверждение/отмена**: ручное управление статусами записей
- **Фильтрация**: по филиалам, сотрудникам, статусам, датам

### 1.5 Финансовая система

#### 1.5.1 Смены сотрудников
- **Открытие смены**: сотрудник открывает смену в начале рабочего дня
- **Добавление клиентов**: во время смены сотрудник добавляет клиентов с услугами и суммами
- **Расходники**: учет расходных материалов по каждому клиенту
- **Закрытие смены**: сотрудник закрывает смену в конце дня
- **Автоматическое закрытие**: cron job закрывает незакрытые смены в полночь

#### 1.5.2 Расчет финансов
- **Оборот**: общая сумма услуг за период
- **Доля сотрудника**: процент от выручки (настраивается индивидуально)
- **Доля бизнеса**: остаток после выплаты сотруднику + 100% расходников
- **Гарантированная оплата**: если почасовая ставка × отработанные часы > доля от выручки, сотрудник получает гарантированную сумму
- **Доплата за выход**: разница между гарантированной суммой и базовой долей выплачивается бизнесом
- **Опоздания**: учет времени опозданий сотрудников

#### 1.5.3 Точные формулы расчета смены

- **Базовые значения (по факту смены)**  
  - `total_amount` — сумма всех `service_amount` по `staff_shift_items` (если позиции есть) или сумма по бронированиям/ручному вводу.  
  - `consumables_amount` — сумма всех `consumables_amount` по `staff_shift_items` или вручную заданная сумма расходников.  
  - `percent_master`, `percent_salon` — проценты мастера и салона из настроек сотрудника или смены.  
  - Перед расчетом проценты **нормализуются** так, чтобы сумма была 100%:
    - `normalized_master = percent_master / (percent_master + percent_salon) * 100`
    - `normalized_salon = percent_salon / (percent_master + percent_salon) * 100`

- **Базовые доли (без гарантии)**  
  - `base_master_share = round(total_amount * normalized_master / 100)`  
  - `salon_share_from_amount = round(total_amount * normalized_salon / 100)`  
  - `salon_share = salon_share_from_amount + consumables_amount` (расходники всегда 100% в пользу салона).

- **Часы и гарантия**  
  - `hourly_rate` берется из `staff.hourly_rate` (и дублируется в `staff_shifts.hourly_rate` при закрытии).  
  - `hours_worked`:
    - При **ручном закрытии смены** (`/api/staff/shift/close`) считается как разница между `opened_at` и текущим временем `now` в TZ.  
    - При **авто‑закрытии cron’ом** (`/api/cron/close-shifts`) считается как разница между `opened_at` и полуночью следующего дня (`midnight_next_day` в TZ).  
  - `guaranteed_amount = round(hours_worked * hourly_rate, 2)` (если ставка задана, иначе 0).  
  - `topup_amount = max(0, guaranteed_amount - base_master_share)` — сколько доплачивает бизнес до гарантии.

- **Финальные значения, которые пишутся в смену**  
  - `master_share`:
    - если `guaranteed_amount > base_master_share` → `master_share = guaranteed_amount`  
    - иначе → `master_share = base_master_share`  
  - `salon_share`:
    - сначала считается как `salon_share_from_amount + consumables_amount`,  
    - затем корректируется: `salon_share = max(0, salon_share - topup_amount)` (бизнес платит доплату за выход из своей доли, но она не может уйти в минус).  
  - В таблице `staff_shifts` сохраняются: `total_amount`, `consumables_amount`, `percent_master`, `percent_salon`, `master_share`, `salon_share`, `hours_worked`, `hourly_rate`, `guaranteed_amount`, `topup_amount`, `closed_at`, `status = 'closed'`.

#### 1.5.4 Режимы оплаты смены (payment modes)

Логика расчёта смены сейчас фактически использует схему **«процент + гарантия»**, но `financeDomain` заранее поддерживает режимы (`PaymentMode`):

- `percent_only` — только процент от выручки, без учета гарантии (игнорируются `hours_worked`/`hourly_rate`);
- `percent_with_guarantee` — процент + гарантия (текущий режим, описанный выше);
- `fixed_per_shift` — фиксированная сумма за смену (зарезервировано на будущее);
- `custom` — смешанные/кастомные схемы (зарезервировано).

В коде режим передаётся параметром `paymentMode` в `calculateShiftFinancials` (`apps/web/src/lib/financeDomain/shift.ts`). При отсутствии значения используется `percent_with_guarantee` (обратная совместимость).

#### 1.5.5 Особенности отображения на дашборде владельца

- Для **закрытых смен** на странице владельца всегда показываются сохранённые в БД значения (`master_share`, `salon_share`, `guaranteed_amount`, `topup_amount`, `hours_worked`).  
- Для **открытых смен**:
  - Оборот и суммы считаются **динамически** на основе текущих `staff_shift_items` и текущего времени.  
  - Для гарантии используется `hourly_rate` из смены, а если он `NULL` — из профиля сотрудника.  
  - В статистике дополнительно считаются:
    - `totalBaseMasterShare` — суммарная базовая доля без учета гарантии,
    - `totalGuaranteedAmount` — суммарная потенциальная гарантия по открытым сменам,
    - `hasGuaranteedPayment` — флаг, что гарантия уже превышает базовую долю и влияет на расчет.

#### 1.5.4 Граничные кейсы смен и гарантий

- **Длинные смены / забыли закрыть**  
  - Смена считается открытой, пока у неё `status = 'open'`.  
  - Авто‑закрытие (`/api/cron/close-shifts`): для вчерашних открытых смен `hours_worked` считается от `opened_at` до полуночи следующего дня в TZ бизнеса. Это ограничивает “автосмену” рамками одного дня, даже если сотрудник не нажал кнопку.  
  - Ручное закрытие (`/api/staff/shift/close`): `hours_worked` считается от `opened_at` до фактического времени закрытия. Если из‑за забывчивости получилось аномально много часов, владелец должен скорректировать их вручную (см. ниже).

- **Ручные правки `hours_worked` + гарантия**  
  - Через API `/api/dashboard/staff-shifts/[id]/update-hours` владелец может изменить `hours_worked` только для уже закрытой смены.  
  - При этом автоматически пересчитываются:
    - `guaranteed_amount = round(hours_worked * hourly_rate, 2)`,  
    - `topup_amount` (разница между гарантией и базовой долей),  
    - `master_share` (максимум из базовой доли и гарантии),  
    - `salon_share` (корректируется так, чтобы не уйти в минус после доплаты за выход).  
  - В результате все суммы в смене остаются согласованными с формулами из раздела 1.5.3.

- **Изменения ставок и расписания “задним числом”**  
  - В закрытой смене сохраняется собственная копия настроек на момент закрытия:
    - `percent_master`, `percent_salon`,  
    - `hourly_rate`.  
  - Если позже изменить проценты или ставку в профиле сотрудника, уже закрытые смены **не пересчитываются** автоматически.  
  - Расписание (рабочие дни/часы) влияет только на будущее: старые смены и бронирования продолжают опираться на фактические даты/время, когда они были созданы и закрыты.

> Закрытая смена — это зафиксированный финансовый документ. Система не меняет её задним числом автоматически; любые корректировки владелец делает осознанно через инструменты правки.

#### 1.5.5 Финансовая аналитика
- **Статистика по сотрудникам**: оборот, доля сотрудника, доля бизнеса, количество клиентов, опоздания
- **Статистика по периодам**: день, месяц, год
- **Список клиентов**: детальный список всех клиентов по каждой смене
- **Корректировка часов**: владелец может вручную исправить `hours_worked` для закрытых смен (если сотрудник забыл закрыть смену)

#### 1.5.6 Возвраты и корректировки сумм

В финансовой модели смены важно различать:

- **исходные операции по клиентам** — продажи/услуги, которые попадают в `staff_shift_items` с **неотрицательными** суммами (`service_amount`, `consumables_amount`);
- **возвраты и корректировки** — действия, которые изменяют итоговую выручку смены задним числом (refund, скидка, списание), но не меняют оригинальный факт оказания услуги.

Требования:

- сохранять историю исходных операций (staff_shift_items) неизменной;
- уметь прозрачно объяснить, почему итоговая сумма за смену отличается от простой суммы всех продаж;
- иметь возможность анализировать возвраты/корректировки отдельно от продаж.

Модель (концептуально):

- `staff_shift_items`:
  - содержит только положительные суммы (`service_amount >= 0`, `consumables_amount >= 0`);
  - отражает «как было оказано» (клиент, услуга, сумма, расходники).
- **корректирующие операции** (будущий тип/таблица, условно `staff_shift_adjustments`):
  - привязаны к `shift_id` (и при необходимости `staff_shift_item_id`/`booking_id`);
  - могут содержать положительные или отрицательные величины `service_delta`, `consumables_delta`;
  - имеют `kind` (`refund_service`, `refund_consumables`, `manual_correction` и т.п.) и `reason` для аудита.

При расчёте итоговой выручки смены домен `financeDomain` должен уметь:

- считать базовые суммы по `staff_shift_items` (`total_amount`, `consumables_amount`);
- применять поверх них корректировки (сумму всех `*_delta` по смене) и использовать уже скорректированные значения в формулах `calculateShiftFinancials`.

Техническая реализация корректировок (таблица, поля, интеграция в API/интерфейс) описывается и развивается на основе плана в `FINANCE_DOMAIN_TASKS.md` (раздел 2 «Возвраты и корректировки»).

#### 1.5.6 Правило при добавлении новых типов выплат или формул

При добавлении новых типов выплат или изменении формул расчёта необходимо:

1. **Зафиксировать в этом документе** — обновить раздел 1.5 (при необходимости подразделы 1.5.2–1.5.4): описание типа выплаты, формулы, граничные случаи.
2. **Реализовать и задокументировать в коде** — в модуле `apps/web/src/lib/financeDomain/`: добавить или изменить функции, обновить `README.md` в financeDomain (описание функции, примеры, логика).
3. **Добавить или обновить unit-тесты** — в `apps/web/src/__tests__/lib/financeDomain/` для новых или изменённых формул.

См. также `apps/web/src/lib/financeDomain/README.md`, раздел «При добавлении новых типов выплат или формул».

### 1.6 Система рейтингов

#### 1.6.1 Рейтинг сотрудников
- **Факторы**:
  - Отзывы клиентов (35% по умолчанию, настраивается суперадмином)
  - Продуктивность — количество клиентов (25%)
  - Возвращаемость клиентов (20%)
  - Дисциплина — опоздания (20%)
- **Расчет**: ежедневные метрики, агрегированные за 30 дней (настраивается)
- **Отображение**: публично на странице бизнеса, сортировка от лучшего к худшему

#### 1.6.2 Рейтинг филиалов
- **Расчет**: средний рейтинг сотрудников филиала
- **Отображение**: публично на странице бизнеса

#### 1.6.3 Рейтинг бизнесов
- **Расчет**: средний рейтинг филиалов бизнеса
- **Отображение**: публично на главной странице, сортировка от лучшего к худшему

#### 1.6.4 Настройка весов рейтинга
- **Доступ**: только суперадмин
- **Настройки**: веса компонентов рейтинга сотрудника (сумма должна быть 100%)
- **Период расчета**: количество дней для скользящего среднего (по умолчанию 30)

#### 1.6.5 Семантика значения рейтинга (rating_score)

В полях `rating_score` (таблицы `staff`, `branches`, `businesses`) используются следующие значения:

- **`NULL`** — рейтинг ещё ни разу не рассчитывался (новая сущность или рейтинги не инициализированы). В UI и отчётах трактуется как «нет данных».
- **`50.0`** — стартовый/дефолтный рейтинг: выставляется при инициализации и когда в расчётном окне нет ни одного дня с активностью (сохраняется последний известный рейтинг или 50.0).
- **Диапазон `0.0`–`100.0`** — рассчитанный рейтинг по метрикам. `0` — минимальный (очень плохие показатели), `100` — максимальный. Значение `0` считается валидным рейтингом, а не признаком «нет рейтинга».

При отображении и в логике (health-check, инициализация) «отсутствие рейтинга» определяется по `IS NULL`, а не по равенству нулю.

#### 1.6.6 Долгосрочное здоровье рейтингов

**Стратегия обработки периодов без активности:**

1. **Периоды без метрик (каникулы, простой, неактивность):**
   - День считается **активным для сотрудника**, если за него есть хотя бы одно из:
     - подтверждённая/оплаченная запись (клиент),
     - смена (`staff_shifts`) за этот день,
     - отзыв по бронированию этого дня.
   - Для неактивных дней (нет смен, нет клиентов, нет отзывов) дневные метрики **не создаются** в `staff_day_metrics`, а значит, не попадают и в агрегированные метрики филиалов/бизнесов.
   - `branch_day_metrics` создаётся только для дней, когда есть хотя бы одна метрика сотрудника (`staff_day_metrics`) по этому филиалу; `biz_day_metrics` — только для дней, когда есть хотя бы одна метрика филиала (`branch_day_metrics`) по этому бизнесу.
   - При расчете агрегированного рейтинга используется **только среднее по дням с активностью** в пределах окна (30 дней по умолчанию).
   - Если в окне нет ни одного дня с активностью, используется последний известный рейтинг или дефолтный рейтинг `50.0` (см. раздел про семантику `rating_score`).
   - **Справедливость**: рейтинг не падает из-за выходных, отпусков или каникул — учитываются только рабочие дни с реальной активностью.

2. **Долгие паузы в работе:**
   - Если в расчётном окне (30 дней по умолчанию) нет ни одного дня с активностью, система **не обнуляет** рейтинг: сохраняется последний рассчитанный рейтинг или дефолтный `50.0` (см. семантику `rating_score`).
   - При возобновлении работы рейтинг пересчитывается по новым метрикам в рамках обычного cron-задания.
   - **Рекомендация**: при очень долгих паузах (например, более 60 дней) при необходимости можно вручную запустить пересчёт через админ-панель или дождаться накопления новых метрик.

3. **Изменение конфигурации весов:**
   - При изменении весов в `rating_global_config` создается новая запись с `is_active = true` и `valid_from = now()`
   - **Старые метрики не пересчитываются** — они остаются с теми весами, которые были актуальны на момент расчета
   - Новые метрики рассчитываются с новыми весами
   - Агрегированный рейтинг учитывает метрики с разными весами (если окно расчета пересекает момент изменения конфигурации)
   - **Миграция**: если требуется полный пересчет исторических данных с новыми весами, используется функция `recalculate_ratings_for_date_range(start_date, end_date)` через админ-панель

4. **Инициализация рейтингов:**
   - При первом запуске системы или добавлении нового бизнеса/филиала/сотрудника для записей без рейтинга (`rating_score IS NULL`) устанавливается стартовый рейтинг `50.0`
   - Если есть исторические данные, выполняется пересчёт метрик за последние N дней (по умолчанию 30) через функцию `initialize_all_ratings(days_back)`
   - Если после пересчёта рейтинг не удалось рассчитать (остаётся `NULL`), выставляется дефолтный `50.0`; рассчитанное значение `0` считается валидным и не заменяется

5. **Рекомендации для владельцев:**
   - Регулярно проверяйте рейтинги через админ-панель `/admin/ratings-status`
   - При паузах (отпуск, ремонт) рейтинг не снижается из‑за отсутствия активности: сохраняется последнее значение или 50.0; после возобновления работы он пересчитывается по новым метрикам в рамках окна (30 дней)
   - При необходимости можно вручную запустить пересчёт рейтингов через админ-панель

#### 1.6.7 Сценарий смены весов и пересчёта истории

При изменении весов рейтинга или периода расчёта (окно в днях) имеет смысл пересчитать исторические метрики и агрегированные рейтинги по новой конфигурации. Ниже описан поддерживаемый сценарий.

1. **Где менять настройки**
   - Страница **`/admin/rating-config`** (доступна только суперадмину): веса компонентов (отзывы, продуктивность, возвращаемость, дисциплина), период расчёта в днях. После нажатия «Сохранить настройки» новая запись в `rating_global_config` создаётся с `is_active = true`, старая деактивируется.

2. **UX после сохранения**
   - Если суперадмин изменил хотя бы один параметр (веса или период), после успешного сохранения показывается вопрос: **«Вы изменили веса. Хотите пересчитать историю за последние N дней?»** с выбором N (7, 14, 30, 60, 90) и кнопками «Пересчитать» и «Пропустить».
   - **Пересчитать** — вызывается пересчёт за выбранное количество дней (см. ниже). После успешного завершения страница обновляется.
   - **Пропустить** — страница просто обновляется; новые метрики будут считаться по новым весам, старые останутся без изменений (как в п. 3 раздела 1.6.6).

3. **Способы запуска пересчёта**
   - **Отдельный эндпоинт**: `POST /api/admin/initialize-ratings` с телом `{ "days_back": N }` (N от 1 до 365). Пересчитывает дневные метрики и агрегированные рейтинги за последние N дней. Используется кнопкой «Пересчитать» на странице настроек и при ручном/скриптовом запуске.
   - **В одном запросе с сохранением конфига**: `POST /admin/api/rating-config` принимает опциональные поля `recalculate_history: true` и `recalculate_days_back: N` (1–365). Если конфиг успешно сохранён и оба параметра заданы, сразу вызывается пересчёт за N дней. Удобно для скриптов или сценария «сохранить и пересчитать» одним действием. В ответе возвращаются `recalculate_triggered` и при ошибке пересчёта — `recalculate_error`.

4. **Что делает пересчёт**
   - Функция `initialize_all_ratings(p_days_back)` (или эквивалентный вызов) пересчитывает дневные метрики (`staff_day_metrics`, затем `branch_day_metrics`, `biz_day_metrics`) за указанный период с **текущей** активной конфигурацией весов и обновляет агрегированные поля `rating_score` у сотрудников, филиалов и бизнесов. Для больших объёмов данных рекомендуется запускать в период низкой нагрузки; при необходимости пересчёт можно разбить на батчи по диапазонам дат (см. документацию к миграциям и `APPLY_MIGRATIONS.md`).

### 1.7 Управление пользователями и ролями
- **Роли**:
  - `owner` — владелец бизнеса (полный доступ)
  - `admin` — администратор (полный доступ)
  - `manager` — менеджер (ограниченный доступ)
  - `super_admin` — суперадмин платформы
- **Назначение ролей**: владелец может назначать роли другим пользователям
- **Привязка к филиалам**: менеджеры могут быть привязаны к конкретным филиалам

---

## 2. Кабинет сотрудника (Staff Cabinet)

### 2.1 Управление сменами
- **Открытие смены**: начало рабочего дня
- **Добавление клиентов**: во время смены сотрудник добавляет клиентов с:
  - Именем клиента
  - Услугой
  - Суммой услуги
  - Расходниками
  - Примечаниями
- **Автосохранение**: данные сохраняются автоматически при добавлении
- **Закрытие смены**: завершение рабочего дня с финальным расчетом

### 2.2 Статистика
- **Текущая смена**: просмотр данных открытой смены
- **История смен**: просмотр всех закрытых смен
- **Финансовая статистика**: сколько заработал за период

### 2.3 Расписание
- **Просмотр записей**: календарь записей на сегодня и будущие дни
- **Статусы записей**: видит, какие записи подтверждены, какие ожидают подтверждения

---

## 3. Публичная часть (для клиентов)

### 3.1 Поиск и выбор бизнеса
- **Главная страница**: список всех одобренных бизнесов
- **Сортировка**: по рейтингу (от лучшего к худшему)
- **Поиск**: по названию, адресу
- **Фильтрация**: по категориям

### 3.2 Страница бизнеса
- **Информация**: название, адрес, телефоны, рейтинг
- **Филиалы**: список филиалов с рейтингами, сортировка по рейтингу
- **Сотрудники**: список сотрудников с рейтингами, сортировка по рейтингу
- **Услуги**: список доступных услуг

### 3.3 Бронирование
- **Выбор филиала**: клиент выбирает филиал
- **Выбор дня**: календарь с доступными датами
- **Выбор сотрудника**: список сотрудников с рейтингами
- **Выбор услуги**: список услуг сотрудника
- **Выбор времени**: доступные временные слоты на основе:
  - Рабочих часов филиала
  - Рабочих часов сотрудника
  - Уже существующих записей
  - Длительности услуги
- **Подтверждение**: создание записи со статусом `hold`, затем `confirmed` / `paid` в зависимости от сценария
- **Требование авторизации**: для стандартного бронирования необходимо войти или зарегистрироваться

#### 3.3.1 Поток стандартного бронирования (авторизованный клиент)

1. **Выбор параметров**  
   - Клиент на странице бизнеса (`/b/[slug]/booking`) по шагам выбирает:
     - филиал,  
     - день,  
     - мастера,  
     - услугу,  
     - свободный слот времени (через RPC `get_free_slots_service_day_v2`).  
   - При выборе учитываются:
     - базовое расписание филиала и мастера,  
     - временные переводы мастеров между филиалами,  
     - уже созданные записи (`hold/confirmed/paid`), чтобы не было пересечений.

2. **Создание бронирования**  
   - При выборе слота вызывается RPC `hold_slot`:
     - создаётся запись в таблице `bookings` со статусом `hold` и привязкой к `biz_id`, `branch_id`, `service_id`, `staff_id`, `client_id`.  
   - Сразу после этого вызывается RPC `confirm_booking`, который:
     - переводит запись в статус `confirmed` (подтверждена);  
     - может отправить уведомление (email / пуш, далее Telegram/WhatsApp).

3. **Фиксация факта посещения и промоакций**  
   - Когда клиент фактически приходит и оплачивает, администратор/мастер меняет статус на `paid` через `mark-attendance` / закрытие смены.  
   - При переводе в `paid` вызывается RPC `update_booking_status_with_promotion(p_booking_id, 'paid')`, который:
     - проверяет доступные акции для филиала и клиента,  
     - выбирает подходящую акцию (если есть),  
     - считает финальную сумму,  
     - сохраняет `promotion_applied` в JSON‑поле бронирования.

4. **Отображение**  
   - Клиент видит информацию о бронировании и примененной акции:
     - на странице подтверждения `/booking/[id]`,  
     - в личном кабинете (`/cabinet/bookings`) в карточках записей.

#### 3.3.2 Поток быстрой брони без регистрации (guest booking)

1. **Выбор параметров**  
   - Гость также проходит шаги выбора филиала/дня/мастера/услуги/слота на странице `/b/[slug]/booking`.  
   - При попытке забронировать без авторизации открывается модальное окно гостевой брони.

2. **Ввод данных гостя**  
   - Обязательные поля:
     - Имя (`client_name`),  
     - Телефон (`client_phone`).  
   - Необязательное поле:
     - Email (`client_email`).

3. **Создание гостевой записи**  
   - Фронтенд вызывает API `/api/quick-book-guest`, который в свою очередь вызывает RPC `hold_slot_guest`:
     - создаётся запись в `bookings` без `client_id`, но с `client_name`, `client_phone`, `client_email`,  
     - запись сразу создаётся в статусе `confirmed` или `hold` (в зависимости от бизнес‑логики RPC),  
     - далее запись может быть переведена в `paid` администратором или при закрытии смены.

4. **Дальнейшее поведение**  
   - Такие брони полностью участвуют в:
     - расчетах расписания и свободных слотов,  
     - финансовых расчетах смен,  
     - применении промоакций при переводе в статус `paid`.  
   - В дальнейшем гостя можно “привязать” к полноценному аккаунту (через телефон/email) — этот шаг планируется как отдельная функция.

### 3.4 Личный кабинет клиента
- **Мои записи**: список всех записей клиента
- **Статусы**: видит статус каждой записи
- **Отмена**: возможность отменить запись (если позволяет статус)
- **Отзывы**: возможность оставить отзыв после выполнения услуги
- **Редактирование отзывов**: возможность изменить свой отзыв

### 3.5 Система акций (промо) для клиентов

#### 3.5.1 Основные сущности и хранение

- **Определение акций**  
  - Таблица `branch_promotions` — список активных/архивных акций по филиалам.  
  - Ключевые поля:
    - `branch_id` — филиал, к которому относится акция,  
    - `promotion_type` — тип акции (`free_after_n_visits`, `referral_free`, `referral_discount_50`, `birthday_discount`, `first_visit_discount` и др.),  
    - `title_ru` — человекочитаемое название (может быть пустым, тогда на фронте берется локализованное название по типу),  
    - `params` — JSON с параметрами (`visit_count`, `discount_percent` и т.д.),  
    - `is_active` — флаг активности.  
- **Использование и ограничения**  
  - `client_promotion_usage` — сколько раз и когда клиент использовал конкретную акцию.  
  - `client_referrals` — связи приглашённый ↔ пригласивший для реферальных акций.  
- **Результат применения**  
  - В таблице `bookings` есть поле `promotion_applied jsonb`, куда записывается итог:
    - `promotion_type`,  
    - `promotion_title` (человекочитаемый заголовок),  
    - `discount_percent` (если применялась скидка),  
    - `final_amount` (расчитанная финальная сумма после промо),  
    - другие технические поля по необходимости.

#### 3.5.2 Типы акций и правила

- **Акция “каждая N‑я услуга бесплатно” (`free_after_n_visits`)**  
  - Параметры:
    - `visit_count` — число оплаченных визитов `N` (например, 7).  
  - Логика:
    - При переводе бронирования в статус `paid` вызывается RPC `update_booking_status_with_promotion`.  
    - Функция считает количество прошлых `paid` визитов клиента в этом филиале (без учёта текущей записи).  
    - Если это `N`‑й визит, к бронированию применяется промо: базовая сумма услуги обнуляется (или применяется 100% скидка), в `promotion_applied` записывается информация, что услуга бесплатна.  
    - Если это не `N`‑й визит, акция не применяется, но счётчик в `client_promotion_usage` обновляется.

- **Реферальная акция “Приведи друга и получи бесплатно” (`referral_free`)**  
  - Параметры:
    - могут включать порог количества приведённых друзей.  
  - Логика:
    - В `client_referrals` регистрируется связь между пригласившим и приглашённым.  
    - Когда приглашённый делает первый/оплаченный визит (в зависимости от настроек), у пригласившего в будущем визите может быть применена 100% скидка на услугу (один раз за реализованного реферала или по другим правилам, заложенным в SQL‑функции).  
    - Фактические ограничения (сколько друзей, сколько бесплатных услуг) определяются функцией `can_use_promotion` в БД.

- **Реферальная акция “Приведи друга — скидка 50%” (`referral_discount_50`)**  
  - Параметры:
    - `discount_percent` — обычно 50.  
  - Логика:
    - Аналогично `referral_free`, но вместо полной бесплатности применяется процентная скидка.  
    - При вызове `update_booking_status_with_promotion` рассчитывается:
      - `final_amount = base_amount * (1 - discount_percent / 100)`.  
    - В `promotion_applied` сохраняются `discount_percent` и `final_amount`.

- **Акция “Скидка на день рождения” (`birthday_discount`)**  
  - Параметры:
    - `discount_percent` — размер скидки.  
  - Логика:
    - При попытке применения промо функция в БД проверяет, что дата визита попадает в разрешённое окно вокруг дня рождения клиента (например, день рождения ± несколько дней — зависит от реализации в SQL).  
    - Если условия выполняются и акция ещё не использована (или соблюдены правила частоты), применяется скидка:
      - `final_amount = base_amount * (1 - discount_percent / 100)`.  

- **Акция “Скидка для первого визита” (`first_visit_discount`)**  
  - Параметры:
    - `discount_percent` — размер скидки.  
  - Логика:
    - Функция проверяет в БД, что у клиента нет других `paid` визитов в данном бизнесе/филиале.  
    - Если это первый оплаченный визит — применяется скидка по аналогичной формуле:
      - `final_amount = base_amount * (1 - discount_percent / 100)`.  
    - После первого применения дальнейшие визиты не попадают под эту акцию.

#### 3.5.3 Приоритет применения акций

- Если клиент одновременно подходит под несколько акций, система выбирает **одну** по фиксированному приоритету (от более важной к менее важной):
  1. `first_visit_discount` — скидка для первого оплаченного визита в филиале.
  2. `birthday_discount` — скидка в день рождения (будет включена после добавления даты рождения клиента).
  3. `referral_free` — бесплатная услуга за приглашённого друга.
  4. `referral_discount_50` — скидка 50% за приглашённого друга.
  5. `free_after_n_visits` — каждая N‑я услуга бесплатно.
  6. Другие типы акций (если будут добавлены) с меньшим приоритетом.

- Все проверки, может ли клиент использовать конкретную акцию (первый визит, достигнуто ли N‑е посещение, есть ли неиспользованный реферальный бонус и т.д.), выполняются в SQL‑функции `can_use_promotion(p_client_id, p_branch_id, p_promotion_id)`.  
- Функция `apply_promotion_to_booking(p_booking_id)`:
  - выбирает все доступные акции, для которых `can_use_promotion = true`,
  - сортирует их по приоритету, описанному выше,
  - применяет только первую (наивысший приоритет) и записывает результат в `bookings.promotion_applied`.

> ВАЖНО: точные условия (сколько раз, на какие услуги, диапазон дат и т.п.) концентрируются в SQL‑функциях `get_client_visit_count`, `can_use_promotion`, `apply_promotion_to_booking` и могут развиваться без изменений UI.

#### 3.5.4 Момент и порядок применения промо

- **Когда считается промо**  
  - Промо **не применяется** на этапе создания бронирования (`hold/confirmed`).  
  - Промо применяется **в момент, когда запись помечается как `paid`**:
    - либо через API `mark-attendance` (отметка посещения),  
    - либо опосредованно при закрытии смены, когда записи переводятся в `paid`.  
- **Функция‑обработчик**  
  - Вместо прямого обновления `status = 'paid'` вызывается RPC:
    - `update_booking_status_with_promotion(p_booking_id, 'paid')`.  
  - Внутри функции:
    1. Проверяется возможность использования каждой доступной акции для клиента и филиала (`can_use_promotion`).  
    2. Выбирается подходящая акция (по типу и приоритету — обычно "первый визит / день рождения / реферальные / N‑й визит").  
    3. Считается финальная сумма и записывается в `promotion_applied`.  
    4. Обновляется статус бронирования на `paid`.  
    5. Обновляются таблицы использования промо (`client_promotion_usage`, `client_referrals` по необходимости).

#### 3.5.5 Где клиент и владелец видят акции

- **Публичная часть / страница бизнеса**  
  - В блоке “О бизнесе” показывается список всех активных акций по филиалам этого бизнеса.  
  - На форме бронирования для выбранного филиала выводятся только актуальные акции именно этого филиала.
- **Сводка бронирования (шаги брони)**  
  - В правой панели “Ваша запись” показывается информация о том, что при оплате будет применена акция (если для комбинации клиент/филиал/услуга на текущий момент есть подходящие промо).  
- **Страница подтверждения бронирования (`/booking/[id]`)**  
  - Если к бронированию была применена акция, блок “Применена акция” показывает:
    - название акции,  
    - процент скидки (если есть),  
    - итоговую сумму после применения.  
- **Личный кабинет клиента**  
  - В карточках прошлых и будущих записей, где есть `promotion_applied`, отображается блок “Применена акция” с теми же полями.

---

## 4. Административные функции (Super Admin)

### 4.1 Управление бизнесами
- **Модерация**: одобрение/отклонение новых бизнесов
- **Просмотр всех бизнесов**: доступ ко всем бизнесам в системе

### 4.2 Настройка рейтингов
- **Глобальные настройки**: веса компонентов рейтинга сотрудника, период расчёта (скользящее окно в днях)
- **Страница настроек**: `/admin/rating-config`; после сохранения — опциональный запрос на пересчёт истории за N дней (см. раздел 1.6.7)
- **Здоровье и отладка**: `/admin/ratings-status` — сводка по метрикам и сущностям без рейтинга; `/admin/ratings-debug` — детальная диагностика (NULL-рейтинги, сущности без метрик, ошибки пересчёта)

---

## 5. Технические особенности

### 5.1 Автоматизация
- **Cron Jobs**:
  - Закрытие незакрытых смен (каждый день в 18:00 UTC)
  - Пересчет рейтингов (каждый день в 03:00 UTC)
- **Автосохранение**: данные смены сохраняются автоматически при добавлении клиентов

### 5.2 Безопасность
- **Row Level Security (RLS)**: каждый пользователь видит только свои данные
- **Роли и права доступа**: разные уровни доступа для разных ролей
- **Service Client**: для обхода RLS в административных операциях

### 5.3 Мультиязычность
- **Языки**: Кыргызский, Русский, Английский
- **Переводы**: все интерфейсы переведены на 3 языка
- **Выбор языка**: пользователь может выбрать язык интерфейса

### 5.4 Уведомления
- **Email**: отправка уведомлений о записях через Resend
- **Telegram**: интеграция с Telegram для уведомлений (в разработке)
- **WhatsApp**: интеграция с WhatsApp (временно отключена)

### 5.5 Интеграции
- **Supabase**: база данных, аутентификация, хранение файлов
- **Resend**: отправка email
- **Яндекс.Карты**: выбор координат филиалов
- **Vercel**: хостинг и cron jobs

---

## 6. Монетизация и тарификация

### 6.1 Текущая модель
- Система бесплатна для бизнесов (FREE план)
- Нет ограничений на количество:
  - Филиалов
  - Сотрудников
  - Услуг
  - Записей
  - Клиентов

### 6.2 Потенциальные метрики для тарификации
- **Количество филиалов**: ограничение на количество филиалов
- **Количество сотрудников**: ограничение на количество активных сотрудников
- **Количество записей в месяц**: лимит на количество бронирований
- **Количество клиентов**: лимит на количество уникальных клиентов
- **Хранение данных**: ограничение на период хранения истории
- **Дополнительные функции**:
  - Расширенная аналитика
  - Экспорт данных
  - API доступ
  - Интеграции (Telegram, WhatsApp)
  - Кастомный домен
  - Приоритетная поддержка

### 6.3 Статусы бизнеса
- **Не одобрен**: бизнес зарегистрирован, но не прошел модерацию
- **Одобрен**: бизнес активен и виден публично
- **Заблокирован**: бизнес временно заблокирован

---

## 7. Структура данных

### 7.1 Основные сущности
- **Businesses**: бизнесы
- **Branches**: филиалы
- **Staff**: сотрудники
- **Services**: услуги
- **Bookings**: записи клиентов
- **Staff Shifts**: смены сотрудников
- **Staff Shift Items**: клиенты в смене
- **Reviews**: отзывы клиентов
- **User Roles**: роли пользователей
- **Rating Metrics**: метрики рейтингов (ежедневные)

### 7.2 Связи
- Бизнес → Филиалы (1:N)
- Бизнес → Сотрудники (1:N)
- Бизнес → Услуги (1:N)
- Филиал → Сотрудники (N:M через назначения)
- Сотрудник → Услуги (N:M)
- Сотрудник → Смены (1:N)
- Смена → Клиенты в смене (1:N)
- Запись → Отзыв (1:1)

---

## 8. API и интеграции

### 8.1 Публичные API
- Просмотр бизнесов, филиалов, сотрудников, услуг
- Создание записей (требует авторизации)

### 8.2 Приватные API (требуют авторизации)
- Управление бизнесом (dashboard)
- Управление сменами (staff cabinet)
- Управление записями (client cabinet)

### 8.3 Cron Jobs
- `/api/cron/close-shifts` — закрытие незакрытых смен
- `/api/cron/recalculate-ratings` — пересчет рейтингов

---

## 9. Будущие функции (в разработке или планируются)

- Полная интеграция с Telegram
- Полная интеграция с WhatsApp
- Мобильное приложение для сотрудников
- Мобильное приложение для клиентов
- Система лояльности
- Программы скидок
- Экспорт отчетов
- API для интеграций
- SMS уведомления

---

## 10. Контакты и поддержка

Для вопросов по функциональностям и тарификации обращайтесь к команде разработки.

---

**Версия документа**: 1.0  
**Дата обновления**: 2026-01-15

