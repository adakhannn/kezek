# Отчет об аудите и усилении RLS политик

## Дата: 2026-01-26

## Цель
Провести аудит всех RLS политик на предмет утечек данных и убедиться, что:
1. Владельцы бизнесов не могут видеть данные других бизнесов
2. Сотрудники не могут изменять данные других сотрудников
3. Клиенты не могут видеть чужие бронирования

## Проверенные таблицы

### 1. businesses
**Статус:** ✅ Усилены политики

**Политики:**
- `Business owners can view own businesses` - владельцы могут видеть только свои бизнесы
- `Business owners can update own businesses` - владельцы могут обновлять только свои бизнесы
- `Public can view approved businesses` - публичный доступ на чтение для одобренных бизнесов
- `Super admins can manage all businesses` - суперадмины могут управлять всеми бизнесами

**Проверка:** Владельцы могут видеть только бизнесы, где они являются `owner_id` или имеют роль `owner/admin/manager` через `user_roles`.

### 2. branches
**Статус:** ✅ Усилены политики

**Политики:**
- `Business owners can view own branches` - владельцы могут видеть только филиалы своих бизнесов
- `Business owners can manage own branches` - владельцы могут управлять только филиалами своих бизнесов
- `Public can view active branches` - публичный доступ на чтение для активных филиалов
- `Super admins can manage all branches` - суперадмины могут управлять всеми филиалами

**Проверка:** Владельцы могут видеть только филиалы, где `biz_id` совпадает с их бизнесом через `user_roles`.

### 3. staff
**Статус:** ✅ Усилены политики

**Политики:**
- `Business owners can view own staff` - владельцы могут видеть только сотрудников своих бизнесов
- `Business owners can manage own staff` - владельцы могут управлять только сотрудниками своих бизнесов
- `Staff can view own profile` - сотрудники могут видеть только свой профиль
- `Staff can update own profile` - сотрудники могут обновлять только свой профиль
- `Public can view active staff` - публичный доступ на чтение для активных сотрудников
- `Super admins can manage all staff` - суперадмины могут управлять всеми сотрудниками

**Проверка:** 
- Владельцы могут видеть только сотрудников, где `biz_id` совпадает с их бизнесом
- Сотрудники могут видеть/обновлять только записи, где `user_id = auth.uid()`

### 4. services
**Статус:** ✅ Усилены политики

**Политики:**
- `Business owners can view own services` - владельцы могут видеть только услуги своих бизнесов
- `Business owners can manage own services` - владельцы могут управлять только услугами своих бизнесов
- `Public can view active services` - публичный доступ на чтение для активных услуг
- `Super admins can manage all services` - суперадмины могут управлять всеми услугами

**Проверка:** Владельцы могут видеть только услуги, где `biz_id` совпадает с их бизнесом.

### 5. bookings
**Статус:** ✅ Усилены политики

**Политики:**
- `Clients can view own bookings` - клиенты могут видеть только свои бронирования
- `Clients can create own bookings` - клиенты могут создавать только свои бронирования
- `Clients can update own bookings` - клиенты могут обновлять только свои бронирования
- `Business owners can view own bookings` - владельцы могут видеть бронирования своих бизнесов
- `Business owners can update own bookings` - владельцы могут обновлять бронирования своих бизнесов
- `Staff can view own bookings` - сотрудники могут видеть бронирования, где они назначены
- `Super admins can manage all bookings` - суперадмины могут управлять всеми бронированиями

**Проверка:**
- Клиенты могут видеть только бронирования, где `client_id = auth.uid()` или `client_phone` совпадает с их телефоном
- Владельцы могут видеть только бронирования, где `biz_id` совпадает с их бизнесом
- Сотрудники могут видеть только бронирования, где `staff_id` соответствует их `user_id`

### 6. service_staff
**Статус:** ✅ Усилены политики

**Политики:**
- `Business owners can manage service_staff` - владельцы могут управлять связями услуга-сотрудник только для своих бизнесов
- `Super admins can manage all service_staff` - суперадмины могут управлять всеми связями

**Проверка:** Владельцы могут управлять только связями, где услуга принадлежит их бизнесу.

## Уже существующие политики (проверены)

### staff_shifts
**Статус:** ✅ Корректно

**Политики:**
- `Staff shifts select own` - сотрудники могут видеть только свои смены
- `Staff shifts modify own` - сотрудники могут изменять только свои смены

**Проверка:** Политики проверяют, что `staff.user_id = auth.uid()`, что правильно.

### staff_shift_items
**Статус:** ✅ Корректно

**Политики:**
- `Staff shift items own` - сотрудники могут работать только с позициями своих смен

**Проверка:** Политики проверяют через JOIN с `staff_shifts` и `staff`, что правильно.

### reviews
**Статус:** ✅ Корректно

**Политики:**
- `Users can insert own reviews` - пользователи могут создавать отзывы только для своих бронирований
- `Users can select own reviews` - пользователи могут читать свои отзывы, владельцы - отзывы для своих сотрудников
- `Users can update own reviews` - пользователи могут обновлять только свои отзывы

**Проверка:** Политики проверяют `client_id = auth.uid()` и доступ владельцев через JOIN с `bookings` → `staff` → `businesses`.

### branch_promotions
**Статус:** ✅ Корректно

**Политики:**
- `Biz owners/admins/managers can manage branch promotions` - владельцы могут управлять акциями своих филиалов
- `Public can view active branch promotions` - публичный доступ на чтение для активных акций

**Проверка:** Политики проверяют `biz_id` через `user_roles`, что правильно.

### client_promotion_usage
**Статус:** ✅ Корректно

**Политики:**
- `Clients can view own promotion usage` - клиенты могут видеть свою историю использования акций
- `Biz owners/admins/managers can view promotion usage` - владельцы могут видеть использование акций своих клиентов

**Проверка:** Политики проверяют `client_id = auth.uid()` и `biz_id` через `user_roles`.

### client_referrals
**Статус:** ✅ Корректно

**Политики:**
- `Clients can view own referrals` - клиенты могут видеть свои реферальные связи
- `Biz owners/admins/managers can view referrals` - владельцы могут видеть реферальные связи своих клиентов

**Проверка:** Политики проверяют `referrer_id = auth.uid()` или `referred_id = auth.uid()`, и `biz_id` через `user_roles`.

## Выявленные проблемы и исправления

### Проблема 1: Отсутствие RLS политик для основных таблиц
**Статус:** ✅ Исправлено

**Описание:** Таблицы `businesses`, `branches`, `staff`, `services`, `bookings`, `service_staff` не имели явных RLS политик, что могло привести к утечкам данных.

**Решение:** Создана миграция `20260126000000_audit_and_strengthen_rls_policies.sql` с полным набором политик для всех основных таблиц.

### Проблема 2: Потенциальная утечка данных между бизнесами
**Статус:** ✅ Исправлено

**Описание:** Без явных RLS политик владельцы бизнесов теоретически могли видеть данные других бизнесов через прямые запросы к БД.

**Решение:** Все политики теперь явно проверяют `biz_id` через `user_roles` и `owner_id`.

### Проблема 3: Сотрудники могли изменять данные других сотрудников
**Статус:** ✅ Исправлено

**Описание:** Без явных RLS политик сотрудники теоретически могли изменять данные других сотрудников.

**Решение:** Добавлена политика `Staff can update own profile`, которая проверяет `user_id = auth.uid()`.

## Рекомендации

1. **Регулярный аудит:** Проводить аудит RLS политик при добавлении новых таблиц или изменении логики доступа.

2. **Тестирование:** Создать тесты для проверки, что RLS политики работают корректно и предотвращают утечки данных.

3. **Документация:** Обновлять документацию при изменении политик доступа.

4. **Мониторинг:** Настроить мониторинг попыток доступа к данным, которые должны быть заблокированы RLS.

## Заключение

Все основные таблицы теперь имеют явные RLS политики, которые предотвращают утечки данных между бизнесами и обеспечивают правильную изоляцию данных для сотрудников и клиентов. Миграция готова к применению.

