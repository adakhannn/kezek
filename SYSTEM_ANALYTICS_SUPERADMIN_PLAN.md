# System‑wide analytics для суперадмина (черновик плана)

## 1. Контекст и цели

**Зачем:** дать суперадмину витрину по всей системе: как растёт платформа, какие бизнесы/категории/города тянут выручку и загрузку, где аномалии.

**Исходные артефакты:**

- Уже есть бизнес‑аналитика на уровне одного бизнеса (`BUSINESS_ANALYTICS_DASHBOARD_PLAN.md`, таблицы `business_daily_stats`, `business_hourly_load`).
- Есть витрина для владельца в `/dashboard/analytics` и раздел аналитики для суперадмина на уровне бизнеса в `/admin/analytics/*`.

**Новое:** многомерная аналитика **по всей платформе** (все бизнесы), только для суперадмина.

---

## 2. Эпик S — System‑wide platform analytics

### S1. Метрики и сценарии использования

**Задача S1.1 — Описать ключевые метрики платформы** — **[x] done**

**Базовые определения:**

- **Активный бизнес за день** — бизнес, у которого за дату есть хотя бы одно из:
  - ≥1 успешная бронь (`bookings.status in ('confirmed','paid')`),
  - ≥1 аналитическое событие `booking_flow_start` или `business_page_view`,
  - ≥1 активный сотрудник со сменой в этот день (резервный критерий).
- **Активный бизнес за месяц/неделю** — бизнес, который был активен хотя бы в один из дней периода.
- **MAU/WAU/DAU клиентов** (по возможностям текущих данных):
  - считаем по уникальным `client_id` или `client_phone` из `bookings` со статусами `confirmed|paid`,
  - DAU — уникальные клиенты за день, WAU/MAU — за 7/30 дней c перекрывающимися окнами.
- **Суммарная выручка платформы** — сумма `total_revenue` из агрегатов (или `booking_final_amount` из `bookings`) по всем бизнесам за период, с разрезами:
  - по городу (`businesses.city` / связанная таблица городов),
  - по категории (`businesses.category_id`),
  - по каналу (web/mobile, если канал есть в источниках событий/броней).
- **Средняя конверсия воронки по сегментам**:
  - считаем на базе тех же шагов, что и бизнес‑аналитика: `home_view → business_page_view → booking_flow_start → booking_created → booking_confirmed_or_paid`;
  - конверсия считается как отношение суммарных шагов по платформе в выбранном сегменте (город/категория/канал) за период;
  - для стабильности использовать скользящее окно (например, 7/30 дней).
- **Нагрузка по часам/дням**:
  - источник — агрегаты `business_hourly_load` (или их платформенные своды);
  - для каждого часа считаем суммарное количество бронирований/промо‑бронирований по платформе и в разрезах по городу/категории;
  - «час пик» — часы с верхним процентилем загрузки (например, 90‑й перцентиль по количеству бронирований).

**Параметры окон и таймзон:**

- Базовая таймзона для платформенной аналитики — **UTC**, при этом для городов/стран в UI можно дополнительно показывать локальное время.
- Стандартные окна: 7/30/90 дней, с возможностью выбирать произвольный диапазон.
- Все вычисления на уровне агрегатов выполняются по датам, уже нормализованным в `business_daily_stats` / `business_hourly_load` (эти таблицы учитывают локальную таймзону бизнеса при расчёте дат).

**Задача S1.2 — Описать бизнес‑сценарии суперадмина** — **[x] done**

**Ключевые вопросы, на которые должна отвечать система:**

- «Какие города/категории растут/падают по выручке и загрузке?»
- «Какие бизнесы аномально быстро растут/падают по выручке/записям/активности клиентов?»
- «Как изменился эффект от новых фич (промо, рейтинги, новые каналы, интеграции)?»
- «Где сейчас узкие места платформы: города/категории/часы, где спрос есть, а предложения мало?»

**User‑story 1 — “Здоровье по городам”**

- Как суперадмин, я хочу видеть таблицу «города × ключевые метрики» за выбранный период, чтобы понимать:
  - какой город даёт наибольшую выручку и рост по бронированиям;
  - какие города стагнируют или падают;
  - где имеет смысл усиливать маркетинг/продажи B2B.
- UI: таблица/бар‑чарт с колонками *город / активные бизнесы / бронирования / выручка / рост % к прошлому периоду*.

**User‑story 2 — “Топ/антитоп бизнесов”**

- Как суперадмин, я хочу видеть список бизнесов с сортировкой по росту/падению выручки и загрузки, чтобы:
  - быстро находить истории успеха (для кейсов и реферрал‑программ);
  - замечать бизнесы, у которых всё резко просело (повод связаться и понять проблему).
- UI: таблица с возможностью переключения «ТОП‑растущие» / «ТОП‑падающие» и фильтрами по городу/категории.

**User‑story 3 — “Эффект новых фич”**

- Как суперадмин/продакт, я хочу сравнивать метрики до/после запуска фичи (например, промо или рейтингов), чтобы:
  - видеть, увеличилось ли число бронирований/выручка у бизнесов, которые включили фичу;
  - понять, стоит ли масштабировать фичу на всю платформу.
- UI: простой экспериментальный отчёт: *группа с фичей vs группа без*, метрики по бронированиям и выручке.

**User‑story 4 — “Нагрузка и часы пик по платформе”**

- Как суперадмин, я хочу видеть агрегированную heatmap по часам и дням недели в разрезе городов/категорий, чтобы:
  - понимать, когда у платформы пик нагрузки по бронированиям;
  - оценивать риски по SLA (напр., нужны ли дополнительные ресурсы/масштабирование).
- UI: heatmap «день недели × час» + фильтры по городу/категории, поверх агрегатов `platform_daily_stats`/`platform_hourly_*`.

**User‑story 5 — “Качество активации новых бизнесов”**

- Как суперадмин, я хочу видеть воронку активации бизнесов (от регистрации до первых N бронирований), чтобы:
  - понимать, сколько новых бизнесов «застревает» без запусков;
  - вовремя включать customer‑success/онбординг.
- UI: отчёт по когорте «месяц регистрации бизнеса» с шагами: *зарегистрирован → настроены филиалы/услуги → получили ≥1 бронирование → получили ≥10 бронирований*.

---

### S2. Схема данных и агрегаты

**Задача S2.1 — Спроектировать платформенные агрегаты** — **[x] done**

- На базе `business_daily_stats` и `business_hourly_load` описать агрегирующие витрины уровня платформы:
  - `platform_daily_stats` (по датам, с разрезами по городу, категории, каналу);
  - при необходимости — отдельные витрины по категориям или городам (`platform_city_daily`, `platform_category_daily`).
- Для каждой таблицы описать:
  - ключи (date, city_id, category_id и т.п.);
  - набор метрик (сумма выручки, количество бизнесов, количество бронирований, средний чек и т.д.);
  - индексы под ожидаемые запросы (по дате + город/категория).

Дополнительная спецификация агрегатов:

#### Таблица `platform_daily_stats`

- **Назначение:** дневные агрегаты по всей платформе, с разрезами по городу/категории/каналу.
- **Ключи:**
  - `date date not null` — дата (UTC, либо приведённая к общей платформенной таймзоне);
  - `city_id uuid null` — город (null = «все города»);
  - `category_id uuid null` — категория бизнеса (null = «все категории»);
  - `channel text null` — канал (`'all' | 'web' | 'mobile' | ...`);
  - составной primary key по `(date, coalesce(city_id,'000...'), coalesce(category_id,'000...'), coalesce(channel,''))`.
- **Метрики (минимальный набор):**
  - `active_businesses_count int` — количество активных бизнесов за день в сегменте (по определению из S1.1);
  - `bookings_created int`;
  - `bookings_confirmed_or_paid int`;
  - `total_revenue numeric(14,2)`;
  - `promo_bookings int`;
  - `promo_revenue numeric(14,2)`;
  - `home_views bigint`;
  - `business_page_views bigint`;
  - `booking_flow_starts bigint`.
- **Индексы:**
  - `idx_platform_daily_date` on `(date)` — общие тренды по платформе;
  - `idx_platform_daily_city_date` on `(city_id, date)` — отчёты по городам;
  - `idx_platform_daily_category_date` on `(category_id, date)` — отчёты по категориям;
  - при необходимости — `idx_platform_daily_channel_date` on `(channel, date)`.

#### Дополнительные витрины

- `platform_city_daily` и `platform_category_daily` могут быть реализованы как материальные представления над `platform_daily_stats` для ускорения типовых отчётов «по городам» и «по категориям`, если прямой `GROUP BY` станет узким местом.

#### Связь с источниками

- `platform_daily_stats` наполняется cron‑процессом, который:
  - берёт `business_daily_stats` за нужный диапазон дат;
  - джоинит `businesses` (город, категория, канал);
  - агрегирует по `(date, city_id, category_id, channel)` с расчётом суммарных метрик.
- Для почасовой аналитики на уровне платформы (heatmap) в задачах S2.2/S3 можно спроектировать аналог `platform_hourly_stats` на базе `business_hourly_load` по такому же принципу.

**Задача S2.2 — Спроектировать источники данных** — **[x] done**

- Источники для платформенных витрин:
  - `business_daily_stats` — базовый источник для дневных метрик (выручка, бронирования, промо, шаги воронки);
  - `business_hourly_load` — источник для часовой загрузки (heatmap по платформе);
  - `businesses` — атрибуты бизнеса (город, категория, канал/тип), используются при агрегации в `platform_daily_stats`;
  - при необходимости — дополнительные атрибуты из `categories` / `cities` (человеко‑читаемые названия, группировки);
  - `bookings` — как резервный источник для валидации агрегатов и расчёта дополнительных когорт/MAU, если чего‑то не хватает в `business_*` таблицах.
- При проектировании миграций для `platform_*` витрин нужно:
  - убедиться, что в `business_daily_stats` и `business_hourly_load` есть все поля, необходимые для расчёта платформенных метрик (в противном случае расширить их отдельными миграциями);
  - предусмотреть индексы на столбцы, по которым будут происходить join/aggregations (`biz_id`, `date`, `branch_id` и т.п.), чтобы nightly‑cron на платформу работал за приемлемое время.

---

### S3. Cron‑задачи и заполнение витрин

**Задача S3.1 — Добавить cron для пересчёта `platform_daily_stats`** — **[x] done**

- Создать SQL‑функции/скрипты, которые агрегируют данные по всем бизнесам за день:
  - на вход: диапазон дат (обычно «вчера», но с возможностью бэктилла);
  - на выход: upsert в `platform_daily_stats` по (date, city, category, channel и т.д.).
- Общий алгоритм cron‑процесса:
  - для каждой даты из диапазона:
    - выбрать из `business_daily_stats` все строки за эту дату;
    - джоинить `businesses` (город, категория, канал);
    - агрегировать по `(date, city_id, category_id, channel)` с подсчётом суммарных метрик;
    - выполнить `INSERT ... ON CONFLICT DO UPDATE` в `platform_daily_stats`;
  - логировать время выполнения и количество затронутых строк; в случае ошибок — писать в `logError` отдельным scope `PlatformAnalyticsDailyCron`.
- Завести HTTP‑маршрут cron в `apps/web` вида `/api/cron/platform-analytics/daily`, защищённый `CRON_SECRET` (аналогично существующим `analytics/daily`/`hourly-load`).
- Описать в `CRON_SETUP.md` расписание и параметры (по аналогии с `business_daily_stats`), например: ежедневный запуск в 04:00 UTC + возможность ручного вызова с кастомным диапазоном дат.

**Задача S3.2 — (опционально) Cron для `platform_hourly_stats`** — **[x] done**

- Если потребуется часовая детализация по платформе — описать и реализовать отдельную таблицу и cron.
- Предварительная схема `platform_hourly_stats`:
  - ключи: `date date`, `hour int`, `city_id uuid null`, `category_id uuid null`, `channel text null`;
  - метрики: `bookings_count`, `promo_bookings_count`, опционально `unique_clients_count` и `active_businesses_count_hourly`;
  - индексы: `(date, hour)`, `(city_id, date, hour)`, `(category_id, date, hour)`.
- Источник данных: `business_hourly_load` + join с `businesses` (город, категория, канал) по принципу, аналогичному `platform_daily_stats`.
- Cron‑алгоритм аналогичен S3.1, но с дополнительной группировкой по `hour` и, при необходимости, более узким окном дат (например, пересчёт только последних 7–30 дней).

---

### S4. API для суперадмина

**Задача S4.1 — Спроектировать REST API для system‑analytics** — **[x] done**

- Базовый префикс: `/admin/api/system-analytics/*`.
- Минимальный набор маршрутов:
  - `/admin/api/system-analytics/overview` — сводка по платформе за период (кол‑во активных бизнесов, выручка, конверсия);
  - `/admin/api/system-analytics/by-city` — разрез по городам;
  - `/admin/api/system-analytics/by-category` — разрез по категориям;
  - `/admin/api/system-analytics/anomalies` — эндпоинт для поиска аномалий (простые эвристики).
- Для каждого маршрута:
  - описать query‑параметры (period, city_id, category_id, min_businesses и т.п.);
  - описать формат ответа (JSON‑модели).

**Задача S4.2 — Реализовать API с учётом существующих паттернов** — **[x] done**

- Использовать те же паттерны, что и бизнес‑аналитика:
  - `withErrorHandler`, `createSuccessResponse`, `createErrorResponse`;
  - `zod`‑схемы для валидации query;
  - in‑memory cache через `simpleCache`.
- Ограничить доступ:
  - проверять глобальную роль `super_admin` (как в `admin/layout.tsx`);
  - при отсутствии роли возвращать 403 с типизированным кодом ошибки.

---

### S5. UI в админке суперадмина

**Задача S5.1 — Спроектировать раздел `/admin/analytics/system`** — **[x] done**

- Продумать навигацию в админке:
  - добавить отдельную вкладку «Платформа» / «Система» рядом с текущей аналитикой по бизнесу;
  - не смешивать системную аналитику с аналитикой одного бизнеса, чтобы не путать уровни.
- Список экранов (MVP):
  - system overview (графики по активным бизнесам, выручке, бронированиям);
  - топ/антитоп бизнесов, городов, категорий;
  - простая страница с аномалиями (подозрительные скачки/просадки).

**Задача S5.2 — Реализовать первый экран System Overview** — **[x] done**

- Фильтры:
  - период (7/30/90/ custom);
  - опционально — город/категория.
- Блоки:
  - KPI‑карточки (активные бизнесы, суммарная выручка, суммарные брони, средний чек);
  - график тренда по выручке/бизнесам;
  - таблица с топ‑городами/категориями по выручке.

---

### S6. Безопасность, валидация и rollout

**Задача S6.1 — Документировать права доступа и разграничение ролей** — **[x] done**

- Описать в `MONITORING_AND_ANALYTICS.md`:
  - что раздел `/admin/analytics/system` и API `/admin/api/system-analytics/*` доступны **только** суперадминам;
  - что используются агрегаты по всем бизнесам, но без доступа к PII;
  - как логируются запросы и метрики использования этого раздела.

**Задача S6.2 — Сверка и sanity‑checks для платформенных метрик** — **[x] done**

- Подготовить SQL‑запросы для сверки:
  - `platform_daily_stats` против суммы `business_daily_stats`;
  - выборочных городов/категорий против сырых `bookings`.
- Описать чек‑лист тестирования перед включением для всех суперадминов.

**Задача S6.3 — Поэтапный rollout** — **[x] done**

- stage 1: скрытый раздел для внутренней команды
  - включить `/admin/analytics/system` только для ограниченного списка `user_id` (feature‑флаг на уровне UI и/или проверки в API);
  - прогнать sanity‑checks из S6.2, собрать фидбек от команды (удобство метрик, производительность запросов);
  - при необходимости скорректировать витрины/индексы до расширения аудитории.
- stage 2: rollout на всех суперадминов
  - убрать ограничение по `user_id`, оставить только проверку роли `super_admin`;
  - в течение первых недель мониторить нагрузку на cron и `system-analytics` API (latency, ошибки, частоту вызовов);
  - при обнаружении проблем — временно отключать тяжёлые отчёты (например, anomalies) через feature‑флаг.
- stage 3: развитие
  - добавить экспорт в CSV для ключевых отчётов (overview, by‑city, by‑category);
  - при необходимости добавить дополнительные срезы (каналы, когорты по дате регистрации бизнесов);
  - рассмотреть интеграцию с внешними BI‑инструментами (например, read‑only доступ к витринам `platform_*`).

# System‑wide analytics для суперадмина (черновик плана)

## 1. Контекст и цели

**Зачем:** дать суперадмину витрину по всей системе: как растёт платформа, какие бизнесы/категории/города тянут выручку и загрузку, где аномалии.

**Исходные артефакты:**

- Уже есть бизнес‑аналитика на уровне одного бизнеса (`BUSINESS_ANALYTICS_DASHBOARD_PLAN.md`, таблицы `business_daily_stats`, `business_hourly_load`).
- Есть витрина для владельца в `/dashboard/analytics` и раздел аналитики для суперадмина на уровне бизнеса в `/admin/analytics/*`.

**Новое:** многомерная аналитика **по всей платформе** (все бизнесы), только для суперадмина.

---

## 2. Эпик S — System‑wide platform analytics

### S1. Метрики и сценарии использования

**Задача S1.1 — Описать ключевые метрики платформы** — **[x] done**

**Базовые определения:**

- **Активный бизнес за день** — бизнес, у которого за дату есть хотя бы одно из:
  - ≥1 успешная бронь (`bookings.status in ('confirmed','paid')`),
  - ≥1 аналитическое событие `booking_flow_start` или `business_page_view`,
  - ≥1 активный сотрудник со сменой в этот день (резервный критерий).
- **Активный бизнес за месяц/неделю** — бизнес, который был активен хотя бы в один из дней периода.
- **MAU/WAU/DAU клиентов** (по возможностям текущих данных):
  - считаем по уникальным `client_id` или `client_phone` из `bookings` со статусами `confirmed|paid`,
  - DAU — уникальные клиенты за день, WAU/MAU — за 7/30 дней c перекрывающимися окнами.
- **Суммарная выручка платформы** — сумма `total_revenue` из агрегатов (или `booking_final_amount` из `bookings`) по всем бизнесам за период, с разрезами:
  - по городу (`businesses.city` / связанная таблица городов),
  - по категории (`businesses.category_id`),
  - по каналу (web/mobile, если канал есть в источниках событий/броней).
- **Средняя конверсия воронки по сегментам**:
  - считаем на базе тех же шагов, что и бизнес‑аналитика: `home_view → business_page_view → booking_flow_start → booking_created → booking_confirmed_or_paid`;
  - конверсия считается как отношение суммарных шагов по платформе в выбранном сегменте (город/категория/канал) за период;
  - для стабильности использовать скользящее окно (например, 7/30 дней).
- **Нагрузка по часам/дням**:
  - источник — агрегаты `business_hourly_load` (или их платформенные своды);
  - для каждого часа считаем суммарное количество бронирований/промо‑бронирований по платформе и в разрезах по городу/категории;
  - «час пик» — часы с верхним процентилем загрузки (например, 90‑й перцентиль по количеству бронирований).

**Параметры окон и таймзон:**

- Базовая таймзона для платформенной аналитики — **UTC**, при этом для городов/стран в UI можно дополнительно показывать локальное время.
- Стандартные окна: 7/30/90 дней, с возможностью выбирать произвольный диапазон.
- Все вычисления на уровне агрегатов выполняются по датам, уже нормализованным в `business_daily_stats` / `business_hourly_load` (эти таблицы учитывают локальную таймзону бизнеса при расчёте дат).

**Задача S1.2 — Описать бизнес‑сценарии суперадмина** — **[x] done**

**Ключевые вопросы, на которые должна отвечать система:**

- «Какие города/категории растут/падают по выручке и загрузке?»
- «Какие бизнесы аномально быстро растут/падают по выручке/записям/активности клиентов?»
- «Как изменился эффект от новых фич (промо, рейтинги, новые каналы, интеграции)?»
- «Где сейчас узкие места платформы: города/категории/часы, где спрос есть, а предложения мало?»

**User‑story 1 — “Здоровье по городам”**

- Как суперадмин, я хочу видеть таблицу «города × ключевые метрики» за выбранный период, чтобы понимать:
  - какой город даёт наибольшую выручку и рост по бронированиям;
  - какие города стагнируют или падают;
  - где имеет смысл усиливать маркетинг/продажи B2B.
- UI: таблица/бар‑чарт с колонками *город / активные бизнесы / бронирования / выручка / рост % к прошлому периоду*.

**User‑story 2 — “Топ/антитоп бизнесов”**

- Как суперадмин, я хочу видеть список бизнесов с сортировкой по росту/падению выручки и загрузки, чтобы:
  - быстро находить истории успеха (для кейсов и реферрал‑программ);
  - замечать бизнесы, у которых всё резко просело (повод связаться и понять проблему).
- UI: таблица с возможностью переключения «ТОП‑растущие» / «ТОП‑падающие» и фильтрами по городу/категории.

**User‑story 3 — “Эффект новых фич”**

- Как суперадмин/продакт, я хочу сравнивать метрики до/после запуска фичи (например, промо или рейтингов), чтобы:
  - видеть, увеличилось ли число бронирований/выручка у бизнесов, которые включили фичу;
  - понять, стоит ли масштабировать фичу на всю платформу.
- UI: простой экспериментальный отчёт: *группа с фичей vs группа без*, метрики по бронированиям и выручке.

**User‑story 4 — “Нагрузка и часы пик по платформе”**

- Как суперадмин, я хочу видеть агрегированную heatmap по часам и дням недели в разрезе городов/категорий, чтобы:
  - понимать, когда у платформы пик нагрузки по бронированиям;
  - оценивать риски по SLA (напр., нужны ли дополнительные ресурсы/масштабирование).
- UI: heatmap «день недели × час» + фильтры по городу/категории, поверх агрегатов `platform_daily_stats`/`platform_hourly_*`.

**User‑story 5 — “Качество активации новых бизнесов”**

- Как суперадмин, я хочу видеть воронку активации бизнесов (от регистрации до первых N бронирований), чтобы:
  - понимать, сколько новых бизнесов «застревает» без запусков;
  - вовремя включать customer‑success/онбординг.
- UI: отчёт по когорте «месяц регистрации бизнеса» с шагами: *зарегистрирован → настроены филиалы/услуги → получили ≥1 бронирование → получили ≥10 бронирований*.

---

### S2. Схема данных и агрегаты

**Задача S2.1 — Спроектировать платформенные агрегаты** — **[x] done**

- На базе `business_daily_stats` и `business_hourly_load` описать агрегирующие витрины уровня платформы:
  - `platform_daily_stats` (по датам, с разрезами по городу, категории, каналу);
  - при необходимости — отдельные витрины по категориям или городам (`platform_city_daily`, `platform_category_daily`).
- Для каждой таблицы описать:
  - ключи (date, city_id, category_id и т.п.);
  - набор метрик (сумма выручки, количество бизнесов, количество бронирований, средний чек и т.д.);
  - индексы под ожидаемые запросы (по дате + город/категория).

**Задача S2.2 — Спроектировать источники данных** — **[x] done**

- Источники для платформенных витрин:
  - `business_daily_stats` — базовый источник для дневных метрик (выручка, бронирования, промо, шаги воронки);
  - `business_hourly_load` — источник для часовой загрузки (heatmap по платформе);
  - `businesses` — атрибуты бизнеса (город, категория, канал/тип), используются при агрегации в `platform_daily_stats`;
  - при необходимости — дополнительные атрибуты из `categories` / `cities` (человеко‑читаемые названия, группировки);
  - `bookings` — как резервный источник для валидации агрегатов и расчёта дополнительных когорт/MAU, если чего‑то не хватает в `business_*` таблицах.
- При проектировании миграций для `platform_*` витрин нужно:
  - убедиться, что в `business_daily_stats` и `business_hourly_load` есть все поля, необходимые для расчёта платформенных метрик (в противном случае расширить их отдельными миграциями);
  - предусмотреть индексы на столбцы, по которым будут происходить join/aggregations (`biz_id`, `date`, `branch_id` и т.п.), чтобы nightly‑cron на платформу работал за приемлемое время.

---

### S3. Cron‑задачи и заполнение витрин

**Задача S3.1 — Добавить cron для пересчёта `platform_daily_stats`** — **[ ] todo**

- Создать SQL‑функции/скрипты, которые агрегируют данные по всем бизнесам за день:
  - на вход: диапазон дат (обычно «вчера», но с возможностью бэктилла);
  - на выход: upsert в `platform_daily_stats` по (date, city, category и т.д.).
- Завести HTTP‑маршрут cron в `apps/web` вида `/api/cron/platform-analytics/daily`, защищённый `CRON_SECRET`.
- Описать в `CRON_SETUP.md` расписание и параметры (по аналогии с `business_daily_stats`).

**Задача S3.2 — (опционально) Cron для `platform_hourly_stats`** — **[ ] todo**

- Если потребуется часовая детализация по платформе — описать и реализовать отдельную таблицу и cron.

---

### S4. API для суперадмина

**Задача S4.1 — Спроектировать REST API для system‑analytics** — **[ ] todo**

- Базовый префикс: `/admin/api/system-analytics/*`.
- Минимальный набор маршрутов:
  - `/admin/api/system-analytics/overview` — сводка по платформе за период (кол‑во активных бизнесов, выручка, конверсия);
  - `/admin/api/system-analytics/by-city` — разрез по городам;
  - `/admin/api/system-analytics/by-category` — разрез по категориям;
  - `/admin/api/system-analytics/anomalies` — эндпоинт для поиска аномалий (простые эвристики).
- Для каждого маршрута:
  - описать query‑параметры (period, city_id, category_id, min_businesses и т.п.);
  - описать формат ответа (JSON‑модели).

**Задача S4.2 — Реализовать API с учётом существующих паттернов** — **[ ] todo**

- Использовать те же паттерны, что и бизнес‑аналитика:
  - `withErrorHandler`, `createSuccessResponse`, `createErrorResponse`;
  - `zod`‑схемы для валидации query;
  - in‑memory cache через `simpleCache`.
- Ограничить доступ:
  - проверять глобальную роль `super_admin` (как в `admin/layout.tsx`);
  - при отсутствии роли возвращать 403 с типизированным кодом ошибки.

---

### S5. UI в админке суперадмина

**Задача S5.1 — Спроектировать раздел `/admin/analytics/system`** — **[ ] todo**

- Продумать навигацию в админке:
  - добавить отдельную вкладку «Платформа» / «Система» рядом с текущей аналитикой по бизнесу;
  - не смешивать системную аналитику с аналитикой одного бизнеса, чтобы не путать уровни.
- Список экранов (MVP):
  - system overview (графики по активным бизнесам, выручке, бронированиям);
  - топ/антитоп бизнесов, городов, категорий;
  - простая страница с аномалиями (подозрительные скачки/просадки).

**Задача S5.2 — Реализовать первый экран System Overview** — **[ ] todo**

- Фильтры:
  - период (7/30/90/ custom);
  - опционально — город/категория.
- Блоки:
  - KPI‑карточки (активные бизнесы, суммарная выручка, суммарные брони, средний чек);
  - график тренда по выручке/бизнесам;
  - таблица с топ‑городами/категориями по выручке.

---

### S6. Безопасность, валидация и rollout

**Задача S6.1 — Документировать права доступа и разграничение ролей** — **[ ] todo**

- Описать в `MONITORING_AND_ANALYTICS.md`:
  - что раздел `/admin/analytics/system` и API `/admin/api/system-analytics/*` доступны **только** суперадминам;
  - что используются агрегаты по всем бизнесам, но без доступа к PII;
  - как логируются запросы и метрики использования этого раздела.

**Задача S6.2 — Сверка и sanity‑checks для платформенных метрик** — **[ ] todo**

- Подготовить SQL‑запросы для сверки:
  - `platform_daily_stats` против суммы `business_daily_stats`;
  - выборочных городов/категорий против сырых `bookings`.
- Описать чек‑лист тестирования перед включением для всех суперадминов.

**Задача S6.3 — Поэтапный rollout** — **[ ] todo**

- stage 1: скрытый раздел для внутренней команды (feature‑флаг / ограничение по user_id);
- stage 2: включение всем суперадминам, мониторинг нагрузки и фидбек;
- stage 3: возможное расширение (экспорт в CSV, дополнительные разрезы, интеграция с внешними BI‑инструментами).

