# SQL Тесты для критичных сценариев

Этот документ описывает автоматизированные SQL-тесты для проверки критичных сценариев системы.

## Что тестируется

1. **Закрытие смен с гарантией** — проверка расчета гарантированной оплаты при отсутствии клиентов
2. **Применение промо** — проверка автоматического применения акций при переходе брони в статус `paid`
3. **Инициализация и пересчет рейтингов** — проверка расчета рейтингов для сотрудников, филиалов и бизнесов
4. **Комплексный тест** — проверка взаимодействия смен, промо и рейтингов за несколько дней
5. **Рейтинги при отсутствии активности** — проверка сохранения рейтинга при периодах без метрик

## Запуск тестов

### Локально (через Supabase CLI)

```bash
# Убедитесь, что Supabase CLI установлен
npm install -g supabase

# Запустите тесты
pnpm test:sql

# Или напрямую через Supabase CLI
supabase db execute --file supabase/tests_critical_scenarios.sql
```

### Локально (через прямой доступ к БД)

```bash
# Укажите URL подключения к БД
export SUPABASE_DB_URL="postgresql://user:password@host:port/database"
pnpm test:sql

# Или в PowerShell
$env:SUPABASE_DB_URL="postgresql://user:password@host:port/database"
pnpm test:sql
```

### В CI/CD

Тесты автоматически запускаются в GitHub Actions при:
- Push в `main`
- Pull Request

Для работы тестов в CI нужно установить секрет `SUPABASE_TEST_DB_URL` в настройках репозитория GitHub.

**Как установить:**
1. Перейдите в Settings → Secrets and variables → Actions
2. Добавьте новый секрет `SUPABASE_TEST_DB_URL`
3. Укажите connection string к тестовой БД (например: `postgresql://postgres:password@db.xxx.supabase.co:5432/postgres`)

## Формат тестов

Все тесты написаны в формате PostgreSQL `DO $$ ... $$;` блоков. При успехе вы увидите сообщения `NOTICE`, при ошибке тест упадет с `EXCEPTION`.

## Добавление новых тестов

1. Откройте `supabase/tests_critical_scenarios.sql`
2. Добавьте новый `DO $$ ... $$;` блок с тестом
3. Используйте префикс `[TEST N]` для сообщений
4. Проверьте тест локально перед коммитом

## Пример структуры теста

```sql
do $$
declare
    -- Объявляем переменные
    v_test_id uuid;
begin
    raise notice '[TEST N] Старт теста...';
    
    -- Выполняем действия
    -- ...
    
    -- Проверяем результаты
    if условие then
        raise exception '[TEST N] Ожидали X, получили Y';
    end if;
    
    raise notice '[TEST N] OK — тест пройден';
end;
$$;
```

## Важно

- Тесты создают тестовые данные в БД (бизнесы, филиалы, сотрудники и т.д.)
- Тесты должны быть идемпотентными (можно запускать несколько раз)
- При ошибке тест останавливается с `EXCEPTION`
- Все тесты выполняются последовательно

