## Финансы (financeDomain) — план задач

Этот документ фиксирует задачи по развитию и шлифовке финансового домена.  
Фактические формулы описаны в `SYSTEM_FEATURES_DOCUMENTATION.md` (раздел 1.5) и в `apps/web/src/lib/financeDomain/README.md`.

---

### 1. Модели и типы выплат

- [x] **Режимы оплаты и типы выплат**
  - Описать и формализовать возможные схемы оплаты смены:
    - чистый процент от выручки;
    - процент + гарантия (почасовая ставка);
    - фиксированная сумма за смену / час (если понадобится);
    - смешанные / кастомные схемы.
  - Ввести явный тип/enum для режима оплаты в `financeDomain` и (по мере необходимости) в БД.
  - Обновить README `financeDomain` и `SYSTEM_FEATURES_DOCUMENTATION.md` (1.5) с перечислением режимов.

- [x] **Расширяемость формул под новые типы выплат**
  - В `calculateShiftFinancials` добавлен параметр `paymentMode` (`PaymentMode`), логика расчета гарантии привязана к режиму.
  - Реализован режим `percent_only` (игнорирует гарантию), остальные режимы зарезервированы и документированы.
  - Добавлен базовый тест-кейс для `percent_only` и инвариантные тесты, подтверждающие корректность работы режимов.

---

### 2. Возвраты и корректировки

- [x] **Модель возврата / корректировки суммы**
  - Принято решение **не использовать отрицательные суммы** в `staff_shift_items` (есть CHECK‑ограничения и домен игнорирует отрицательные значения).
  - Модель: исходные продажи живут в `staff_shift_items` (только неотрицательные суммы), возвраты/корректировки описываются отдельными «корректирующими операциями» (будущий тип/таблица, условно `staff_shift_adjustments`) с `service_delta`/`consumables_delta`, `kind` и `reason`.
  - Это зафиксировано в `SYSTEM_FEATURES_DOCUMENTATION.md` (раздел 1.5.6 «Возвраты и корректировки сумм») и в README `financeDomain` (раздел «Возвраты и корректировки (модель)»).

- [x] **Влияние возвратов на расчёт смены**
  - В `financeDomain/items.ts` добавлена функция `applyAdjustmentsToTotals(baseTotalAmount, baseTotalConsumables, adjustments)`, которая суммирует дельты (`serviceDelta`, `consumablesDelta`) и возвращает скорректированные суммы с нижней границей 0.
  - Для расчёта смены предусмотрен паттерн: сначала считаем базовые суммы по `staff_shift_items`, затем применяем корректировки через `applyAdjustmentsToTotals`, и уже скорректированные значения передаём в `calculateShiftFinancials`.
  - Добавлены юнит‑тесты для кейсов: полный возврат, частичный возврат, возврат только услуги, возврат только расходников, несколько корректировок, которые не должны уводить суммы в минус.

---

### 3. Инварианты и тесты

- [x] **Инварианты сумм**
  - Зафиксировать (и покрыть тестами) базовые инварианты для закрытой смены:
    - `master_share >= 0`, `salon_share >= 0`;
    - `master_share + salon_share` соотносится с `total_amount + consumables_amount` (с учётом гарантий и округлений);
    - `salon_share` не уходит в минус даже при большой доплате за выход.
  - Добавить отдельный файл тестов, где каждый инвариант проверяется на наборе сценариев.

- [x] **Граничные кейсы**
  - Собрать единый список edge‑кейсов из документации и кода (длинные смены, нулевая выручка, только расходники, изменение часов, смена ставок задним числом и т.д.).
  - Убедиться, что для каждого кейса есть явный тест в `apps/web/src/__tests__/lib/financeDomain/` и ссылка на этот тест в комментарии/README.

---

### 4. Централизация расчётов в `financeDomain`

- [x] **Убрать дублирующие расчёты из UI/утилит**
  - Проанализирован `apps/web/src/app/staff/finance`:
    - `utils/calculations.ts` помечен как deprecated и просто реэкспортирует функции из `@/lib/financeDomain` (calculateTotalServiceAmount, calculateTotalConsumables, calculateBaseShares, calculateDisplayShares);
    - хук `useShiftCalculations` использует только функции `financeDomain` и не содержит «ручных» формул (проценты, гарантии считаются там же).
  - Дополнительных дублирующих расчётов в UI/утилитах не осталось: фронт опирается на `financeDomain` и занимается только выбором сценария, агрегациями и форматированием.

- [x] **Явное разделение «исторических» и «живых» расчётов**
  - Для закрытых смен источником правды являются сохранённые в БД поля (`staff_shifts.*`), фронт не пересчитывает их заново — это отражено в `SYSTEM_FEATURES_DOCUMENTATION.md` (1.5.5) и README `financeDomain` (раздел «Исторические vs «живые» расчёты»).
  - Для открытых смен суммы считаются динамически по `staff_shift_items` (через `financeDomain.items` + `applyAdjustmentsToTotals`), а финальные доли резолвятся через `calculateShiftFinancials` / `calculateDisplayShares`.

- [ ] **Явное разделение «исторических» и «живых» расчётов**
  - Для закрытых смен — всегда брать сохранённые в БД значения.
  - Для открытых — резолвить через `financeDomain` поверх текущих `staff_shift_items` и времени «сейчас».
  - Задокументировать это как правило и добавить 1–2 теста, проверяющих различие поведения.

---

### 5. Уточнение типов и уменьшение «магии»

- [x] **Сузить `Record<string, unknown>` там, где это возможно**
  - В `financeDomain` сами модули расчёта не используют `Record<string, unknown>`; для связанных частей домена сделаны уточнения типов:
    - в `core-domain/booking/dto.ts` введён тип `PromotionParamsJson` (на основе `PromotionParams`), а `normalizePromotionApplied` теперь опирается на явный `RawPromotionApplied` вместо голого `Record<string, unknown>`;
    - в API `/api/dashboard/staff/[id]/finance/audit-log` тип строки из `finance_settings_audit_log` описан через `AuditRow` вместо `Record<string, unknown>`.
  - Остальные использования `Record<string, unknown>` оставлены там, где нужны по смыслу «произвольные метаданные» (логирование, monitoring, generic payloads) и не относятся к самим финансовым формулам.

- [x] **Проверка и очистка старого/неиспользуемого кода**
  - Просмотрены хелперы в `apps/web/src/app/staff/finance/utils/*.ts` и связанные документы (`DUPLICATION_REFACTORING.md`): расчёты вынесены в `financeDomain`, `utils/calculations.ts` служит только адаптером (re-export) и помечен как deprecated.
  - Дополнительного мёртвого/обходного кода вокруг финансовой логики (отдельные формулы, параллельные расчёты) не осталось, поэтому отдельное удаление не требуется.

---

### 6. Приоритет реализации (предложение)

1. **Инварианты и тесты** (раздел 3) — сразу повысит надёжность и даст «страховку» под дальнейшие изменения.
2. **Централизация расчётов** (раздел 4) — уменьшит расхождения между UI и доменом.
3. **Возвраты и корректировки** (раздел 2) — важный бизнес‑кейс, лучше описать и покрыть заранее.
4. **Режимы оплаты / новые типы выплат** (раздел 1) — как подготовка к будущим схемам.
5. **Уточнение типов и зачистка кода** (раздел 5) — после того как поведение закреплено тестами.

По мере работы над задачами имеет смысл:
- обновлять `SYSTEM_FEATURES_DOCUMENTATION.md` (раздел 1.5) и README `financeDomain`;
- добавлять короткую ссылку на выполненную задачу/PR в этот документ (можно рядом с соответствующим пунктом).

